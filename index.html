<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dani Test Software</title>

<!-- ====== XLSX LIBRARY ====== -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
:root{
  --primary:#0b1c2d;     /* Deep Dark Blue */
  --secondary:#ffffff;  /* White */
  --accent:#1f6feb;
  --border:#d0d7de;
}

/* ===== BODY ===== */
body{
  margin:0;
  font-family:Segoe UI, Arial;
  background:white;
  color:#0b1c2d;
}

/* ===== HEADER ===== */
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:var(--primary);
  color:white;
  padding:14px 22px;
  font-size:22px;
  font-weight:600;
}

#header-left{
  display:flex;
  align-items:center;
  gap:12px;
}

#header-logo{
  height:40px;
  max-height:60px;
  width:auto;
  display:none;
}

#dateTime{
  font-size:14px;
  opacity:0.85;
}

/* ===== NAV ===== */
nav{
  display:flex;
  background:#f6f8fa;
  border-bottom:1px solid var(--border);
}

nav div{
  padding:14px 20px;
  cursor:pointer;
  transition:0.25s;
  border-bottom:3px solid transparent;
  font-weight:500;
}

nav div:hover{
  background:#eef2f7;
}

nav div.active{
  border-bottom:3px solid var(--accent);
  color:var(--accent);
  font-weight:600;
  transform:translateY(-1px);
}

/* ===== SECTION ===== */
section{
  display:none;
  padding:20px;
}

section.active{
  display:block;
  animation:fadeIn 0.25s ease-in;
}

@keyframes fadeIn{
  from{opacity:0; transform:translateY(4px);}
  to{opacity:1; transform:none;}
}

/* ===== CARD ===== */
.card{
  background:white;
  border:1px solid var(--border);
  padding:18px;
  margin-bottom:20px;
  border-radius:10px;
}

/* ===== TABLE ===== */
table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  border:1px solid var(--border);
  padding:8px;
  text-align:center;
}

th{
  background:#f6f8fa;
  font-weight:600;
}
.r-filter{display:flex;gap:10px;margin:15px 0}
.r-table{width:100%;border-collapse:collapse}
.r-table th,.r-table td{border:1px solid #ddd;padding:8px}
.r-table tr:hover{background:#f6f8fb;cursor:pointer}
.profit-pos{color:green;font-weight:600}
.profit-neg{color:red;font-weight:600}

/* ===== INPUT ===== */
input,select{
  padding:7px;
  border-radius:6px;
  border:1px solid var(--border);
  width:100%;
}

button{
  padding:8px 14px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:600;
}

.green{background:#2da44e;color:white;}
.red{background:#cf222e;color:white;}
.blue{background:var(--accent);color:white;}
</style>
</head>
<body>

<header>
  <div id="header-left">
    <img id="header-logo">
    <span id="softwareName">Dani Test Software</span>
  </div>
  <div id="dateTime"></div>
</header>
<!-- ================= TOP MENU ================= -->
<nav id="mainMenu">
  <div id="tab-invoice" class="menuItem" onclick="openTab('invoice')">Invoice</div>
  <div id="tab-products" class="menuItem" onclick="openTab('products')">Products</div>
  <div id="tab-vendors" class="menuItem" onclick="openTab('vendors')">Vendors</div>
  <div id="tab-purchase" class="menuItem" onclick="openTab('purchase')">Purchase</div>
  <div id="tab-return" class="menuItem" onclick="openTab('return')">Return</div>
  <div id="tab-cash" class="menuItem" onclick="openTab('cash')">Cash In Hand</div>
  <div id="tab-reports" class="menuItem" onclick="openTab('reports')">Reports</div>
  <div id="tab-settings" class="menuItem" onclick="openTab('settings')">Settings</div>
</nav>

<style>
/* ================= MAIN MENU (FINAL FIX) ================= */
#mainMenu{
  display:flex;
  align-items:center;
  gap:14px;
  padding:8px 16px;
  background:#fff;
  border-bottom:2px solid #ccc;
  position:sticky;
  top:0;
  z-index:100;
}

#mainMenu .menuItem{
  padding:6px 14px;
  font-weight:600;
  cursor:pointer;
  border-radius:6px;
  user-select:none;
  white-space:nowrap;
}

#mainMenu .menuItem:hover{
  background:#eef2f7;
}

#mainMenu .menuItem.active{
  background:#eef2f7;
  color:var(--primary,#1e1e1e);
}

<script>
/* ================= TAB SWITCHING (CLEAN) ================= */
function openTab(id){
  // Hide all sections
  document.querySelectorAll("section").forEach(s=>{
    s.style.display="none";
  });

  // Permission check
  const user = JSON.parse(sessionStorage.getItem("loggedInUser") || "{}");
  if(user.role!=="developer" && !(user.permissions||[]).includes(id)){
    return;
  }

  // Show section
  const sec = document.getElementById(id);
  if(sec) sec.style.display="block";

  // Active menu highlight
  document.querySelectorAll("#mainMenu .menuItem").forEach(m=>{
    m.classList.remove("active");
  });
  const tab = document.getElementById("tab-"+id);
  if(tab) tab.classList.add("active");
}

/* ================= OPEN FIRST ALLOWED TAB ================= */
document.addEventListener("DOMContentLoaded", ()=>{
  const acc = sessionStorage.getItem("loggedInUser");
  if(!acc) return;

  const user = JSON.parse(acc);
  const order = ["invoice","products","vendors","purchase","cash","reports","settings"];

  for(const t of order){
    if(user.role==="developer" || (user.permissions||[]).includes(t)){
      openTab(t);
      break;
    }
  }
});
</script>

<!-- ================= DATABASE ================= -->
<script>
let DB = {
  products: JSON.parse(localStorage.getItem("products") || "[]"),
  vendors: JSON.parse(localStorage.getItem("vendors") || "[]"),
  purchases: JSON.parse(localStorage.getItem("purchases") || "[]"),
  invoices: JSON.parse(localStorage.getItem("invoices") || "[]"),
  cash: JSON.parse(localStorage.getItem("cash") || "[]"),
  deleted: JSON.parse(localStorage.getItem("deleted") || "[]"),
  settings: JSON.parse(localStorage.getItem("settings") || "{}"),
  accounts: JSON.parse(localStorage.getItem("accounts") || "[]")  // Added accounts
};

// Initialize default developer account if not exists
if(!DB.accounts.find(x=>x.fixed)) {
  DB.accounts.push({id: uid("A"), username:"Dani", password:"7525", role:"developer", fixed:true, permissions:[]});
  saveDB();
}

function saveDB() { 
  for(let k in DB){ 
    localStorage.setItem(k, JSON.stringify(DB[k])); 
  } 
}

function uid(prefix){ 
  return prefix + "_" + Date.now() + Math.floor(Math.random()*1000); 
}
</script>
<script>
/* ================= RULE ENGINE ================= */
const RULES = {
  qtyIntegerOnly: true,
  noDuplicateInvoiceProduct: true,
  noDuplicatePurchaseProduct: true,
  uniqueItemNo: true,
  uniqueBarcode: true,
  uniqueVendorName: true,
  auditLog: true
};

/* ===== GLOBAL MESSAGE (CENTER SCREEN) ===== */
function ruleMessage(msg){
  let box = document.getElementById("ruleMsgBox");
  if(!box){
    box = document.createElement("div");
    box.id = "ruleMsgBox";
    box.style = `
      position:fixed; top:50%; left:50%;
      transform:translate(-50%,-50%);
      background:#111; color:#fff;
      padding:18px 26px;
      border-radius:10px;
      font-size:16px;
      z-index:99999;
      box-shadow:0 0 20px rgba(0,0,0,.4)
    `;
    document.body.appendChild(box);
  }
  box.innerText = msg;
  box.style.display="block";
  setTimeout(()=>box.style.display="none",2500);
}

/* ===== AUDIT LOG ===== */
function logAction(action, ref=""){
  if(!RULES.auditLog) return;
  const user = JSON.parse(sessionStorage.getItem("loggedInUser")||"{}");
  DB.logs = DB.logs || [];
  DB.logs.push({
    user: user.username || "unknown",
    role: user.role || "",
    action,
    ref,
    dateTime: new Date().toISOString()
  });
  saveDB();
}
</script>
<!-- ================= INVOICE ================= -->
<section id="invoice">
  <div class="card" id="newInvoiceCard">
    <h2>New Invoice</h2>

    <!-- ===== ADD PRODUCT ROW ===== -->
    <table style="width:100%; margin-bottom:10px;">
      <thead>
        <tr>
          <th style="width:12%">Barcode</th>
          <th style="width:12%">Item No</th>
          <th style="width:34%">Description</th>
          <th style="width:8%">Qty</th>
          <th style="width:12%">Rate (PKR)</th>
          <th style="width:12%">Total (PKR)</th>
          <th style="width:10%">Delete</th>
        </tr>
      </thead>
      <tbody id="invoiceRows"></tbody>
    </table>
    <button class="green" onclick="addInvoiceRow()">+ Add Item</button>

    <!-- ===== MAIN DISCOUNT & TOTAL ===== -->
<div style="margin-top:10px; display:flex; gap:15px; flex-wrap:wrap; align-items:center; justify-content:center; border:1px solid #000; padding:10px;">
  <div>
    <label>Main Discount Amount:</label>
    <input type="number" id="mainDiscAmt" value="0"
      oninput="applyMainDiscount(getSubTotal());syncDiscFromAmt();">
  </div>
  <div>
    <label>Main Discount %:</label>
    <input type="number" id="mainDiscPct" value="0"
      oninput="applyMainDiscount(getSubTotal());syncDiscFromPct();">
  </div>
  <div style="padding:10px; font-weight:bold; text-align:center; border-left:2px solid #000;">
    <label><b>Total:</b></label><br>
    <span style="font-size:22px;"><b id="invTotal">0</b> PKR</span>
  </div>
</div>

    <!-- ===== SAVE INVOICE ===== -->
    <div style="margin-top:10px;">
      <button class="blue" onclick="saveInvoice()">Save Invoice</button>
    </div>
  </div>

  <!-- ===== INVOICE LIST ===== -->
  <div class="card" style="margin-top:20px;">
    <h2>Previous Invoices</h2>

    <!-- Filter -->
    <div style="margin-bottom:10px;">
      <label>From:</label><input type="date" id="invFrom">
      <label>To:</label><input type="date" id="invTo">
      <button onclick="applyInvoiceFilter()">Apply</button>
    </div>

    <table style="width:100%;">
      <thead>
        <tr>
          <th>#</th>
          <th>Invoice No</th>
          <th>Date</th>
          <th>Time</th>
          <th>Total (PKR)</th>
          <th>Print</th>
          <th>Edit</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody id="invoiceList"></tbody>
    </table>

    <!-- Pagination -->
    <div style="margin-top:10px; display:flex; gap:10px;">
      <button onclick="prevInvPage()">Prev</button>
      <button onclick="nextInvPage()">Next</button>
    </div>
  </div>
</section>

<script>
/* ================= INVOICE LOGIC ================= */
let invoiceDraft = [];
let editingInvoiceId = null;
let invPage = 1, invPerPage = 100;
let invFiltered = null;

/* ===== FORMAT NUMBER WITH COMMAS ===== */
function formatNumber(x){
  return Number(x).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
}

/* ===== SEQUENTIAL INVOICE NUMBER ===== */
function getNextInvoiceNumber(){
  if(!DB.invoices || !DB.invoices.length) return "INV000001";
  const nums = DB.invoices.map(inv=>parseInt(inv.id.replace("INV",""),10)||0);
  return "INV" + String(Math.max(...nums)+1).padStart(6,'0');
}

/* ===== ADD ROW ===== */
function addInvoiceRow(){
  invoiceDraft.push({
    productId:null,
    barcode:"",
    itemNo:"",
    desc:"",
    qty:1,
    rate:0,
    valid:false
  });
  renderInvoice();
}
/* ===== RENDER INVOICE ROWS ===== */
function renderInvoice(){
  const tbody = document.getElementById("invoiceRows");
  if(!tbody) return;
  tbody.innerHTML="";
  let subtotal=0;

  invoiceDraft.forEach((r,i)=>{
    if(r.valid) subtotal += r.qty*r.rate;
    tbody.innerHTML += `
      <tr>
        <td style="position:relative;">
          <input value="${r.barcode}" placeholder="Barcode" oninput="searchInvProduct(${i}, this.value,'barcode')">
          <div id="invSugB${i}" class="invSug"></div>
        </td>
        <td style="position:relative;">
          <input value="${r.itemNo}" placeholder="Item No" oninput="searchInvProduct(${i}, this.value,'itemNo')">
          <div id="invSugI${i}" class="invSug"></div>
        </td>
        <td style="position:relative;">
          <input value="${r.desc}" placeholder="Description" oninput="searchInvProduct(${i}, this.value,'desc')">
          <div id="invSugD${i}" class="invSug"></div>
        </td>
        <td><input type="number" min="1" value="${r.qty}" onchange="setInvQty(${i},this.value)"></td>
        <td><input type="number" value="${r.rate}" onchange="setInvRate(${i},this.value)"></td>
        <td>${r.valid ? formatNumber(r.qty*r.rate) : "<span style='color:red'>Invalid</span>"}</td>
        <td><button class="red" onclick="delInvRow(${i})">X</button></td>
      </tr>`;
  });

  applyMainDiscount(subtotal);
}

/* ===== SEARCH DROPDOWN ===== */
function searchInvProduct(i,val,field){
  const q=val.trim().toLowerCase();
  const row=invoiceDraft[i]; row.valid=false;
  const box=document.getElementById(field==="barcode"?"invSugB"+i:field==="itemNo"?"invSugI"+i:"invSugD"+i);
  box.innerHTML=""; if(!q) return;

  const results=DB.products.filter(p=>((field==="barcode"&&(p.barcode||"").toLowerCase().includes(q))||(field==="itemNo"&&(p.itemNo||"").toLowerCase().includes(q))||(field==="desc"&&(p.desc||"").toLowerCase().includes(q))));
  if(!results.length){ box.innerHTML=`<div style="padding:4px;color:red">Product not exist or no stock</div>`; return; }

   results.forEach(p=>{
  const stockNote = p.stock <= 0 ? " ❌ NO STOCK" : "";
  const d = document.createElement("div");
  d.style.padding = "4px";
  d.style.cursor = "pointer";
  d.innerText = `${p.itemNo} - ${p.desc} (Stock: ${p.stock})${stockNote}`;

  d.onclick = () => {
    if (invoiceDraft.some((x, idx) => idx !== i && x.productId === p.id)) {
      ruleMessage("This product already exists in invoice");
      return;
    }

    invoiceDraft[i] = {
      productId: p.id,
      barcode: p.barcode || "",
      itemNo: p.itemNo,
      desc: p.desc,
      qty: 1,
      rate: p.rate,
      valid: true
    };

    renderInvoice();
  };

  box.appendChild(d);
});
}
/* ===== SETTERS ===== */
function setInvQty(i,v){
  if(v.includes(".")){
    ruleMessage("Decimal quantity not allowed");
    return;
  }
  invoiceDraft[i].qty = parseInt(v) || 1;
  renderInvoice();
}

function setInvRate(i,v){ invoiceDraft[i].rate=+v; renderInvoice(); }
function delInvRow(i){ invoiceDraft.splice(i,1); renderInvoice(); }

/* ===== TOTAL / DISCOUNT ===== */
function getSubTotal(){ return invoiceDraft.reduce((s,r)=>r.valid?s+(r.qty*r.rate):s,0); }
function applyMainDiscount(sub){
  let amt=+document.getElementById("mainDiscAmt")?.value||0;
  const pct=+document.getElementById("mainDiscPct")?.value||0;
  if(pct>0) amt=sub*pct/100;
  document.getElementById("invTotal").innerText=formatNumber(sub-amt);
}

/* ===== SAVE INVOICE ===== */
function saveInvoice(){
  if(!invoiceDraft.length) return alert("Invoice empty");
  if(invoiceDraft.some(r=>!r.valid)) return alert("Invoice contains invalid product. Select from list only.");

  const id=editingInvoiceId||getNextInvoiceNumber();
  const dt=new Date(); const dateTime=dt.toISOString();
  const total=+document.getElementById("invTotal").innerText.replace(/,/g,'');

  // Check stock
  for(const r of invoiceDraft){ const p=DB.products.find(x=>x.id===r.productId); if(!p){alert("Product missing: "+r.desc); return;} if(p.stock<r.qty){alert("Insufficient stock for: "+r.desc); return;} }

  // Deduct stock
  invoiceDraft.forEach(r=>{ const p=DB.products.find(x=>x.id===r.productId); if(p) p.stock-=r.qty; });

  // Save invoice
  DB.invoices=DB.invoices.filter(i=>i.id!==id);
  DB.invoices.push({id,dateTime,total,items:JSON.parse(JSON.stringify(invoiceDraft)), discountAmt:+document.getElementById("mainDiscAmt").value, discountPct:+document.getElementById("mainDiscPct").value});
  DB.cash.push({id:uid("C"),type:"IN",amount:total,ref:id,date:dateTime});

  saveDB(); invoiceDraft=[]; editingInvoiceId=null;
  document.getElementById("mainDiscAmt").value=document.getElementById("mainDiscPct").value=0;

  renderInvoice(); renderInvoiceList(); renderCash();
  alert("Invoice saved successfully");
}

/* ===== RENDER PREVIOUS INVOICES ===== */
function renderInvoiceList(){
  const tbody=document.getElementById("invoiceList"); if(!tbody) return;
  tbody.innerHTML="";
  const invoices=(invFiltered||DB.invoices).slice((invPage-1)*invPerPage,invPage*invPerPage);

  invoices.forEach((i,idx)=>{
    const dt=new Date(i.dateTime);
    tbody.innerHTML+=`<tr>
      <td>${(invPage-1)*invPerPage+idx+1}</td>
      <td>${i.id}</td>
      <td>${dt.toLocaleDateString(undefined,{weekday:'long', year:'numeric', month:'short', day:'numeric'})}</td>
      <td>${dt.toLocaleTimeString()}</td>
      <td>${formatNumber(i.total)}</td>
      <td><button onclick="printInvoice('${i.id}')">Print</button></td>
      <td><button onclick="editInvoice('${i.id}')">Edit</button></td>
      <td><button class="red" onclick="deleteInvoice('${i.id}')">Delete</button></td>
    </tr>`;
  });
}

/* ===== FILTER / PAGINATION ===== */
function applyInvoiceFilter(){ const from=document.getElementById("invFrom").value; const to=document.getElementById("invTo").value;
  invFiltered=DB.invoices.filter(i=>{
    const dt=new Date(i.dateTime); const f=from?new Date(from):null; const t=to?new Date(to):null;
    if(f&&dt<f) return false; if(t&&dt>t) return false; return true;
  }); invPage=1; renderInvoiceList();
}
function nextInvPage(){ invPage++; renderInvoiceList(); }
function prevInvPage(){ if(invPage>1){ invPage--; renderInvoiceList();} }

/* ===== EDIT / DELETE ===== */
function editInvoice(id){ const inv=DB.invoices.find(x=>x.id===id); if(!inv) return; editingInvoiceId=id; invoiceDraft=JSON.parse(JSON.stringify(inv.items)); renderInvoice();}
function deleteInvoice(id){
  if(!confirm("Delete invoice?")) return;
  const inv=DB.invoices.find(x=>x.id===id);
  if(!DB.deletedInvoices) DB.deletedInvoices=[];
  DB.deletedInvoices.push({
    id:inv.id, dateTime:new Date().toISOString(), items:inv.items,
    total:inv.total, discountAmt:inv.discountAmt, discountPct:inv.discountPct, who:"current_user"
  });
  inv.items.forEach(r=>{ const p=DB.products.find(x=>x.id===r.productId); if(p) p.stock+=r.qty; });
  DB.cash=DB.cash.filter(c=>c.ref!==id);
  DB.invoices=DB.invoices.filter(i=>i.id!==id);
  saveDB(); renderInvoiceList();
}

/* ===== PRINT INVOICE PROFESSIONAL ===== */
function printInvoice(id){
  const inv=DB.invoices.find(x=>x.id===id); if(!inv) return alert("Invoice not found");
  const subtotal=inv.items.reduce((s,r)=>s+r.qty*r.rate,0);
  const discountTotal=inv.discountPct>0 ? subtotal*inv.discountPct/100 : inv.discountAmt;
  const dt=new Date(inv.dateTime);
  const weekday=dt.toLocaleDateString(undefined,{weekday:'long'});
  const dateStr=`${weekday}, ${dt.toLocaleDateString()}`;
  const timeStr=dt.toLocaleTimeString();
  let logoTag=""; if(DB.settings&&DB.settings.logo){logoTag=`<img src="${DB.settings.logo}" style="max-width:100px;height:auto;">`;}
  let rowsHtml=""; inv.items.forEach((r,i)=>{ rowsHtml+=`<tr><td>${i+1}</td><td>${r.itemNo}</td><td>${r.desc}</td><td>${r.qty}</td><td>PKR ${formatNumber(r.rate)}</td><td>PKR ${formatNumber(r.qty*r.rate)}</td></tr>`;});
  const companyInfo=DB.settings?.company||"";
  const html=`<html><head><title>Invoice ${inv.id}</title><style>
    body{font-family:Arial;padding:10px;box-sizing:border-box;} 
    .header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;} 
    .header-left div{
  margin-bottom:4px;
  padding:0;
  border:none;
  font-weight:500;
}
 
    .logo{text-align:right;} h2{text-align:center;margin:5px 0;} 
    table{width:100%;border-collapse:collapse;margin-top:5px;font-size:12px;} 
    th,td{border:1px solid #000;padding:4px;text-align:left;} 
    th{background:#eee;font-weight:600;} 
    .subtotal,.discount,.totals{padding:4px;margin-top:2px;font-weight:500;} 
    .totals{font-weight:600;} 
    @media print{body{width:100%;} table,.totals,.subtotal,.discount{page-break-inside:avoid;}}</style></head>
    <body><div class="header-left">
  <div style="font-size:20px;font-weight:bold;">Cash Customer</div>
  <div><b>Invoice No:</b> ${inv.id}</div>
  <div><b>Invoice Date:</b> ${dateStr}</div>
  <div><b>Time:</b> ${timeStr}</div>
</div>
</div><div class="logo">${logoTag}</div></div>
    <table><thead><tr><th>#</th><th>Item No</th><th>Description</th><th>Qty</th><th>Rate (PKR)</th><th>Total (PKR)</th></tr></thead><tbody>${rowsHtml}</tbody></table>
    <div class="subtotal">Subtotal: PKR ${formatNumber(subtotal)}</div>
    <div class="discount">Discount: PKR ${formatNumber(discountTotal)} (${inv.discountPct}%)</div>
    <div class="totals">Total: PKR ${formatNumber(inv.total)}</div>
    <div style="margin-top:20px;"><p>${companyInfo}</p></div></body></html>`;

  const printWindow=window.open('','_blank'); printWindow.document.write(html); printWindow.document.close(); printWindow.print();
}

/* ===== INITIAL RENDER ===== */
if(invoiceDraft.length === 0){
  addInvoiceRow();
}
renderInvoiceList();

function syncDiscFromAmt(){
  const sub=getSubTotal();
  const amt=+document.getElementById("mainDiscAmt").value||0;
  if(sub>0) document.getElementById("mainDiscPct").value=((amt/sub)*100).toFixed(2);
}

function syncDiscFromPct(){
  const sub=getSubTotal();
  const pct=+document.getElementById("mainDiscPct").value||0;
  if(sub>0) document.getElementById("mainDiscAmt").value=((sub*pct)/100).toFixed(2);
}

</script>

<style>
.invSug{
  position:absolute;
  background:#fff;
  border:1px solid #ccc;
  max-height:160px;
  overflow:auto;
  z-index:999;
  width:100%;
}

.invSug div{
  padding:6px;
}

.invSug div:hover{
  background:#eee;
}

#invoiceRows tr{
  height:auto;
}

#invoiceRows input{
  width:100%;
  box-sizing:border-box;
}

</style>

<!-- ================= CASH ================= -->
<section id="cash">

  <!-- ===== STICKY BALANCE BAR ===== -->
  <div style="position:sticky; top:0; z-index:10; background:#fff; padding:10px; border-bottom:2px solid #ddd;">
    <h2>Cash In Hand</h2>
    <h3>Balance: <span id="cashBal">0</span></h3>
  </div>

  <div class="card">

    <!-- ===== ADD NEW PAYMENT ===== -->
    <h3>Add / Edit Payment</h3>
    <hr>
    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:15px;">
      <input type="date" id="payDate" style="flex:1 1 150px;">
      <select id="payVendor" style="flex:1 1 150px;">
        <option value="">Select Vendor</option>
      </select>
      <input placeholder="Reference" id="payRef" style="flex:1 1 150px;">
      <input type="number" placeholder="Amount" id="payAmount" style="flex:1 1 120px;">
      <button class="red" onclick="saveCashPayment()">Save</button>
    </div>

    <!-- ===== FILTER ===== -->
    <h3>Filter Payments</h3>
    <hr>
    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:5px;">
      <label>From</label><input type="date" id="cashFrom">
      <button onclick="applyCashFrom()">Apply</button>
      <label>To</label><input type="date" id="cashTo">
      <button onclick="applyCashTo()">Apply</button>
      <select id="cashVendorFilter">
        <option value="">All Vendors</option>
      </select>
      <button onclick="applyCashVendor()">Apply</button>
      <input placeholder="Search Vendor / Amount / Ref" id="cashSearch" style="flex:1">
      <button onclick="applyCashSearch()">Apply</button>
      <button onclick="downloadCashCSV()">Download CSV</button>
    </div>

    <!-- ===== CASH TABLE ===== -->
    <table style="margin-top:10px; width:100%;">
      <thead>
        <tr>
          <th>Date</th>
          <th>Time</th>
          <th>Type</th>
          <th>Vendor</th>
          <th>Amount</th>
          <th>Reference</th>
          <th>Balance</th>
          <th>Edit</th>
          <th>Delete</th>
          <th>Created Date</th>
        </tr>
      </thead>
      <tbody id="cashRows"></tbody>
    </table>

    <!-- ===== PAGINATION ===== -->
    <div style="margin-top:10px; display:flex; gap:10px;">
      <button onclick="prevCashPage()">Prev</button>
      <button onclick="nextCashPage()">Next</button>
    </div>
  </div>
</section>

<script>
let cashPage = 1, cashPerPage = 100;
let cashFiltered = null;
let editingCashId = null;

/* ===== FORMAT NUMBER WITH COMMAS ===== */
function formatNumber(x){ return Number(x).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }

/* ===== PAYMENT ID SEQUENTIAL ===== */
function getNextPaymentId(){
  if(!DB.cash || !DB.cash.length) return "P-000001";
  const nums = DB.cash.map(p=>{
    const n = parseInt(p.id.replace("P-",""),10);
    return isNaN(n)?0:n;
  });
  const next = Math.max(...nums)+1;
  return "P-"+String(next).padStart(6,"0");
}

/* ===== POPULATE VENDOR SELECT ===== */
function loadVendorOptions(){
  const selectAdd = document.getElementById("payVendor");
  const selectFilter = document.getElementById("cashVendorFilter");
  selectAdd.innerHTML='<option value="">Select Vendor</option>';
  selectFilter.innerHTML='<option value="">All Vendors</option>';
  DB.vendors.forEach(v=>{
    selectAdd.innerHTML+=`<option value="${v.name}">${v.name}</option>`;
    selectFilter.innerHTML+=`<option value="${v.name}">${v.name}</option>`;
  });
}

/* ===== CASH BALANCE ===== */
function cashBalance(){
  return DB.cash.reduce((s,t)=>t.type==="IN"?s+t.amount:s-t.amount,0);
}

/* ===== SAVE PAYMENT (ADD / EDIT) ===== */
function saveCashPayment(){
  const date = document.getElementById("payDate").value;
  const vendor = document.getElementById("payVendor").value.trim();
  const ref = document.getElementById("payRef").value.trim();
  const amount = +document.getElementById("payAmount").value;

  if(!date || !amount) return alert("Date and Amount required");

  let dtISO = new Date(date).toISOString();

  if(editingCashId){
    // EDIT EXISTING PAYMENT
    const c = DB.cash.find(x=>x.id===editingCashId);
    if(!c) return alert("Payment not found");
  // ❌ REMOVE THAT DB.cash.push() COMPLETELY
// Editing means update existing record, NOT push new



    // Adjust vendor balance
    if(c.vendor){
      const v = DB.vendors.find(x=>x.name===c.vendor);
      if(v) v.balance = (v.balance || 0) + c.amount; // revert old amount
    }

    c.dateTime = dtISO;
    c.vendor = vendor || "";
    c.ref = ref || vendor || "";
    c.amount = amount;

    if(vendor){
      const v = DB.vendors.find(x=>x.name===vendor);
      if(v) v.balance = (v.balance || 0) - amount; // apply new
    }

    editingCashId = null;
  } else {
    // ADD NEW PAYMENT
    const id = getNextPaymentId();
    if(vendor){
      const v = DB.vendors.find(x=>x.name===vendor);
      if(v) v.balance = (v.balance || 0) - amount;
    }

    DB.cash.push({
      id,
      dateTime: dtISO,
      type:"OUT",
      vendor: vendor || "",
      ref: ref || vendor || "",
      amount
    });
  }

  saveDB(); resetCashForm(); renderCash();
}

function resetCashForm(){
  document.getElementById("payDate").value="";
  document.getElementById("payVendor").value="";
  document.getElementById("payRef").value="";
  document.getElementById("payAmount").value="";
  editingCashId = null;
}

/* ===== APPLY FILTERS ===== */
function applyCashFrom(){ renderCash(); }
function applyCashTo(){ renderCash(); }
function applyCashVendor(){ renderCash(); }
function applyCashSearch(){ renderCash(); }

/* ===== RENDER CASH ===== */
function renderCash(){
  loadVendorOptions();
  const tbody = document.getElementById("cashRows");
  tbody.innerHTML="";

  // Sort newest → oldest by createdDate
  let filtered = [...DB.cash].sort((a,b)=>{
    const da = new Date(a.createdDate || a.dateTime);
    const db = new Date(b.createdDate || b.dateTime);
    return db - da; // newest first
  });

  // Filters
  const from = document.getElementById("cashFrom").value;
  if(from) filtered = filtered.filter(c=>new Date(c.dateTime)>=new Date(from));

  const to = document.getElementById("cashTo").value;
  if(to) filtered = filtered.filter(c=>new Date(c.dateTime)<=new Date(to));

  const vendorFilter = document.getElementById("cashVendorFilter").value.trim();
  if(vendorFilter) filtered = filtered.filter(c=>c.vendor===vendorFilter);

  const searchText = document.getElementById("cashSearch").value.trim().toLowerCase();
  if(searchText) filtered = filtered.filter(c=> 
    (c.vendor||"").toLowerCase().includes(searchText) ||
    (c.ref||"").toLowerCase().includes(searchText) ||
    (c.amount+"").includes(searchText)
  );

  cashFiltered = filtered;

  // Compute running balance per row
  let runningBal = 0;
  let displayRows = filtered.slice((cashPage-1)*cashPerPage, cashPage*cashPerPage);

  displayRows.forEach(c=>{
    if(c.type==="IN") runningBal += c.amount;
    else runningBal -= c.amount;

    const dt = new Date(c.dateTime);
    const created = new Date(c.createdDate || c.dateTime).toLocaleString();
    const vendorName = c.vendor || (c.type==="IN"?"Cash Customer":"");
    tbody.innerHTML+=`
      <tr>
        <td>${dt.toLocaleDateString()}</td>
        <td>${dt.toLocaleTimeString()}</td>
        <td>${c.type}</td>
        <td>${vendorName}</td>
        <td>${formatNumber(c.amount)}</td>
        <td>${c.ref || ""}</td>
        <td>${formatNumber(runningBal)}</td>
        <td>${c.type==="OUT"?`<button onclick="editCashPayment('${c.id}')">Edit</button>`:""}</td>
        <td>${c.type==="OUT"?`<button onclick="deleteCashPayment('${c.id}')">Delete</button>`:""}</td>
        <td>${created}</td> <!-- NEW COLUMN -->
      </tr>
    `;
  });

  document.getElementById("cashBal").innerText = formatNumber(cashBalance());
}

/* ===== PAGINATION ===== */
function nextCashPage(){ if(cashFiltered && cashPage*cashPerPage<cashFiltered.length) cashPage++; renderCash(); }
function prevCashPage(){ if(cashPage>1){ cashPage--; renderCash(); } }

/* ===== EDIT / DELETE ===== */
function editCashPayment(id){
  const c = DB.cash.find(x=>x.id===id && x.type==="OUT");
  if(!c) return alert("Only vendor payments can be edited.");
  editingCashId = id;
  const dt = new Date(c.dateTime);
  document.getElementById("payDate").value = dt.toISOString().slice(0,10);
  document.getElementById("payVendor").value = c.vendor;
  document.getElementById("payRef").value = c.ref;
  document.getElementById("payAmount").value = c.amount;
}

function deleteCashPayment(id){
  const c = DB.cash.find(x=>x.id===id && x.type==="OUT");
  if(!c) return alert("Only vendor payments can be deleted.");
  if(!confirm("Delete this payment?")) return;

  if(!DB.deletedPayments) DB.deletedPayments=[];
  DB.deletedPayments.push({id:c.id,dateTime:new Date().toISOString(),original:c});

  if(c.vendor){
    const v = DB.vendors.find(x=>x.name===c.vendor);
    if(v) v.balance = (v.balance || 0) + c.amount;
  }

  DB.cash = DB.cash.filter(x=>x.id!==id);
  saveDB(); renderCash();
}

/* ===== DOWNLOAD CSV ===== */
function downloadCashCSV(){
  const rows=[["Date","Time","Type","Vendor","Amount","Reference","Balance"]];
  let runningBal=0;
  DB.cash.sort((a,b)=>new Date(a.dateTime)-new Date(b.dateTime)).forEach(c=>{
    if(c.type==="IN") runningBal+=c.amount; else runningBal-=c.amount;
    const dt = new Date(c.dateTime);
    const vendorName = c.vendor || (c.type==="IN"?"Cash Customer":"");
    rows.push([dt.toLocaleDateString(),dt.toLocaleTimeString(),c.type,vendorName,c.amount,c.ref||"",runningBal]);
  });
  const csvContent = "data:text/csv;charset=utf-8," + rows.map(r=>r.join(",")).join("\n");
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a"); link.setAttribute("href", encodedUri);
  link.setAttribute("download","cash.csv");
  document.body.appendChild(link); link.click(); document.body.removeChild(link);
}

/* ===== INITIAL LOAD ===== */
loadVendorOptions(); renderCash();
</script>

<!-- ================= PRODUCTS ================= -->
<section id="products">
  <div class="card">
    <h2>Products</h2>

    <!-- ===== FILE ACTIONS ===== -->
    <h3>Import / Export</h3>
    <hr>
    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:15px;">
      <input type="file" accept=".xlsx,.xls" onchange="uploadProductExcel(this)">
      <button class="blue" onclick="exportProductsCSV()">Download CSV</button>
    </div>

    <!-- ===== ADD PRODUCT ===== -->
    <h3>Add New Product</h3>
    <hr>
    <div style="margin-bottom:10px;">
      <button class="green" onclick="showAddProductForm()">+ Add New Product</button>
    </div>

    <div id="newProductForm" style="display:none; gap:10px; flex-wrap:wrap; margin-bottom:20px;">
      <input placeholder="Barcode" id="newProdBarcode" style="flex:1 1 150px;">
      <input placeholder="Item No" id="newProdItemNo" style="flex:1 1 150px;">
      <input placeholder="Description" id="newProdDesc" style="flex:2 1 200px;">
      <input type="number" placeholder="Rate" id="newProdRate" style="flex:1 1 100px;">
      <button class="green" onclick="addNewProduct()">Save</button>
      <button class="red" onclick="hideAddProductForm()">Cancel</button>
    </div>

    <!-- ===== SEARCH ===== -->
    <h3>Search Products</h3>
    <hr>
    <input
      id="productSearch"
      placeholder="Search by Barcode / Item No / Description"
      oninput="advancedProductSearch()"
      style="width:100%; padding:8px; margin-bottom:15px;"
    >
  </div>

  <!-- ===== PRODUCTS TABLE ===== -->
  <div class="card">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Barcode</th>
          <th>Item No</th>
          <th>Description</th>
          <th>Rate</th>
          <th>Stock</th>
          <th>Edit</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody id="productRows"></tbody>
    </table>

    <!-- Pagination -->
    <div style="margin-top:10px; display:flex; gap:10px;">
      <button onclick="prevProdPage()">Prev</button>
      <button onclick="nextProdPage()">Next</button>
    </div>
  </div>
</section>

<script>
let prodPage = 1;
let prodPerPage = 100;
let prodFiltered = [];

/* ===== SHOW / HIDE FORM ===== */
function showAddProductForm(){
  document.getElementById("newProductForm").style.display="flex";
}
function hideAddProductForm(){
  document.getElementById("newProductForm").style.display="none";
}

/* ===== RENDER ===== */
function renderProducts(){
  const tbody = document.getElementById("productRows");
  tbody.innerHTML = "";

  const start = (prodPage - 1) * prodPerPage;
  const page = prodFiltered.slice(start, start + prodPerPage);

  page.forEach((p, i) => {
    tbody.innerHTML += `
      <tr>
        <td>${start + i + 1}</td>
        <td>${p.barcode || ""}</td>
        <td>${p.itemNo}</td>
        <td>${p.desc}</td>
        <td>${p.rate}</td>
        <td>${p.stock || 0}</td>
        <td><button class="blue" onclick="editProduct('${p.id}')">Edit</button></td>
        <td><button class="red" onclick="deleteProduct('${p.id}')">Delete</button></td>
      </tr>
    `;
  });
}

/* ===== ADVANCED REALTIME SEARCH (ALL DATA) ===== */
function advancedProductSearch(){
  const q = document.getElementById("productSearch").value.trim().toLowerCase();

  prodFiltered = DB.products.filter(p => {
    const barcode = (p.barcode ?? "").toString().toLowerCase();
    const itemNo  = (p.itemNo  ?? "").toString().toLowerCase();
    const desc    = (p.desc    ?? "").toString().toLowerCase();

    return (
      barcode.includes(q) ||
      itemNo.includes(q) ||
      desc.includes(q)
    );
  });

  prodPage = 1;
  renderProducts();
}

/* ===== ADD ===== */
function addNewProduct(){
  const barcode = newProdBarcode.value.trim();
  const itemNo = newProdItemNo.value.trim();
  const desc = newProdDesc.value.trim();
  const rate = +newProdRate.value;

  if(DB.products.some(p=>p.itemNo===itemNo)){
    ruleMessage("This Item No is Present");
    return;
  }

  if(barcode && DB.products.some(p=>p.barcode===barcode)){
    ruleMessage("This Barcode is Present");
    return;
  }

  DB.products.push({
    id: uid("P"),
    barcode,
    itemNo,
    desc,
    rate,
    stock:0
  });

  logAction("Product Created", itemNo);
  saveDB();
  prodFiltered = DB.products;
  renderProducts();
  hideAddProductForm();
}
function addNewProduct(){
  const barcode = newProdBarcode.value.trim();
  const itemNo = newProdItemNo.value.trim();
  const desc = newProdDesc.value.trim();
  const rate = +newProdRate.value;

  if(!itemNo || !desc) return alert("Item No & Description required");

  if(DB.products.some(p=>p.itemNo===itemNo)){
    ruleMessage("This Item No is Present");
    return;
  }

  if(barcode && DB.products.some(p=>p.barcode===barcode)){
    ruleMessage("This Barcode is Present");
    return;
  }

  DB.products.push({
    id: uid("P"),
    barcode,
    itemNo,
    desc,
    rate,
    stock:0
  });

  saveDB();
  prodFiltered = DB.products;
  renderProducts();

  newProdBarcode.value="";
  newProdItemNo.value="";
  newProdDesc.value="";
  newProdRate.value="";
  hideAddProductForm();
}

/* ===== EDIT ===== */
function editProduct(id){
  const p = DB.products.find(x=>x.id===id);
  if(!p) return;

  const barcode = prompt("Barcode", p.barcode);
  const itemNo = prompt("Item No", p.itemNo);
  const desc = prompt("Description", p.desc);
  const rate = prompt("Rate", p.rate);

  if(itemNo && desc && rate){
    p.barcode = barcode || "";
    p.itemNo = itemNo;
    p.desc = desc;
    p.rate = +rate;
    saveDB();
    renderProducts();
  }
}

/* ===== DELETE ===== */
function deleteProduct(id){
  const p = DB.products.find(x=>x.id===id);
  if(!p) return;
  if(p.stock !== 0) return alert("Stock exists");

  if(confirm("Delete product?")){
    DB.products = DB.products.filter(x=>x.id!==id);
    saveDB();
    prodFiltered = DB.products;
    renderProducts();
  }
}

/* ===== PAGINATION ===== */
function nextProdPage(){
  if(prodPage * prodPerPage < prodFiltered.length){
    prodPage++;
    renderProducts();
  }
}
function prevProdPage(){
  if(prodPage > 1){
    prodPage--;
    renderProducts();
  }
}

/* ===== UPLOAD EXCEL ===== */
function uploadProductExcel(input){
  const reader = new FileReader();
  reader.onload = e => {
    const wb = XLSX.read(e.target.result, {type:"binary"});
    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    rows.forEach(r=>{
  const itemNo = r["Item No"] || "";
  const barcode = r.Barcode || "";

  if(DB.products.some(p=>p.itemNo===itemNo)){
    return;
  }

  if(barcode && DB.products.some(p=>p.barcode===barcode)){
    ruleMessage(`${itemNo} - ${barcode} is Present`);
    return;
  }

  DB.products.push({
    id: uid("P"),
    barcode,
    itemNo,
    desc: r.Description || "",
    rate: +r["Retail Rate"] || 0,
    stock:0
  });
});

    saveDB();
    prodFiltered = DB.products;
    renderProducts();
    alert("Products imported");
  };
  reader.readAsBinaryString(input.files[0]);
}

/* ===== EXPORT CSV ===== */
function exportProductsCSV(){
  let csv = "Barcode,Item No,Description,Rate,Stock\n";
  DB.products.forEach(p=>{
    csv += `"${p.barcode}","${p.itemNo}","${p.desc}",${p.rate},${p.stock}\n`;
  });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv], {type:"text/csv"}));
  a.download = "products.csv";
  a.click();
}

/* ===== INIT ===== */
prodFiltered = DB.products;
renderProducts();
</script>
<!-- ================= VENDORS ================= -->
<section id="vendors">
  <div class="card">
    <h2>Vendors</h2>

    <div style="display:flex;gap:10px;margin-bottom:12px;">
      <input id="vendorName" placeholder="Vendor Name" style="flex:1">
      <button onclick="addVendor()">Add Vendor</button>
    </div>

    <table style="width:100%;border-collapse:collapse;">
      <thead>
        <tr>
          <th>#</th>
          <th>Vendor No</th>
          <th>Name</th>
          <th>Balance</th>
          <th>Ledger</th>
        </tr>
      </thead>
      <tbody id="vendorRows"></tbody>
    </table>
  </div>
</section>

<script>
/* ================= HELPERS ================= */
function money(v){
  return Number(v||0).toLocaleString("en-PK",{minimumFractionDigits:2});
}

// Vendor No VEN1001, VEN1002 ...
function nextVendorNo(){
  if(!DB.vendors.length) return "VEN1001";
  const nums = DB.vendors
    .map(v => parseInt(String(v.no||"").replace("VEN","")))
    .filter(n => !isNaN(n));
  return "VEN" + (Math.max(...nums,1000) + 1);
}

/* ================= ADD VENDOR ================= */
function addVendor(){
  const name = vendorName.value.trim();
  if(!name) return;

  if(DB.vendors.some(v=>v.name.toLowerCase()===name.toLowerCase())){
    ruleMessage("Vendor already exists");
    return;
  }

  DB.vendors.push({
    id: uid("V"),
    no: nextVendorNo(),
    name,
    createdDate: new Date().toISOString()
  });

  logAction("Vendor Created", name);
  saveDB();
  renderVendors();
}


  function addVendor(){
  const name = vendorName.value.trim();
  if(!name) return;

  if(DB.vendors.some(v=>v.name.toLowerCase()===name.toLowerCase())){
    ruleMessage("Vendor already exists");
    return;
  }

  DB.vendors.push({
    id: uid("V"),
    no: nextVendorNo(),
    name,
    createdDate: new Date().toISOString(),
    balance:0
  });

  saveDB();
  vendorName.value="";
  renderVendors();
  loadVendorOptions();
}


/* ================= EDIT VENDOR ================= */
function editVendor(id){
  const v = DB.vendors.find(x=>x.id===id);
  if(!v) return;
  const name = prompt("Edit vendor name", v.name);
  if(!name) return;
  v.name = name.trim();
  saveDB();
  renderVendors();
  loadVendorOptions();
}

/* ================= DELETE VENDOR ================= */
function deleteVendor(id){
  const v = DB.vendors.find(x=>x.id===id);
  if(!v) return;
  const bal = vendorBalance(v);
  if(bal !== 0){
    alert("Cannot delete vendor. Balance must be zero.");
    return;
  }
  if(!confirm("Delete this vendor?")) return;
  DB.vendors = DB.vendors.filter(x=>x.id!==id);
  saveDB();
  renderVendors();
  loadVendorOptions();
}

/* ================= VENDOR BALANCE ================= */
function vendorBalance(v){
  const purchase = DB.purchases
    .filter(p => p.vendorId === v.id)
    .reduce((s,p)=>s+(p.total||0),0);

  const paid = DB.cash
    .filter(c => c.type==="OUT" && c.vendor === v.name)
    .reduce((s,c)=>s+(c.amount||0),0);

  return purchase - paid;
}

/* ================= RENDER VENDORS ================= */
function renderVendors(){
  const tbody = document.getElementById("vendorRows");
  tbody.innerHTML = "";

  // Sort newest to oldest
  const vendorsSorted = [...DB.vendors].sort((a,b)=>new Date(b.createdDate)-new Date(a.createdDate));

  vendorsSorted.forEach((v,i)=>{
    const bal = vendorBalance(v);
    const created = new Date(v.createdDate).toLocaleString();

    tbody.innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${v.no}</td>
        <td>${v.name}</td>
        <td>₨ ${money(bal)}</td>
        <td><button onclick="openVendorLedger('${v.id}')">Open</button></td>
        <td><button onclick="editVendor('${v.id}')">Edit</button></td>
        <td><button onclick="deleteVendor('${v.id}')">Delete</button></td>
        <td>${created}</td>
      </tr>
    `;
  });
}

/* ================= VENDOR LEDGER ================= */
function openVendorLedger(vendorId){
  const v = DB.vendors.find(x=>x.id===vendorId);
  if(!v) return;

  const rows = [];

  DB.purchases
    .filter(p=>p.vendorId===v.id)
    .forEach(p=>{
      rows.push({
        date: p.dateTime || p.date,
        type: "Purchase",
        ref: p.id,
        debit: p.total,
        credit: 0
      });
    });

  DB.cash
    .filter(c=>c.type==="OUT" && c.vendor === v.name)
    .forEach(c=>{
      rows.push({
        date: c.dateTime,
        type: "Payment",
        ref: c.ref || c.id,
        debit: 0,
        credit: c.amount
      });
    });

  rows.sort((a,b)=>new Date(a.date)-new Date(b.date));

  let runBal = 0;

  const w = window.open("","_blank");
  w.document.write(`
<!DOCTYPE html>
<html>
<head>
<title>Vendor Ledger</title>
<style>
body{font-family:Segoe UI,Arial;padding:30px}
h1{margin:0;font-size:26px}
h2{margin:0 0 15px;color:#666;font-size:14px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:8px;text-align:center}
th{background:#f3f3f3}
.right{text-align:right}
.total{font-size:26px;font-weight:bold;margin-top:20px;text-align:right}
@media print{button{display:none}}
</style>
</head>
<body>

<h1>${v.name}</h1>
<h2>${v.no}</h2>

<table>
<thead>
<tr>
<th>S No</th>
<th>Date</th>
<th>Type</th>
<th>Ref</th>
<th>Debit</th>
<th>Credit</th>
<th>Balance</th>
</tr>
</thead>
<tbody>
${rows.map((r,i)=>{
  runBal += r.debit - r.credit;
  const d = new Date(r.date);
  return `
<tr>
<td>${i+1}</td>
<td>${d.toLocaleDateString()} ${d.toLocaleTimeString()}</td>
<td>${r.type}</td>
<td>${r.ref}</td>
<td class="right">${money(r.debit)}</td>
<td class="right">${money(r.credit)}</td>
<td class="right">${money(runBal)}</td>
</tr>`;
}).join("")}
</tbody>
</table>

<div class="total">Present Balance: ₨ ${money(runBal)}</div>

</body>
</html>
`);
}

/* ================= CASH IN HAND LINK ================= */
function loadVendorOptions(){
  const selectAdd = document.getElementById("payVendor");
  const selectFilter = document.getElementById("cashVendorFilter");
  selectAdd.innerHTML='<option value="">Select Vendor</option>';
  selectFilter.innerHTML='<option value="">All Vendors</option>';
  DB.vendors.forEach(v=>{
    selectAdd.innerHTML+=`<option value="${v.name}">${v.name}</option>`;
    selectFilter.innerHTML+=`<option value="${v.name}">${v.name}</option>`;
  });
}

/* ================= INIT ================= */
renderVendors();
loadVendorOptions();
</script>

<!-- ================= PURCHASE ================= -->

<style>
#purchase{width:100%;min-height:100vh;padding:30px}
#purchase h3{color:var(--primary);margin:20px 0}
.p-block{border:1px solid var(--border);padding:20px;margin-bottom:30px;border-radius:12px}
.p-table{width:100%;border-collapse:collapse}
.p-table th{background:#f4f6fb;color:var(--primary);text-align:left;font-weight:600}
.p-table td,.p-table th{padding:12px;border:1px solid var(--border)}
.suggest-box{position:absolute;background:#fff;border:1px solid var(--border);z-index:999;width:100%}
.suggest-box div{padding:8px;cursor:pointer}
.suggest-box .active,.suggest-box div:hover{background:#e8edf6}
.filter-row select{margin-right:10px}
</style>

<section id="purchase">

<h3>Purchase</h3>

<!-- ===== VENDOR ===== -->
<div class="p-block">
<label>Vendor</label>
<select id="purchaseVendor" style="width:100%"></select>
</div>

<!-- ===== EXCEL ===== -->
<div class="p-block">
<label>Upload Excel</label>
<input type="file" accept=".xls,.xlsx" onchange="uploadPurchaseExcel(this)">
</div>

<!-- ===== ENTRY TABLE ===== -->
<div class="p-block">
<table class="p-table">
<thead>
<tr>
<th>Barcode</th>
<th>Item No</th>
<th>Description</th>
<th>Stock</th>
<th>Qty</th>
<th>Cost</th>
<th>Total</th>
<th></th>
</tr>
</thead>
<tbody id="purchaseRows"></tbody>
</table>

<button onclick="addPurchaseRow()">Add New Product</button>

<h3>Total: ₨ <span id="purchaseTotal">0.00</span></h3>
<button onclick="savePurchase()">Save Purchase</button>
</div>

<!-- ================= PREVIOUS PURCHASE ================= -->

<div class="p-block">
<h3>Previous Purchases</h3>

<div class="filter-row">
<select id="filterVendor" onchange="renderPurchaseHistory()"></select>
<select id="filterPeriod" onchange="renderPurchaseHistory()">
<option value="all">All Time</option>
<option value="day">Today</option>
<option value="week">This Week</option>
<option value="month">This Month</option>
<option value="year">This Year</option>
</select>
</div>

<table class="p-table">
<thead>
<tr>
<th>Date</th>
<th>Vendor</th>
<th>Amount</th>
<th>Edit</th>
<th>Delete</th>
</tr>
</thead>
<tbody id="purchaseHistory"></tbody>
</table>

<div style="margin-top:15px">
<button onclick="prevPurchasePage()">◀</button>
<span id="purchasePageInfo"></span>
<button onclick="nextPurchasePage()">▶</button>
</div>
</div>

</section>

<script>
let purchaseDraft=[];
let purchasePage=1;
const PER_PAGE=20;

/* ===== LOAD VENDORS ===== */
function loadPurchaseVendors(){
  purchaseVendor.innerHTML='<option value="">Select Vendor</option>';
  filterVendor.innerHTML='<option value="">All Vendors</option>';
  DB.vendors.forEach(v=>{
    purchaseVendor.innerHTML+=`<option value="${v.id}">${v.name}</option>`;
    filterVendor.innerHTML+=`<option value="${v.id}">${v.name}</option>`;
  });
}

/* ===== ADD ROW ===== */
function addPurchaseRow(){
  purchaseDraft.push({productId:null,barcode:"",itemNo:"",desc:"",qty:1,cost:0});
  renderPurchaseRows();
}

/* ===== RENDER ROW ===== */
function renderPurchaseRows(){
  purchaseRows.innerHTML="";
  let grand=0;

  purchaseDraft.forEach((r,i)=>{
    const p=DB.products.find(x=>x.id===r.productId);
    const stock=p?p.stock:0;
    const total=r.qty*r.cost;
    grand+=total;

    purchaseRows.innerHTML+=`
<tr>
<td><input value="${r.barcode}" oninput="searchProduct(this,${i})"></td>
<td><input value="${r.itemNo}" oninput="searchProduct(this,${i})"></td>
<td><input value="${r.desc}" oninput="searchProduct(this,${i})"></td>
<td>${stock}</td>
<td><input type="number" value="${r.qty}" onchange="setQty(${i},this.value)"></td>
<td><input type="number" value="${r.cost}" onchange="setCost(${i},this.value)" onkeydown="costTab(event,${i})"></td>
<td>${total.toLocaleString(undefined,{minimumFractionDigits:2})}</td>
<td><button onclick="removeRow(${i})">X</button></td>
</tr>`;
  });

  purchaseTotal.innerText=grand.toLocaleString(undefined,{minimumFractionDigits:2});
}

/* ===== SEARCH ===== */
function searchProduct(inp,i){
  document.querySelectorAll(".suggest-box").forEach(x=>x.remove());
  const val=inp.value.trim();
  purchaseDraft[i].productId=null;   // IMPORTANT: reset

  if(!val)return;

  const list=DB.products.filter(p=>
    p.barcode.toLowerCase().includes(val.toLowerCase()) ||
    p.itemNo.toLowerCase().includes(val.toLowerCase()) ||
    p.desc.toLowerCase().includes(val.toLowerCase())
  ).slice(0,5);

  const box=document.createElement("div");
  box.className="suggest-box";
  inp.parentNode.style.position="relative";
  inp.parentNode.appendChild(box);

  if(!list.length){
    const d=document.createElement("div");
    d.innerText="❌ No match found";
    d.style.color="red";
    box.appendChild(d);
    return;
  }

  list.forEach(p=>{
    const d=document.createElement("div");
    d.innerText=`${p.barcode} | ${p.itemNo} | ${p.desc}`;
    d.onclick=()=>selectProduct(i,p);
    box.appendChild(d);
  });
}

function selectProduct(i,p){
  if(purchaseDraft.some((x,idx)=>idx!==i && x.productId===p.id)){
    ruleMessage("This product already exists in purchase");
    return;
  }

  Object.assign(purchaseDraft[i],{
    productId:p.id,
    barcode:p.barcode,
    itemNo:p.itemNo,
    desc:p.desc
  });

  renderPurchaseRows();
}


document.addEventListener("click",()=>document.querySelectorAll(".suggest-box").forEach(x=>x.remove()));

/* ===== UTILS ===== */
function setQty(i,v){
  if(v.includes(".")){
    ruleMessage("Decimal quantity not allowed");
    return;
  }
  purchaseDraft[i].qty = parseInt(v) || 1;
  renderPurchaseRows();
}
function setCost(i,v){purchaseDraft[i].cost=+v||0;renderPurchaseRows()}
function removeRow(i){purchaseDraft.splice(i,1);renderPurchaseRows()}
function costTab(e,i){if(e.key==="Tab"){e.preventDefault();if(i===purchaseDraft.length-1)addPurchaseRow()}}

/* ===== SAVE ===== */
function savePurchase(){
  if(!purchaseVendor.value)return alert("Select vendor");
  let total=0;

  for(const r of purchaseDraft){
  if(!r.productId){
    alert("Invalid product detected. Please select from list.");
    return;
  }
  const p=DB.products.find(x=>x.id===r.productId);
  p.stock+=r.qty;
  total+=r.qty*r.cost;
}

  DB.purchases.push({
    id:uid("PUR"),
    vendorId:purchaseVendor.value,
    date:new Date().toISOString().slice(0,10),
    items:JSON.parse(JSON.stringify(purchaseDraft)),
    total
  });

  saveDB();
  purchaseDraft=[];
  addPurchaseRow();
  renderPurchaseHistory();
}

/* ===== HISTORY ===== */
function renderPurchaseHistory(){
  purchaseHistory.innerHTML="";
  let list=DB.purchases.filter(p=>{
    if(filterVendor.value && p.vendorId!==filterVendor.value)return false;
    return true;
  }).reverse();

  const pages=Math.ceil(list.length/PER_PAGE);
  if(purchasePage>pages)purchasePage=pages||1;

  list.slice((purchasePage-1)*PER_PAGE,purchasePage*PER_PAGE).forEach(p=>{
    const v=DB.vendors.find(x=>x.id===p.vendorId);
    purchaseHistory.innerHTML+=`
<tr>
<td>${p.date}</td>
<td>${v?v.name:""}</td>
<td>${p.total.toLocaleString(undefined,{minimumFractionDigits:2})}</td>
<td><button onclick="editPurchase('${p.id}')">Edit</button></td>
<td><button onclick="deletePurchase('${p.id}')">X</button></td>
</tr>`;
  });

  purchasePageInfo.innerText=`Page ${purchasePage} / ${pages||1}`;
}

function editPurchase(id){
  const p=DB.purchases.find(x=>x.id===id);
  if(!p)return;
  purchaseVendor.value=p.vendorId;
  purchaseDraft=JSON.parse(JSON.stringify(p.items));
  renderPurchaseRows();
}

function deletePurchase(id){
  const p=DB.purchases.find(x=>x.id===id);
  if(!p||p.items.length)return alert("Cannot delete purchase with products");
  DB.purchases=DB.purchases.filter(x=>x.id!==id);
  saveDB();
  renderPurchaseHistory();
}

/* ===== EXCEL ===== */
function uploadPurchaseExcel(input){
  const r=new FileReader();
  r.onload=e=>{
    const wb=XLSX.read(e.target.result,{type:"binary"});
    XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]).forEach(row=>{
      const p=DB.products.find(x=>x.barcode==row.Barcode||x.itemNo==row["Item No"]||x.desc==row.Description);
      if(!p)return;
      purchaseDraft.push({productId:p.id,barcode:p.barcode,itemNo:p.itemNo,desc:p.desc,qty:+row.Qty||0,cost:+row.Cost||0});
    });
    renderPurchaseRows();
  };
  r.readAsBinaryString(input.files[0]);
}

/* ===== INIT ===== */
loadPurchaseVendors();
addPurchaseRow();
renderPurchaseHistory();
</script>
<!-- ================= RETURN SECTION ================= -->
<section id="return" style="display:none">
  <h3>Return (Vendor)</h3>

  <div class="ret-box">
    <label>Return No</label>
    <input id="returnNo" disabled>

    <label>Vendor</label>
    <select id="returnVendor"></select>

    <label>Product</label>
    <select id="returnProduct"></select>

    <label>Cost Rate</label>
    <input type="number" id="returnRate">

    <label>Qty</label>
    <input type="number" id="returnQty">

    <button onclick="addReturn()">Add Return</button>
  </div>

  <h4>Previous Returns</h4>
  <select id="filterVendor" onchange="renderReturns()">
    <option value="">All Vendors</option>
  </select>

  <table id="returnTable">
    <thead>
      <tr>
        <th>No</th>
        <th>Vendor</th>
        <th>Product</th>
        <th>Rate</th>
        <th>Qty</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<!-- ================= REPORTS ================= -->
<section id="reports">
  <div class="card">
    <h2>Reports</h2>
    <button onclick="generateReport()">Generate</button>
    <pre id="reportOutput"></pre>
  </div>
  <h3>Invoice Wise Profit</h3>

<div class="r-filter">
  <input type="date" id="profitFrom">
  <input type="date" id="profitTo">

  <select id="profitUser">
    <option value="">All Users</option>
  </select>

  <button onclick="applyProfitReport()">Apply</button>
</div>

<table class="r-table">
  <thead>
    <tr>
      <th>Invoice</th>
      <th>Date</th>
      <th>Person</th>
      <th>Invoice Amt</th>
      <th>Cost</th>
      <th>Profit</th>
    </tr>
  </thead>
  <tbody id="profitRows"></tbody>
</table>

<div id="profitDetail"></div>

</section>

<script>
function generateReport(){ document.getElementById("reportOutput").innerText=JSON.stringify(DB,null,2);}
</script>
<script>
function getPurchaseCost(productId, invDate){
  const list = DB.purchases
    .filter(p=>p.productId===productId && new Date(p.date)<=new Date(invDate))
    .sort((a,b)=>new Date(b.date)-new Date(a.date));
  return list.length ? list[0].rate : 0;
}
</script>
<script>
function applyProfitReport(){
  const from = profitFrom.value;
  const to = profitTo.value;
  const user = profitUser.value;

  profitRows.innerHTML = "";
  profitDetail.innerHTML = "";

  DB.invoices.forEach(inv=>{
    if(from && inv.date < from) return;
    if(to && inv.date > to) return;
    if(user && inv.createdBy !== user) return;

    let cost=0, profit=0;

    inv.items.forEach(it=>{
      const c = getPurchaseCost(it.productId, inv.date);
      cost += c * it.qty;
      profit += (it.rate - c) * it.qty;
    });

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${inv.no}</td>
      <td>${inv.date}</td>
      <td>${inv.createdBy}</td>
      <td>${inv.total}</td>
      <td>${cost}</td>
      <td class="${profit>=0?'profit-pos':'profit-neg'}">${profit}</td>
    `;
    tr.onclick = ()=>showProfitDetail(inv);
    profitRows.appendChild(tr);
  });
}
</script>
<script>
function showProfitDetail(inv){
  let html = `<h4>Invoice ${inv.no} Detail</h4>
  <table class="r-table">
  <tr><th>Product</th><th>Qty</th><th>Sale</th><th>Cost</th><th>Profit</th></tr>`;

  inv.items.forEach(it=>{
    const c = getPurchaseCost(it.productId, inv.date);
    const p = (it.rate - c) * it.qty;
    const prod = DB.products.find(x=>x.id===it.productId);

    html += `
      <tr>
        <td>${prod?.desc||""}</td>
        <td>${it.qty}</td>
        <td>${it.rate}</td>
        <td>${c}</td>
        <td class="${p>=0?'profit-pos':'profit-neg'}">${p}</td>
      </tr>`;
  });

  html += "</table>";
  profitDetail.innerHTML = html;
}
</script>
<script>
document.addEventListener("DOMContentLoaded",()=>{
  [...new Set(DB.logs.map(l=>l.user))].forEach(u=>{
    profitUser.innerHTML += `<option value="${u}">${u}</option>`;
  });
});
<hr style="margin:30px 0">

<h3>Deleted Data Audit</h3>

<div class="r-filter">
  <input type="date" id="delFrom">
  <input type="date" id="delTo">

  <select id="delUser">
    <option value="">All Users</option>
  </select>

  <select id="delModule">
    <option value="">All Modules</option>
    <option>Invoice</option>
    <option>Product</option>
    <option>Vendor</option>
    <option>Purchase</option>
    <option>Cash</option>
  </select>

  <button onclick="applyDeletedReport()">Apply</button>
</div>

<table class="r-table">
  <thead>
    <tr>
      <th>Date & Time</th>
      <th>User</th>
      <th>Module</th>
      <th>Action</th>
      <th>Reference</th>
    </tr>
  </thead>
  <tbody id="deletedRows"></tbody>
</table>
</script>
<script>
function applyDeletedReport(){
  const from = delFrom.value;
  const to = delTo.value;
  const user = delUser.value;
  const mod = delModule.value;

  deletedRows.innerHTML = "";

  (DB.logs||[]).forEach(l=>{
    if(l.action!=="DELETE") return;

    const d = l.dateTime.split("T")[0];
    if(from && d < from) return;
    if(to && d > to) return;
    if(user && l.user!==user) return;
    if(mod && !l.ref.startsWith(mod)) return;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${new Date(l.dateTime).toLocaleString()}</td>
      <td>${l.user}</td>
      <td>${l.ref.split(" ")[0]}</td>
      <td>${l.action}</td>
      <td>${l.ref}</td>
    `;
    deletedRows.appendChild(tr);
  });
}
</script>
<script>
document.addEventListener("DOMContentLoaded",()=>{
  const users = [...new Set((DB.logs||[]).map(l=>l.user))];
  users.forEach(u=>{
    delUser.innerHTML += `<option value="${u}">${u}</option>`;
  });
});
</script>


<!-- ================= LOGIN ================= -->
<section id="loginScreen" style="display:flex; align-items:center; justify-content:center; height:100vh; background:#f5f5f5; flex-direction:column;">
  <h1>Login</h1>
  <input type="text" id="loginUsername" placeholder="Username" style="margin:5px; padding:8px; width:200px;">
  <input type="password" id="loginPassword" placeholder="Password" style="margin:5px; padding:8px; width:200px;">
  <button onclick="submitLogin()" style="padding:8px 15px; margin-top:10px;">Login</button>
  <div id="loginError" style="color:red; margin-top:10px;"></div>
</section>

<!-- ================= SETTINGS ================= -->
<section id="settings" style="display:none; padding:20px;">
  <h2>Settings</h2>

  <!-- Software Name -->
  <div class="p-block">
    <h3>Software Name</h3>
    <input type="text" id="setSoftwareName" placeholder="Software Name" style="width:100%; margin-bottom:10px;">
    <button onclick="saveSoftwareName()">Save Name</button>
  </div>

  <!-- Upload Logo -->
  <div class="p-block">
    <h3>Upload Logo</h3>
    <input type="file" onchange="uploadLogo(this)">
  </div>

  <!-- Shop Location -->
  <div class="p-block">
    <h3>Shop Location</h3>
    <input type="text" id="shopLocation" placeholder="Enter shop location" style="width:100%; margin-bottom:10px;">
    <button onclick="saveShopLocation()">Save Location</button>
  </div>

  <!-- Font & Color -->
  <div class="p-block">
    <h3>Change Font & Color</h3>
    <label>Font:</label>
    <select id="softwareFont" style="margin-bottom:10px;">
      <option value="Arial">Arial</option>
      <option value="Verdana">Verdana</option>
      <option value="Tahoma">Tahoma</option>
      <option value="Times New Roman">Times New Roman</option>
      <option value="Georgia">Georgia</option>
      <option value="Courier New">Courier New</option>
      <option value="Helvetica">Helvetica</option>
      <option value="Roboto">Roboto</option>
      <option value="Lato">Lato</option>
      <option value="Open Sans">Open Sans</option>
    </select>
    <br>
    <label>Color:</label>
    <input type="color" id="softwareColor" value="#1e1e1e">
    <button onclick="saveFontAndColor()">Apply</button>
  </div>

  <!-- Account Management -->
  <div class="p-block">
    <h3>Manage Accounts / Roles</h3>
    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px;">
      <input type="text" id="newUsername" placeholder="Username">
      <input type="password" id="newPassword" placeholder="Password">
      <select id="newRole">
        <option value="admin">Admin</option>
        <option value="staff">Staff</option>
        <option value="developer">Developer</option>
      </select>
      <select id="newPermissions" multiple style="height:100px;">
        <option value="invoice">Invoice</option>
        <option value="cash">Cash In Hand</option>
        <option value="vendors">Vendors</option>
        <option value="products">Products</option>
        <option value="settings">Settings</option>
        <option value="reports">Reports</option>
      </select>
      <button onclick="createAccount()">Create Account</button>
    </div>

    <table style="width:100%; margin-top:10px;">
      <thead>
        <tr>
          <th>Username</th>
          <th>Role</th>
          <th>Permissions</th>
          <th>Edit</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody id="accountsTable"></tbody>
    </table>
  </div>

  <!-- Backup / Restore / Reset -->
  <div class="p-block">
    <h3>Backup / Restore / Reset</h3>
    <button onclick="downloadBackup()">Download Backup</button>
    <input type="file" onchange="restoreBackup(this)">
    <button onclick="resetSystem()">Reset System</button>
  </div>
</section>

<script>
/* ===== INIT DEFAULT DEVELOPER ACCOUNT ===== */
if(!DB.accounts){
  DB.accounts=[{id: uid("A"), username:"Dani", password:"7525", role:"developer", fixed:true, permissions:[]}];
  saveDB();
}

/* ===== LOGIN SYSTEM ===== */
function submitLogin(){
  const user=document.getElementById("loginUsername").value.trim();
  const pass=document.getElementById("loginPassword").value.trim();
  const acc=DB.accounts.find(x=>x.username===user && x.password===pass);
  if(!acc){
    document.getElementById("loginError").innerText="Invalid username or password";
    return;
  }
  sessionStorage.setItem("loggedInUser", JSON.stringify(acc));
  document.getElementById("loginScreen").style.display="none";
  renderSectionsByPermission();
  openTab("invoice");
  document.querySelectorAll("#mainMenu .menuItem").forEach(tab=>{
  const id = tab.id.replace("tab-","");
  if(acc.role!=="developer" && !(acc.permissions||[]).includes(id)){
    tab.style.display="none";
  }
});

}

/* ===== PERSIST LOGIN ===== */
document.addEventListener("DOMContentLoaded", ()=>{
  const acc=sessionStorage.getItem("loggedInUser");
  if(acc){
    document.getElementById("loginScreen").style.display="none";
    renderSectionsByPermission();
    openTab("invoice");
  } else {
    document.querySelectorAll("section").forEach(s=>{
      if(s.id!=="loginScreen") s.style.display="none";
    });
  }
});

/* ===== RENDER SECTIONS BASED ON PERMISSIONS ===== */
function renderSectionsByPermission(){
  const user=JSON.parse(sessionStorage.getItem("loggedInUser"));
  document.querySelectorAll("section").forEach(s=>{
    if(s.id==="loginScreen") return;
    if(!hasAccessSection(user,s.id)) s.style.display="none";
    else s.style.display="block";
  });
}

function hasAccessSection(user,sectionId){
  if(user.role==="developer") return true;
  switch(sectionId){
    case "invoice": return user.permissions.includes("invoice");
    case "cash": return user.permissions.includes("cash");
    case "vendors": return user.permissions.includes("vendors");
    case "products": return user.permissions.includes("products");
    case "settings": return user.permissions.includes("settings");
    case "reports": return user.permissions.includes("reports");
    default: return true;
  }
}

/* ===== CHECK PERMISSIONS ===== */
function hasAccess(feature){
  const user=JSON.parse(sessionStorage.getItem("loggedInUser"));
  if(!user) return false;
  if(user.role==="developer") return true;
  return user.permissions && user.permissions.includes(feature);
}

/* ===== CREATE ACCOUNT ===== */
function createAccount(){
  const username=document.getElementById("newUsername").value.trim();
  const password=document.getElementById("newPassword").value.trim();
  const role=document.getElementById("newRole").value;
  const perms=Array.from(document.getElementById("newPermissions").selectedOptions).map(x=>x.value);

  if(!username || !password || !role) return alert("Please fill all fields");
  if(DB.accounts.find(x=>x.username===username)) return alert("Username exists");

  DB.accounts.push({id: uid("A"), username, password, role, permissions:perms});
  saveDB();
  renderAccounts();

  document.getElementById("newUsername").value="";
  document.getElementById("newPassword").value="";
  document.getElementById("newRole").value="admin";
  document.getElementById("newPermissions").selectedIndex=-1;
}

/* ===== RENDER ACCOUNTS TABLE ===== */
function renderAccounts(){
  const tbody=document.getElementById("accountsTable");
  tbody.innerHTML="";
  DB.accounts.forEach(a=>{
    tbody.innerHTML+=`
      <tr>
        <td>${a.username}</td>
        <td>${a.role}</td>
        <td>${(a.permissions||[]).join(", ")}</td>
        <td><button onclick="editAccount('${a.id}')">Edit</button></td>
        <td>${a.fixed?"":`<button onclick="deleteAccount('${a.id}')">Delete</button>`}</td>
      </tr>
    `;
  });
}

/* ===== EDIT ACCOUNT ===== */
function editAccount(id){
  const acc=DB.accounts.find(x=>x.id===id);
  if(!acc) return alert("Account not found");
  if(acc.fixed) return alert("Cannot edit developer account");

  const username=prompt("Username:", acc.username);
  const password=prompt("Password:", acc.password);
  const role=prompt("Role:", acc.role);
  const perms=prompt("Permissions (comma separated):", (acc.permissions||[]).join(","));

  if(username) acc.username=username;
  if(password) acc.password=password;
  if(role) acc.role=role;
  acc.permissions=perms?perms.split(",").map(x=>x.trim()):[];
  saveDB();
  renderAccounts();
}

/* ===== DELETE ACCOUNT ===== */
function deleteAccount(id){
  const acc=DB.accounts.find(x=>x.id===id);
  if(!acc || acc.fixed) return alert("Cannot delete this account");
  if(!confirm("Delete this account?")) return;
  DB.accounts=DB.accounts.filter(x=>x.id!==id);
  saveDB();
  renderAccounts();
}

/* ===== FONT & COLOR ===== */
function saveFontAndColor(){
  if(!DB.settings) DB.settings={};
  const font=document.getElementById("softwareFont").value;
  const color=document.getElementById("softwareColor").value;
  DB.settings.font=font;
  DB.settings.color=color;
  saveDB();
  document.body.style.fontFamily=font;
  document.documentElement.style.setProperty('--primary', color);
  alert("Font & color applied");
}
document.addEventListener("DOMContentLoaded", ()=>{
  if(DB.settings){
    if(DB.settings.font) document.body.style.fontFamily=DB.settings.font;
    if(DB.settings.color) document.documentElement.style.setProperty('--primary', DB.settings.color);
  }
});

/* ===== SHOP LOCATION ===== */
function saveShopLocation(){
  if(!DB.settings) DB.settings={};
  const loc=document.getElementById("shopLocation").value.trim();
  DB.settings.shopLocation=loc;
  saveDB();
  alert("Shop location saved");
}

/* ===== SOFTWARE NAME ===== */
function saveSoftwareName(){
  if(!DB.settings) DB.settings={};
  const name=document.getElementById("setSoftwareName").value.trim();
  DB.settings.softwareName=name||"Dani Test Software";
  saveDB();
  alert("Software name updated");
}

/* ===== BACKUP / RESTORE / RESET ===== */
function downloadBackup(){
  const blob=new Blob([JSON.stringify(DB,null,2)], {type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="dani_backup_"+Date.now()+".json";
  a.click();
}

function restoreBackup(input){
  const file=input.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      DB=JSON.parse(e.target.result);
      saveDB();
      location.reload();
    }catch{
      alert("Invalid backup file");
    }
  };
  reader.readAsText(file);
}

function resetSystem(){
  if(!confirm("Backup will be downloaded automatically. Continue reset?")) return;
  downloadBackup();
  DB={
    products:[],
    vendors:[],
    purchases:[],
    invoices:[],
    cash:[],
    deleted:[],
    accounts:DB.accounts,
    settings:{softwareName:"Dani Test Software", logo:""}
  };
  saveDB();
  location.reload();
}

/* ===== INITIAL RENDER ===== */
renderAccounts();

/* ===== DATE & TIME ===== */
function updateTime(){
  const now=new Date();
  const el=document.getElementById("dateTime");
  if(el) el.innerText=now.toLocaleString();
}
setInterval(updateTime,1000);
updateTime();
</script>
<script>
<!-- ================= MENU LOGIC ================= -->
<script>
/* ===== OPEN TAB FUNCTION WITH UNDERLINE ANIMATION ===== */
function openTab(id){
  // Hide all sections
  document.querySelectorAll("section").forEach(s => s.style.display = "none");

  // Show the selected section
  const sec = document.getElementById(id);
  if(sec) sec.style.display = "block";

  // Update menu active state
  document.querySelectorAll("#mainMenu .menuItem").forEach(d => d.classList.remove("active"));
  const tab = document.getElementById("tab-" + id);
  if(tab) tab.classList.add("active");

  // Animate underline
  const underline = document.getElementById("menuUnderline");
  if(tab && underline){
    const rect = tab.getBoundingClientRect();
    const parentRect = tab.parentElement.getBoundingClientRect();
    underline.style.width = rect.width + "px";
    underline.style.left = (rect.left - parentRect.left) + "px";
  }
}

/* ===== ADJUST UNDERLINE ON WINDOW RESIZE ===== */
window.addEventListener("resize", () => {
  const active = document.querySelector("#mainMenu .menuItem.active");
  const underline = document.getElementById("menuUnderline");
  if(active && underline){
    const rect = active.getBoundingClientRect();
    const parentRect = active.parentElement.getBoundingClientRect();
    underline.style.width = rect.width + "px";
    underline.style.left = (rect.left - parentRect.left) + "px";
  }
});

/* ===== OPEN DEFAULT TAB ON PAGE LOAD ===== */
document.addEventListener("DOMContentLoaded", () => {
  const activeTab = document.querySelector("#mainMenu .menuItem.active");
  if(!activeTab) document.getElementById("tab-invoice").click();
});
/* ================= MENU UNDERLINE HARD LOCK ================= */

/* Lock menu height so nothing can push it */
#mainMenu{
  height:52px !important;
  align-items:center !important;
  overflow:hidden !important;
}

/* Freeze underline so JS cannot affect layout */
#menuUnderline{
  position:absolute !important;
  bottom:0 !important;
  height:3px !important;

  /* HARD FREEZE */
  max-width:0 !important;
  min-width:0 !important;
  width:0 !important;

  overflow:hidden !important;
  pointer-events:none !important;
  background:transparent !important;
}
logAction("DELETE", `Product ${prod.itemNo}`);
logAction("DELETE", `Vendor ${vendor.name}`);
logAction("DELETE", `Purchase ${purchase.id}`);

</script>
