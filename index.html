<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dani Test Software</title>

<!-- ====== XLSX LIBRARY ====== -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
:root{
  --primary:#0b1c2d;     /* Deep Dark Blue */
  --secondary:#ffffff;  /* White */
  --accent:#1f6feb;
  --border:#d0d7de;
}

/* ===== BODY ===== */
body{
  margin:0;
  font-family:Segoe UI, Arial;
  background:white;
  color:#0b1c2d;
}

/* ===== HEADER ===== */
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:var(--primary);
  color:white;
  padding:14px 22px;
  font-size:22px;
  font-weight:600;
}

#header-left{
  display:flex;
  align-items:center;
  gap:12px;
}

#header-logo{
  height:36px;
  width:auto;
  display:none;
}

#dateTime{
  font-size:14px;
  opacity:0.85;
}

/* ===== NAV ===== */
nav{
  display:flex;
  background:#f6f8fa;
  border-bottom:1px solid var(--border);
}

nav div{
  padding:14px 20px;
  cursor:pointer;
  transition:0.25s;
  border-bottom:3px solid transparent;
  font-weight:500;
}

nav div:hover{
  background:#eef2f7;
}

nav div.active{
  border-bottom:3px solid var(--accent);
  color:var(--accent);
  font-weight:600;
  transform:translateY(-1px);
}

/* ===== SECTION ===== */
section{
  display:none;
  padding:20px;
}

section.active{
  display:block;
  animation:fadeIn 0.25s ease-in;
}

@keyframes fadeIn{
  from{opacity:0; transform:translateY(4px);}
  to{opacity:1; transform:none;}
}

/* ===== CARD ===== */
.card{
  background:white;
  border:1px solid var(--border);
  padding:18px;
  margin-bottom:20px;
  border-radius:10px;
}

/* ===== TABLE ===== */
table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  border:1px solid var(--border);
  padding:8px;
  text-align:center;
}

th{
  background:#f6f8fa;
  font-weight:600;
}

/* ===== INPUT ===== */
input,select{
  padding:7px;
  border-radius:6px;
  border:1px solid var(--border);
  width:100%;
}

button{
  padding:8px 14px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:600;
}

.green{background:#2da44e;color:white;}
.red{background:#cf222e;color:white;}
.blue{background:var(--accent);color:white;}
</style>
</head>
<body>
<header>
  <div id="header-left">
    <img id="header-logo">
    <span id="softwareName">Dani Test Software</span>
  </div>
  <div id="dateTime"></div>
</header>

<nav id="menu">
  <div onclick="openTab('invoice')" id="tab-invoice">Invoice</div>
  <div onclick="openTab('cash')" id="tab-cash">Cash In Hand</div>
  <div onclick="openTab('purchase')" id="tab-purchase">Purchase</div>
  <div onclick="openTab('products')" id="tab-products">Products</div>
  <div onclick="openTab('vendors')" id="tab-vendors">Vendor</div>
  <div onclick="openTab('reports')" id="tab-reports">Reports</div>
  <div onclick="openTab('settings')" id="tab-settings">Settings</div>
</nav>
<script>
const DB = {
  products: JSON.parse(localStorage.getItem("products")||"[]"),
  vendors: JSON.parse(localStorage.getItem("vendors")||"[]"),
  purchases: JSON.parse(localStorage.getItem("purchases")||"[]"),
  invoices: JSON.parse(localStorage.getItem("invoices")||"[]"),
  cash: JSON.parse(localStorage.getItem("cash")||"[]"),
  deleted: JSON.parse(localStorage.getItem("deleted")||"[]")
};

function saveDB() { for(let k in DB){ localStorage.setItem(k, JSON.stringify(DB[k])); } }
function uid(prefix){ return prefix + "_" + Date.now() + Math.floor(Math.random()*1000); }
</script>
<section id="invoice">
  <div class="card" id="newInvoiceCard">
    <h2>New Invoice</h2>

    <!-- SEARCH -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px;">
      <input id="inv_s_barcode" placeholder="Search Barcode">
      <input id="inv_s_item" placeholder="Search Item No">
      <input id="inv_s_desc" placeholder="Search Description">
    </div>

    <button onclick="addInvoiceRow()">New Item</button>

    <table>
      <thead>
        <tr>
          <th>Item</th>
          <th>Qty</th>
          <th>Rate</th>
          <th>Total</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="invoiceRows"></tbody>
    </table>

    <!-- Main Discount Inputs -->
    <div style="margin-top:10px; display:flex; gap:10px;">
      <input type="number" id="mainDiscAmt" placeholder="Discount Amount" oninput="syncMainDiscAmt()">
      <input type="number" id="mainDiscPct" placeholder="Discount %" oninput="syncMainDiscPct()">
    </div>

    <h3>Total: â‚¨ <span id="invTotal">0</span></h3>
    <button onclick="saveInvoice()">Save Invoice</button>
  </div>
</section>
<script>
let invoiceDraft=[];
let invPage=1, invPerPage=100;
let invFiltered=DB.invoices;
let editingInvoiceId=null;

/* ===== ADD ROW ===== */
function addInvoiceRow(){
  invoiceDraft.push({
    productId:"",
    qty:1,
    rate:0,
    discAmt:0,
    discPct:0
  });
  renderInvoice();
}

/* ===== RENDER ===== */
function renderInvoice(){
  const tbody=document.getElementById("invoiceRows");
  tbody.innerHTML="";
  let subtotal=0;

  invoiceDraft.forEach((r,i)=>{
    const p=DB.products.find(x=>x.id===r.productId)||{};
    const gross=r.qty*r.rate;
    const disc=r.discAmt || (gross*r.discPct/100);
    const total=gross-disc;
    subtotal+=total;

    tbody.innerHTML+=`
    <tr>
      <td><input placeholder="Barcode" oninput="searchInv(${i},this.value)"></td>
      <td><input placeholder="Item No" oninput="searchInv(${i},this.value)"></td>
      <td><input placeholder="Description" oninput="searchInv(${i},this.value)"></td>

      <td><input type="number" value="${r.qty}" min="1" onchange="setInvQty(${i},this.value)"></td>
      <td><input type="number" value="${r.rate}" onchange="setInvRate(${i},this.value)"></td>

      <td><input type="number" value="${r.discAmt}" onchange="setInvDiscAmt(${i},this.value)"></td>
      <td><input type="number" value="${r.discPct}" onchange="setInvDiscPct(${i},this.value)"></td>

      <td>${total.toFixed(2)}</td>
      <td><button class="red" onclick="delInvRow(${i})">X</button></td>
    </tr>`;
  });

  applyMainDiscount(subtotal);
}

/* ===== SEARCH PRODUCT ===== */
function searchInv(i,val){
  const p=DB.products.find(x=>
    x.stock>0 && (
      x.barcode?.toLowerCase().includes(val.toLowerCase()) ||
      x.itemNo?.toLowerCase().includes(val.toLowerCase()) ||
      x.desc?.toLowerCase().includes(val.toLowerCase())
    )
  );

  if(p){
    invoiceDraft[i].productId=p.id;
    invoiceDraft[i].rate=p.rate;
    renderInvoice();
  }
}

/* ===== SETTERS ===== */
function setInvQty(i,v){invoiceDraft[i].qty=+v;renderInvoice();}
function setInvRate(i,v){invoiceDraft[i].rate=+v;renderInvoice();}

function setInvDiscAmt(i,v){
  invoiceDraft[i].discAmt=+v;
  const gross=invoiceDraft[i].qty*invoiceDraft[i].rate;
  invoiceDraft[i].discPct=gross?((v/gross)*100):0;
  renderInvoice();
}

function setInvDiscPct(i,v){
  invoiceDraft[i].discPct=+v;
  const gross=invoiceDraft[i].qty*invoiceDraft[i].rate;
  invoiceDraft[i].discAmt=(gross*v/100);
  renderInvoice();
}

function delInvRow(i){invoiceDraft.splice(i,1);renderInvoice();}

/* ===== MAIN DISCOUNT ===== */
function syncMainDiscAmt(){
  const amt=+document.getElementById("mainDiscAmt").value;
  const sub=getSubTotal();
  document.getElementById("mainDiscPct").value =
    sub ? ((amt/sub)*100).toFixed(2) : 0;
  applyMainDiscount(sub);
}

function syncMainDiscPct(){
  const pct=+document.getElementById("mainDiscPct").value;
  const sub=getSubTotal();
  document.getElementById("mainDiscAmt").value =
    (sub*pct/100).toFixed(2);
  applyMainDiscount(sub);
}

function getSubTotal(){
  return invoiceDraft.reduce((s,r)=>{
    const g=r.qty*r.rate;
    return s+(g-(r.discAmt||g*r.discPct/100));
  },0);
}

function applyMainDiscount(sub){
  const disc=+document.getElementById("mainDiscAmt").value||0;
  document.getElementById("invTotal").innerText=(sub-disc).toFixed(2);
}

/* ===== SAVE INVOICE ===== */
function saveInvoice(){
  if(!invoiceDraft.length) return alert("Empty invoice");

  // restore if editing
  if(editingInvoiceId){
    const old=DB.invoices.find(i=>i.id===editingInvoiceId);
    old.items.forEach(r=>{
      const p=DB.products.find(x=>x.id===r.productId);
      if(p) p.stock+=r.qty;
    });
    DB.cash=DB.cash.filter(c=>c.ref!==editingInvoiceId);
  }

  // deduct stock
  invoiceDraft.forEach(r=>{
    const p=DB.products.find(x=>x.id===r.productId);
    if(p) p.stock-=r.qty;
  });

  const total=+document.getElementById("invTotal").innerText;

  const invId=editingInvoiceId||uid("INV");

  DB.invoices=DB.invoices.filter(i=>i.id!==invId);
  DB.invoices.push({
    id:invId,
    date:new Date().toISOString().slice(0,10),
    items:JSON.parse(JSON.stringify(invoiceDraft)),
    total
  });

  DB.cash.push({
    id:uid("CASH"),
    type:"IN",
    amount:total,
    ref:invId,
    date:new Date().toISOString().slice(0,10)
  });

  saveDB();
  invoiceDraft=[];
  editingInvoiceId=null;
  document.getElementById("mainDiscAmt").value = 0;
  document.getElementById("mainDiscPct").value = 0;
  renderInvoice();
  renderInvoiceList();
  alert("Invoice saved");
}

/* ===== INVOICE LIST ===== */
function renderInvoiceList(){
  const tbody=document.getElementById("invoiceList");
  tbody.innerHTML="";
  const start=(invPage-1)*invPerPage;
  invFiltered.slice(start,start+invPerPage).forEach((i,idx)=>{
    tbody.innerHTML+=`
    <tr>
      <td>${start+idx+1}</td>
      <td>${i.date}</td>
      <td>${i.total.toFixed(2)}</td>
      <td><button onclick="editInvoice('${i.id}')">Edit</button></td>
      <td><button class="red" onclick="deleteInvoice('${i.id}')">Delete</button></td>
    </tr>`;
  });
}

function editInvoice(id){
  const inv=DB.invoices.find(i=>i.id===id);
  editingInvoiceId=id;
  invoiceDraft=JSON.parse(JSON.stringify(inv.items));
  document.getElementById("newInvoiceCard").scrollIntoView();
  renderInvoice();
}

function deleteInvoice(id){
  if(!confirm("Delete invoice?")) return;
  const inv=DB.invoices.find(i=>i.id===id);

  inv.items.forEach(r=>{
    const p=DB.products.find(x=>x.id===r.productId);
    if(p) p.stock+=r.qty;
  });

  DB.cash=DB.cash.filter(c=>c.ref!==id);
  DB.deleted.push({type:"INVOICE",data:inv});

  DB.invoices=DB.invoices.filter(i=>i.id!==id);
  saveDB();
  renderInvoiceList();
}

/* ===== FILTER ===== */
function applyInvoiceFilter(){
  const d=document.getElementById("invDateFilter").value;
  invFiltered=d?DB.invoices.filter(i=>i.date===d):DB.invoices;
  document.getElementById("newInvoiceCard").style.display=d?"none":"block";
  invPage=1;
  renderInvoiceList();
}

function nextInvPage(){invPage++;renderInvoiceList();}
function prevInvPage(){if(invPage>1){invPage--;renderInvoiceList();}}

renderInvoiceList();
</script>
