<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dani Test Software</title>

<!-- ====== XLSX LIBRARY ====== -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
:root{
  --primary:#0b1c2d;     /* Deep Dark Blue */
  --secondary:#ffffff;  /* White */
  --accent:#1f6feb;
  --border:#d0d7de;
}

/* ===== BODY ===== */
body{
  margin:0;
  font-family:Segoe UI, Arial;
  background:white;
  color:#0b1c2d;
}

/* ===== HEADER ===== */
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:var(--primary);
  color:white;
  padding:14px 22px;
  font-size:22px;
  font-weight:600;
}

#header-left{
  display:flex;
  align-items:center;
  gap:12px;
}

#header-logo{
  height:40px;
  max-height:60px;
  width:auto;
  display:none;
}

#dateTime{
  font-size:14px;
  opacity:0.85;
}

/* ===== NAV ===== */
nav{
  display:flex;
  background:#f6f8fa;
  border-bottom:1px solid var(--border);
}

nav div{
  padding:14px 20px;
  cursor:pointer;
  transition:0.25s;
  border-bottom:3px solid transparent;
  font-weight:500;
}

nav div:hover{
  background:#eef2f7;
}

nav div.active{
  border-bottom:3px solid var(--accent);
  color:var(--accent);
  font-weight:600;
  transform:translateY(-1px);
}

/* ===== SECTION ===== */
section{
  display:none;
  padding:20px;
}

section.active{
  display:block;
  animation:fadeIn 0.25s ease-in;
}

@keyframes fadeIn{
  from{opacity:0; transform:translateY(4px);}
  to{opacity:1; transform:none;}
}

/* ===== CARD ===== */
.card{
  background:white;
  border:1px solid var(--border);
  padding:18px;
  margin-bottom:20px;
  border-radius:10px;
}

/* ===== TABLE ===== */
table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  border:1px solid var(--border);
  padding:8px;
  text-align:center;
}

th{
  background:#f6f8fa;
  font-weight:600;
}

/* ===== INPUT ===== */
input,select{
  padding:7px;
  border-radius:6px;
  border:1px solid var(--border);
  width:100%;
}

button{
  padding:8px 14px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:600;
}

.green{background:#2da44e;color:white;}
.red{background:#cf222e;color:white;}
.blue{background:var(--accent);color:white;}
</style>
</head>
<body>

<header>
  <div id="header-left">
    <img id="header-logo">
    <span id="softwareName">Dani Test Software</span>
  </div>
  <div id="dateTime"></div>
</header>

<nav id="menu">
  <div onclick="openTab('invoice')" id="tab-invoice">Invoice</div>
  <div onclick="openTab('cash')" id="tab-cash">Cash In Hand</div>
  <div onclick="openTab('purchase')" id="tab-purchase">Purchase</div>
  <div onclick="openTab('products')" id="tab-products">Products</div>
  <div onclick="openTab('vendors')" id="tab-vendors">Vendor</div>
  <div onclick="openTab('reports')" id="tab-reports">Reports</div>
  <div onclick="openTab('settings')" id="tab-settings">Settings</div>
</nav>

<!-- ================= DATABASE ================= -->
<script>
let DB = {
  products: JSON.parse(localStorage.getItem("products") || "[]"),
  vendors: JSON.parse(localStorage.getItem("vendors") || "[]"),
  purchases: JSON.parse(localStorage.getItem("purchases") || "[]"),
  invoices: JSON.parse(localStorage.getItem("invoices") || "[]"),
  cash: JSON.parse(localStorage.getItem("cash") || "[]"),
  deleted: JSON.parse(localStorage.getItem("deleted") || "[]"),
  settings: JSON.parse(localStorage.getItem("settings") || "{}")
};

function saveDB() { 
  for(let k in DB){ 
    localStorage.setItem(k, JSON.stringify(DB[k])); 
  } 
}

function uid(prefix){ 
  return prefix + "_" + Date.now() + Math.floor(Math.random()*1000); 
}
</script>
<!-- ================= INVOICE ================= -->
<section id="invoice">
  <div class="card" id="newInvoiceCard">
    <h2>New Invoice</h2>

    <!-- ===== ADD PRODUCT ROW ===== -->
    <table style="width:100%; margin-bottom:10px;">
      <thead>
        <tr>
          <th style="width:14%">Barcode</th>
          <th style="width:10%">Item No</th>
          <th>Description</th>
          <th style="width:6%">Qty</th>
          <th style="width:8%">Rate</th>
          <th style="width:10%">Total</th>
          <th style="width:6%">Delete</th>
        </tr>
      </thead>
      <tbody id="invoiceRows"></tbody>
    </table>
    <button class="green" onclick="addInvoiceRow()">+ Add Item</button>

    <!-- ===== DISCOUNT ROW ===== -->
    <div style="margin-top:10px; display:flex; gap:12px; align-items:center;">
      <div>
        <label>Main Discount Amount</label><br>
        <input type="number" id="mainDiscAmt" value="0" onchange="applyMainDiscount(getSubTotal())" style="width:120px">
      </div>

      <div>
        <label>Main Discount %</label><br>
        <input type="number" id="mainDiscPct" value="0" onchange="applyMainDiscount(getSubTotal())" style="width:100px">
      </div>

      <div style="margin-left:auto; font-size:16px;">
        <b>Total: </b><span id="invTotal">0</span>
      </div>
    </div>

    <!-- ===== SAVE ===== -->
    <div style="margin-top:10px;">
      <button class="blue" onclick="saveInvoice()">Save Invoice</button>
    </div>
  </div>

  <!-- ===== PREVIOUS INVOICES ===== -->
  <div class="card" style="margin-top:20px;">
    <h2>Previous Invoices</h2>

    <!-- Filter -->
    <div style="margin-bottom:10px;">
      <label>From:</label>
      <input type="date" id="invFrom">
      <label>To:</label>
      <input type="date" id="invTo">
      <button onclick="applyInvoiceFilter()">Apply</button>
    </div>

    <table style="width:100%;">
      <thead>
        <tr>
          <th>#</th>
          <th>Date & Time</th>
          <th>Total</th>
          <th>Print</th>
          <th>Edit</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody id="invoiceList"></tbody>
    </table>
  </div>
</section>

<script>
/* ================= INVOICE LOGIC ================= */

/* ONLY DATE FORMAT CHANGE (SAFE) */
function nowDateTime(){
  const d=new Date();
  return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0")+" "+
         String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0")+":"+String(d.getSeconds()).padStart(2,"0");
}

/* ===== TOTAL / DISCOUNT FIX (ONLY THIS LOGIC CHANGED) ===== */
function applyMainDiscount(sub){
  const amt = +document.getElementById("mainDiscAmt").value || 0;
  const pct = +document.getElementById("mainDiscPct").value || 0;
  const pctAmt = sub * (pct / 100);
  document.getElementById("invTotal").innerText = (sub - amt - pctAmt).toFixed(2);
}

/* ===== SAVE INVOICE (ONLY DATE TIME ADDED) ===== */
const _saveInvoice = saveInvoice;
saveInvoice = function(){
  if(!invoiceDraft.length) return alert("Invoice empty");
  if(invoiceDraft.some(r=>!r.valid)) return alert("Invoice contains invalid product.");

  const id = editingInvoiceId || uid("INV");
  const datetime = nowDateTime();
  const total = +document.getElementById("invTotal").innerText;

  for(const r of invoiceDraft){
    const p = DB.products.find(x=>x.id===r.productId);
    if(!p || p.stock<r.qty){ alert("Stock issue: "+r.desc); return; }
  }

  invoiceDraft.forEach(r=>{
    const p = DB.products.find(x=>x.id===r.productId);
    if(p) p.stock -= r.qty;
  });

  DB.invoices = DB.invoices.filter(i=>i.id!==id);
  DB.invoices.push({ id, date: datetime, total, items: JSON.parse(JSON.stringify(invoiceDraft)) });

  DB.cash.push({ id: uid("C"), type:"IN", amount: total, ref:id, date: datetime });

  saveDB();
  invoiceDraft=[];
  editingInvoiceId=null;
  document.getElementById("mainDiscAmt").value=0;
  document.getElementById("mainDiscPct").value=0;

  renderInvoice();
  renderInvoiceList();
  renderCash();
  alert("Invoice saved successfully");
}

/* ===== LIST (UNCHANGED LOGIC) ===== */
const _renderInvoiceList = renderInvoiceList;
renderInvoiceList = function(){
  const tb=document.getElementById("invoiceList");
  tb.innerHTML="";
  (invFiltered||DB.invoices).forEach((i,idx)=>{
    tb.innerHTML+=`
    <tr>
      <td>${idx+1}</td>
      <td>${i.date||""}</td>
      <td>${Number(i.total).toFixed(2)}</td>
      <td><button onclick="printInvoice('${i.id}')">Print</button></td>
      <td><button onclick="editInvoice('${i.id}')">Edit</button></td>
      <td><button class="red" onclick="deleteInvoice('${i.id}')">Delete</button></td>
    </tr>`;
  });
};
</script>

<style>
.invSug{
  position:absolute;
  background:#fff;
  border:1px solid #ccc;
  max-height:160px;
  overflow:auto;
  z-index:50;
}
.invSug div:hover{ background:#eee; }
td{ position:relative; }
</style>

<!-- ================= CASH ================= -->
<section id="cash">

  <!-- ===== STICKY BALANCE BAR ===== -->
  <div style="
    position:sticky;
    top:0;
    z-index:10;
    background:#fff;
    padding:10px;
    border-bottom:2px solid #ddd;
  ">
    <h2>Cash In Hand</h2>
    <h3>Balance: <span id="cashBal">0</span></h3>
  </div>

  <div class="card">

    <!-- ===== ADD NEW PAYMENT ===== -->
    <h3>Add New Payment</h3>
    <hr>
    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:15px;">
      <input type="date" id="payDate" style="flex:1 1 150px;">
      <input placeholder="Vendor" id="payVendor" style="flex:1 1 150px;">
      <input placeholder="Reference" id="payRef" style="flex:1 1 150px;">
      <input type="number" placeholder="Amount" id="payAmount" style="flex:1 1 120px;">
      <button class="red" onclick="addCashPayment()">Pay</button>
    </div>

    <!-- ===== FILTER ===== -->
    <h3>Filter</h3>
    <hr>
    <label>From</label>
    <input type="date" id="cashFrom">
    <label>To</label>
    <input type="date" id="cashTo">
    <button onclick="renderCash()">Apply</button>

    <!-- ===== CASH TABLE ===== -->
    <table style="margin-top:10px;">
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Vendor</th>
          <th>Amount</th>
          <th>Ref</th>
          <th>Balance</th>
        </tr>
      </thead>
      <tbody id="cashRows"></tbody>
    </table>

  </div>
</section>

<script>
/* ===== CASH BALANCE ===== */
function cashBalance(){
  return DB.cash.reduce((s,t)=>t.type==="IN" ? s+t.amount : s-t.amount, 0);
}

/* ===== ADD PAYMENT (CASH OUT) ===== */
function addCashPayment(){
  const date = document.getElementById("payDate").value;
  const vendor = document.getElementById("payVendor").value.trim();
  const ref = document.getElementById("payRef").value.trim();
  const amount = +document.getElementById("payAmount").value;

  if(!date || !amount) return alert("Date and Amount required");

  DB.cash.push({
    id: uid("C"),
    date,
    type: "OUT",
    vendor,
    ref,
    amount
  });

  saveDB();
  renderCash();

  payDate.value="";
  payVendor.value="";
  payRef.value="";
  payAmount.value="";
}

/* ===== RENDER CASH ===== */
function renderCash(){
  const tbody = document.getElementById("cashRows");
  tbody.innerHTML = "";

  const from = cashFrom.value;
  const to = cashTo.value;

  let bal = 0;

  DB.cash
    .sort((a,b)=>a.date.localeCompare(b.date))
    .forEach(c=>{
      if((from && c.date < from) || (to && c.date > to)) return;

      bal = c.type==="IN" ? bal + c.amount : bal - c.amount;

      tbody.innerHTML += `
        <tr>
          <td>${c.date}</td>
          <td>${c.type}</td>
          <td>${c.vendor || ""}</td>
          <td>${c.amount.toFixed(2)}</td>
          <td>${c.ref || ""}</td>
          <td>${bal.toFixed(2)}</td>
        </tr>
      `;
    });

  document.getElementById("cashBal").innerText = bal.toFixed(2);
}

/* ===== INITIAL LOAD ===== */
renderCash();
</script>
<!-- ================= PRODUCTS ================= -->
<section id="products">
  <div class="card">
    <h2>Products</h2>

    <!-- ===== FILE ACTIONS ===== -->
    <h3>Import / Export</h3>
    <hr>
    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:15px;">
      <input type="file" accept=".xlsx,.xls" onchange="uploadProductExcel(this)">
      <button class="blue" onclick="exportProductsCSV()">Download CSV</button>
    </div>

    <!-- ===== ADD PRODUCT ===== -->
    <h3>Add New Product</h3>
    <hr>
    <div style="margin-bottom:10px;">
      <button class="green" onclick="showAddProductForm()">+ Add New Product</button>
    </div>

    <div id="newProductForm" style="display:none; gap:10px; flex-wrap:wrap; margin-bottom:20px;">
      <input placeholder="Barcode" id="newProdBarcode" style="flex:1 1 150px;">
      <input placeholder="Item No" id="newProdItemNo" style="flex:1 1 150px;">
      <input placeholder="Description" id="newProdDesc" style="flex:2 1 200px;">
      <input type="number" placeholder="Rate" id="newProdRate" style="flex:1 1 100px;">
      <button class="green" onclick="addNewProduct()">Save</button>
      <button class="red" onclick="hideAddProductForm()">Cancel</button>
    </div>

    <!-- ===== SEARCH ===== -->
    <h3>Search Products</h3>
    <hr>
    <input
      id="productSearch"
      placeholder="Search by Barcode / Item No / Description"
      oninput="advancedProductSearch()"
      style="width:100%; padding:8px; margin-bottom:15px;"
    >
  </div>

  <!-- ===== PRODUCTS TABLE ===== -->
  <div class="card">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Barcode</th>
          <th>Item No</th>
          <th>Description</th>
          <th>Rate</th>
          <th>Stock</th>
          <th>Edit</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody id="productRows"></tbody>
    </table>

    <!-- Pagination -->
    <div style="margin-top:10px; display:flex; gap:10px;">
      <button onclick="prevProdPage()">Prev</button>
      <button onclick="nextProdPage()">Next</button>
    </div>
  </div>
</section>

<script>
let prodPage = 1;
let prodPerPage = 100;
let prodFiltered = [];

/* ===== SHOW / HIDE FORM ===== */
function showAddProductForm(){
  document.getElementById("newProductForm").style.display="flex";
}
function hideAddProductForm(){
  document.getElementById("newProductForm").style.display="none";
}

/* ===== RENDER ===== */
function renderProducts(){
  const tbody = document.getElementById("productRows");
  tbody.innerHTML = "";

  const start = (prodPage - 1) * prodPerPage;
  const page = prodFiltered.slice(start, start + prodPerPage);

  page.forEach((p, i) => {
    tbody.innerHTML += `
      <tr>
        <td>${start + i + 1}</td>
        <td>${p.barcode || ""}</td>
        <td>${p.itemNo}</td>
        <td>${p.desc}</td>
        <td>${p.rate}</td>
        <td>${p.stock || 0}</td>
        <td><button class="blue" onclick="editProduct('${p.id}')">Edit</button></td>
        <td><button class="red" onclick="deleteProduct('${p.id}')">Delete</button></td>
      </tr>
    `;
  });
}

/* ===== ADVANCED REALTIME SEARCH (ALL DATA) ===== */
function advancedProductSearch(){
  const q = document.getElementById("productSearch").value.trim().toLowerCase();

  prodFiltered = DB.products.filter(p => {
    const barcode = (p.barcode ?? "").toString().toLowerCase();
    const itemNo  = (p.itemNo  ?? "").toString().toLowerCase();
    const desc    = (p.desc    ?? "").toString().toLowerCase();

    return (
      barcode.includes(q) ||
      itemNo.includes(q) ||
      desc.includes(q)
    );
  });

  prodPage = 1;
  renderProducts();
}

/* ===== ADD ===== */
function addNewProduct(){
  const barcode = newProdBarcode.value.trim();
  const itemNo = newProdItemNo.value.trim();
  const desc = newProdDesc.value.trim();
  const rate = +newProdRate.value;

  if(!itemNo || !desc || !rate) return alert("Fill all fields");

  DB.products.push({
    id: uid("P"),
    barcode,
    itemNo,
    desc,
    rate,
    stock: 0
  });

  saveDB();
  prodFiltered = DB.products;
  renderProducts();
  hideAddProductForm();

  newProdBarcode.value="";
  newProdItemNo.value="";
  newProdDesc.value="";
  newProdRate.value="";
}

/* ===== EDIT ===== */
function editProduct(id){
  const p = DB.products.find(x=>x.id===id);
  if(!p) return;

  const barcode = prompt("Barcode", p.barcode);
  const itemNo = prompt("Item No", p.itemNo);
  const desc = prompt("Description", p.desc);
  const rate = prompt("Rate", p.rate);

  if(itemNo && desc && rate){
    p.barcode = barcode || "";
    p.itemNo = itemNo;
    p.desc = desc;
    p.rate = +rate;
    saveDB();
    renderProducts();
  }
}

/* ===== DELETE ===== */
function deleteProduct(id){
  const p = DB.products.find(x=>x.id===id);
  if(!p) return;
  if(p.stock !== 0) return alert("Stock exists");

  if(confirm("Delete product?")){
    DB.products = DB.products.filter(x=>x.id!==id);
    saveDB();
    prodFiltered = DB.products;
    renderProducts();
  }
}

/* ===== PAGINATION ===== */
function nextProdPage(){
  if(prodPage * prodPerPage < prodFiltered.length){
    prodPage++;
    renderProducts();
  }
}
function prevProdPage(){
  if(prodPage > 1){
    prodPage--;
    renderProducts();
  }
}

/* ===== UPLOAD EXCEL ===== */
function uploadProductExcel(input){
  const reader = new FileReader();
  reader.onload = e => {
    const wb = XLSX.read(e.target.result, {type:"binary"});
    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    rows.forEach(r=>{
      DB.products.push({
        id: uid("P"),
        barcode: r.Barcode || "",
        itemNo: r["Item No"] || "",
        desc: r.Description || "",
        rate: +r["Retail Rate"] || 0,
        stock:0
      });
    });
    saveDB();
    prodFiltered = DB.products;
    renderProducts();
    alert("Products imported");
  };
  reader.readAsBinaryString(input.files[0]);
}

/* ===== EXPORT CSV ===== */
function exportProductsCSV(){
  let csv = "Barcode,Item No,Description,Rate,Stock\n";
  DB.products.forEach(p=>{
    csv += `"${p.barcode}","${p.itemNo}","${p.desc}",${p.rate},${p.stock}\n`;
  });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv], {type:"text/csv"}));
  a.download = "products.csv";
  a.click();
}

/* ===== INIT ===== */
prodFiltered = DB.products;
renderProducts();
</script>
<!-- ================= VENDORS ================= -->
<section id="vendors">
  <div class="card">
    <h2>Vendors</h2>
    <input placeholder="Vendor Name" id="vendorName">
    <button onclick="addVendor()">Add Vendor</button>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Name & Balance</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="vendorRows"></tbody>
    </table>
  </div>
</section>

<script>
/* ================= VENDOR LOGIC ================= */

function renderVendors(){
  const tbody = document.getElementById("vendorRows");
  tbody.innerHTML = "";

  DB.vendors.forEach((v, idx) => {

    const purchaseTotal = DB.purchases
      .filter(p => p.vendorId === v.id)
      .reduce((s, p) => s + (p.total || 0), 0);

    const paymentTotal = DB.cash
      .filter(c => c.vendorId === v.id && c.type === "OUT")
      .reduce((s, c) => s + c.amount, 0);

    const balance = purchaseTotal - paymentTotal;

    tbody.innerHTML += `
      <tr>
        <td>${idx + 1}</td>
        <td>
          <span style="cursor:pointer;color:#1f6feb;text-decoration:underline"
                onclick="showVendorLedger('${v.id}')">
            ${v.name}
          </span>
          <br>
          <small>Balance: ₨ ${balance.toFixed(2)}</small>
        </td>
        <td>
          <button onclick="editVendor('${v.id}')">Edit</button>
          <button onclick="deleteVendor('${v.id}')">Delete</button>
        </td>
      </tr>
    `;
  });
}

function addVendor(){
  const name = vendorName.value.trim();
  if(!name) return alert("Enter vendor name");

  DB.vendors.push({ id: uid("V"), name });
  saveDB();
  vendorName.value = "";
  renderVendors();
}

function editVendor(id){
  const v = DB.vendors.find(x => x.id === id);
  const n = prompt("Edit vendor name", v.name);
  if(n){
    v.name = n.trim();
    saveDB();
    renderVendors();
  }
}

function deleteVendor(id){
  const purchaseTotal = DB.purchases
    .filter(p => p.vendorId === id)
    .reduce((s,p)=>s+(p.total||0),0);

  const paymentTotal = DB.cash
    .filter(c => c.vendorId === id && c.type === "OUT")
    .reduce((s,c)=>s+c.amount,0);

  if(purchaseTotal - paymentTotal !== 0)
    return alert("Cannot delete vendor with balance");

  if(confirm("Delete this vendor?")){
    DB.vendors = DB.vendors.filter(v => v.id !== id);
    saveDB();
    renderVendors();
  }
}

/* ================= LEDGER PAGE ================= */

function showVendorLedger(vendorId){
  const vendor = DB.vendors.find(v => v.id === vendorId);
  if(!vendor) return;

  const rows = [];
  let balance = 0;

  DB.purchases
    .filter(p => p.vendorId === vendorId)
    .forEach(p => rows.push({
      date: p.date,
      type: "Purchase",
      ref: p.id,
      debit: p.total,
      credit: 0
    }));

  DB.cash
    .filter(c => c.vendorId === vendorId && c.type === "OUT")
    .forEach(c => rows.push({
      date: c.date,
      type: "Payment",
      ref: c.ref || c.id,
      debit: 0,
      credit: c.amount
    }));

  rows.sort((a,b)=>new Date(a.date)-new Date(b.date));

  const win = window.open("", "_blank");
  win.document.write(`
<!DOCTYPE html>
<html>
<head>
<title>Vendor Ledger - ${vendor.name}</title>
<style>
body{font-family:Segoe UI,Arial;padding:30px}
table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{border:1px solid #d0d7de;padding:8px;text-align:center}
th{background:#f6f8fa}
.right{text-align:right}
button{margin-right:10px;padding:6px 12px}
.link{color:#1f6feb;cursor:pointer;text-decoration:underline}
</style>
</head>
<body>

<h2>Vendor Ledger</h2>
<h3>${vendor.name}</h3>

<button onclick="window.print()">Print</button>
<button onclick="downloadCSV()">Download CSV</button>

<table>
<thead>
<tr>
<th>Date</th>
<th>Type</th>
<th>Reference</th>
<th>Debit</th>
<th>Credit</th>
<th>Balance</th>
</tr>
</thead>
<tbody id="ledgerRows"></tbody>
</table>

<script>
const data = ${JSON.stringify(rows)};
let balance = 0;
let csv = "Date,Type,Reference,Debit,Credit,Balance\\n";
const tbody = document.getElementById("ledgerRows");

data.forEach(r=>{
  balance += r.debit - r.credit;
  csv += r.date+","+r.type+","+r.ref+","+r.debit+","+r.credit+","+balance+"\\n";

  const tr = document.createElement("tr");
  tr.innerHTML = \`
    <td>\${r.date}</td>
    <td>\${r.type}</td>
    <td class="link" onclick="window.open(location.pathname+'?ref='+ '\${r.ref}','_blank')">\${r.ref}</td>
    <td class="right">\${r.debit.toFixed(2)}</td>
    <td class="right">\${r.credit.toFixed(2)}</td>
    <td class="right">\${balance.toFixed(2)}</td>
  \`;
  tbody.appendChild(tr);
});

function downloadCSV(){
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="vendor_ledger_${vendor.name.replace(/\s+/g,"_")}.csv";
  a.click();
}
<\/script>

</body>
</html>
`);
}

renderVendors();
</script>

<!-- ================= PURCHASE ================= -->

<style>
#purchase{width:100%;min-height:100vh;padding:30px}
#purchase h3{color:var(--primary);margin:20px 0}
.p-block{border:1px solid var(--border);padding:20px;margin-bottom:30px;border-radius:12px}
.p-table{width:100%;border-collapse:collapse}
.p-table th{background:#f4f6fb;color:var(--primary);text-align:left;font-weight:600}
.p-table td,.p-table th{padding:12px;border:1px solid var(--border)}
.suggest-box{position:absolute;background:#fff;border:1px solid var(--border);z-index:999;width:100%}
.suggest-box div{padding:8px;cursor:pointer}
.suggest-box .active,.suggest-box div:hover{background:#e8edf6}
.filter-row select{margin-right:10px}
</style>

<section id="purchase">

<h3>Purchase</h3>

<!-- ===== VENDOR ===== -->
<div class="p-block">
<label>Vendor</label>
<select id="purchaseVendor" style="width:100%"></select>
</div>

<!-- ===== EXCEL ===== -->
<div class="p-block">
<label>Upload Excel</label>
<input type="file" accept=".xls,.xlsx" onchange="uploadPurchaseExcel(this)">
</div>

<!-- ===== ENTRY TABLE ===== -->
<div class="p-block">
<table class="p-table">
<thead>
<tr>
<th>Barcode</th>
<th>Item No</th>
<th>Description</th>
<th>Stock</th>
<th>Qty</th>
<th>Cost</th>
<th>Total</th>
<th></th>
</tr>
</thead>
<tbody id="purchaseRows"></tbody>
</table>

<button onclick="addPurchaseRow()">Add New Product</button>

<h3>Total: ₨ <span id="purchaseTotal">0.00</span></h3>
<button onclick="savePurchase()">Save Purchase</button>
</div>

<!-- ================= PREVIOUS PURCHASE ================= -->

<div class="p-block">
<h3>Previous Purchases</h3>

<div class="filter-row">
<select id="filterVendor" onchange="renderPurchaseHistory()"></select>
<select id="filterPeriod" onchange="renderPurchaseHistory()">
<option value="all">All Time</option>
<option value="day">Today</option>
<option value="week">This Week</option>
<option value="month">This Month</option>
<option value="year">This Year</option>
</select>
</div>

<table class="p-table">
<thead>
<tr>
<th>Date</th>
<th>Vendor</th>
<th>Amount</th>
<th>Edit</th>
<th>Delete</th>
</tr>
</thead>
<tbody id="purchaseHistory"></tbody>
</table>

<div style="margin-top:15px">
<button onclick="prevPurchasePage()">◀</button>
<span id="purchasePageInfo"></span>
<button onclick="nextPurchasePage()">▶</button>
</div>
</div>

</section>

<script>
let purchaseDraft=[];
let purchasePage=1;
const PER_PAGE=20;

/* ===== LOAD VENDORS ===== */
function loadPurchaseVendors(){
  purchaseVendor.innerHTML='<option value="">Select Vendor</option>';
  filterVendor.innerHTML='<option value="">All Vendors</option>';
  DB.vendors.forEach(v=>{
    purchaseVendor.innerHTML+=`<option value="${v.id}">${v.name}</option>`;
    filterVendor.innerHTML+=`<option value="${v.id}">${v.name}</option>`;
  });
}

/* ===== ADD ROW ===== */
function addPurchaseRow(){
  purchaseDraft.push({productId:null,barcode:"",itemNo:"",desc:"",qty:1,cost:0});
  renderPurchaseRows();
}

/* ===== RENDER ROW ===== */
function renderPurchaseRows(){
  purchaseRows.innerHTML="";
  let grand=0;

  purchaseDraft.forEach((r,i)=>{
    const p=DB.products.find(x=>x.id===r.productId);
    const stock=p?p.stock:0;
    const total=r.qty*r.cost;
    grand+=total;

    purchaseRows.innerHTML+=`
<tr>
<td><input value="${r.barcode}" oninput="searchProduct(this,${i})"></td>
<td><input value="${r.itemNo}" oninput="searchProduct(this,${i})"></td>
<td><input value="${r.desc}" oninput="searchProduct(this,${i})"></td>
<td>${stock}</td>
<td><input type="number" value="${r.qty}" onchange="setQty(${i},this.value)"></td>
<td><input type="number" value="${r.cost}" onchange="setCost(${i},this.value)" onkeydown="costTab(event,${i})"></td>
<td>${total.toLocaleString(undefined,{minimumFractionDigits:2})}</td>
<td><button onclick="removeRow(${i})">X</button></td>
</tr>`;
  });

  purchaseTotal.innerText=grand.toLocaleString(undefined,{minimumFractionDigits:2});
}

/* ===== SEARCH ===== */
function searchProduct(inp,i){
  closeSuggest();
  if(!inp.value)return;

  const list=DB.products.filter(p=>
    p.barcode.includes(inp.value)||
    p.itemNo.includes(inp.value)||
    p.desc.toLowerCase().includes(inp.value.toLowerCase())
  ).slice(0,5);

  if(!list.length)return;

  const box=document.createElement("div");
  box.className="suggest-box";
  inp.parentNode.style.position="relative";
  inp.parentNode.appendChild(box);

  list.forEach(p=>{
    const d=document.createElement("div");
    d.innerText=`${p.barcode} | ${p.itemNo} | ${p.desc}`;
    d.onclick=()=>selectProduct(i,p);
    box.appendChild(d);
  });
}

function selectProduct(i,p){
  Object.assign(purchaseDraft[i],{
    productId:p.id,
    barcode:p.barcode,
    itemNo:p.itemNo,
    desc:p.desc
  });
  renderPurchaseRows();
}

document.addEventListener("click",()=>document.querySelectorAll(".suggest-box").forEach(x=>x.remove()));

/* ===== UTILS ===== */
function setQty(i,v){purchaseDraft[i].qty=+v||0;renderPurchaseRows()}
function setCost(i,v){purchaseDraft[i].cost=+v||0;renderPurchaseRows()}
function removeRow(i){purchaseDraft.splice(i,1);renderPurchaseRows()}
function costTab(e,i){if(e.key==="Tab"){e.preventDefault();if(i===purchaseDraft.length-1)addPurchaseRow()}}

/* ===== SAVE ===== */
function savePurchase(){
  if(!purchaseVendor.value)return alert("Select vendor");
  let total=0;

  purchaseDraft.forEach(r=>{
    if(!r.productId)return;
    const p=DB.products.find(x=>x.id===r.productId);
    p.stock+=r.qty;
    total+=r.qty*r.cost;
  });

  DB.purchases.push({
    id:uid("PUR"),
    vendorId:purchaseVendor.value,
    date:new Date().toISOString().slice(0,10),
    items:JSON.parse(JSON.stringify(purchaseDraft)),
    total
  });

  saveDB();
  purchaseDraft=[];
  addPurchaseRow();
  renderPurchaseHistory();
}

/* ===== HISTORY ===== */
function renderPurchaseHistory(){
  purchaseHistory.innerHTML="";
  let list=DB.purchases.filter(p=>{
    if(filterVendor.value && p.vendorId!==filterVendor.value)return false;
    return true;
  }).reverse();

  const pages=Math.ceil(list.length/PER_PAGE);
  if(purchasePage>pages)purchasePage=pages||1;

  list.slice((purchasePage-1)*PER_PAGE,purchasePage*PER_PAGE).forEach(p=>{
    const v=DB.vendors.find(x=>x.id===p.vendorId);
    purchaseHistory.innerHTML+=`
<tr>
<td>${p.date}</td>
<td>${v?v.name:""}</td>
<td>${p.total.toLocaleString(undefined,{minimumFractionDigits:2})}</td>
<td><button onclick="editPurchase('${p.id}')">Edit</button></td>
<td><button onclick="deletePurchase('${p.id}')">X</button></td>
</tr>`;
  });

  purchasePageInfo.innerText=`Page ${purchasePage} / ${pages||1}`;
}

function editPurchase(id){
  const p=DB.purchases.find(x=>x.id===id);
  if(!p)return;
  purchaseVendor.value=p.vendorId;
  purchaseDraft=JSON.parse(JSON.stringify(p.items));
  renderPurchaseRows();
}

function deletePurchase(id){
  const p=DB.purchases.find(x=>x.id===id);
  if(!p||p.items.length)return alert("Cannot delete purchase with products");
  DB.purchases=DB.purchases.filter(x=>x.id!==id);
  saveDB();
  renderPurchaseHistory();
}

/* ===== EXCEL ===== */
function uploadPurchaseExcel(input){
  const r=new FileReader();
  r.onload=e=>{
    const wb=XLSX.read(e.target.result,{type:"binary"});
    XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]).forEach(row=>{
      const p=DB.products.find(x=>x.barcode==row.Barcode||x.itemNo==row["Item No"]||x.desc==row.Description);
      if(!p)return;
      purchaseDraft.push({productId:p.id,barcode:p.barcode,itemNo:p.itemNo,desc:p.desc,qty:+row.Qty||0,cost:+row.Cost||0});
    });
    renderPurchaseRows();
  };
  r.readAsBinaryString(input.files[0]);
}

/* ===== INIT ===== */
loadPurchaseVendors();
addPurchaseRow();
renderPurchaseHistory();
</script>


<!-- ================= REPORTS ================= -->
<section id="reports">
  <div class="card">
    <h2>Reports</h2>
    <button onclick="generateReport()">Generate</button>
    <pre id="reportOutput"></pre>
  </div>
</section>

<script>
function generateReport(){ document.getElementById("reportOutput").innerText=JSON.stringify(DB,null,2);}
</script>

<!-- ================= SETTINGS ================= -->
<section id="settings">
  <div class="card">
    <h2>Admin Settings</h2>

    <h3>Software Name</h3>
    <input id="setSoftwareName" placeholder="Enter software name">
    <button class="blue" onclick="saveSoftwareName()">Save Name</button>

    <hr>

    <h3>Upload Logo</h3>
    <input type="file" accept="image/*" onchange="uploadLogo(this)">
    <p style="font-size:13px;opacity:0.7">Logo will appear in header</p>

    <hr>

    <h3>Backup & Restore</h3>
    <button class="green" onclick="downloadBackup()">Download Backup</button>
    <br><br>
    <input type="file" accept=".json" onchange="restoreBackup(this)">

    <hr>

    <h3 style="color:#cf222e">Danger Zone</h3>
    <button class="red" onclick="resetSystem()">RESET COMPLETE SOFTWARE</button>
  </div>
</section>

<script>
/* ================= SETTINGS LOGIC ================= */

function applySettings(){
  if(!DB.settings) DB.settings = {};

  const name = DB.settings.softwareName || "Dani Test Software";

  /* Header text */
  document.getElementById("softwareName").innerText = name;
  document.getElementById("setSoftwareName").value = name;

  /* Browser tab title */
  document.title = name;

  /* Logo */
  if(DB.settings.logo){
    const img = document.getElementById("header-logo");
    img.src = DB.settings.logo;
    img.style.display = "block";
  }
}
document.addEventListener("DOMContentLoaded", applySettings);

/* ===== SAVE SOFTWARE NAME ===== */
function saveSoftwareName(){
  if(!DB.settings) DB.settings = {};

  const name =
    document.getElementById("setSoftwareName").value.trim() ||
    "Dani Test Software";

  DB.settings.softwareName = name;
  saveDB();
  applySettings();
  alert("Software name updated");
}

/* ===== UPLOAD LOGO ===== */
function uploadLogo(input){
  const file = input.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    if(!DB.settings) DB.settings = {};
    DB.settings.logo = e.target.result;
    saveDB();
    applySettings();
  };
  reader.readAsDataURL(file);
}

/* ===== DOWNLOAD BACKUP ===== */
function downloadBackup(){
  const blob = new Blob([JSON.stringify(DB,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "dani_backup_"+Date.now()+".json";
  a.click();
}

/* ===== RESTORE BACKUP ===== */
function restoreBackup(input){
  const file = input.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    try{
      DB = JSON.parse(e.target.result);
      saveDB();
      location.reload();
    }catch{
      alert("Invalid backup file");
    }
  };
  reader.readAsText(file);
}

/* ===== RESET SYSTEM (AUTO BACKUP) ===== */
function resetSystem(){
  if(!confirm("Backup will be downloaded automatically. Continue reset?")) return;

  downloadBackup();

  DB = {
    products: [],
    vendors: [],
    purchases: [],
    invoices: [],
    cash: [],
    deleted: [],
    settings: {
      softwareName: "Dani Test Software",
      logo: ""
    }
  };

  saveDB();
  location.reload();
}

/* ================= MENU ================= */

function openTab(id){
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  const sec = document.getElementById(id);
  if(sec) sec.classList.add("active");

  document.querySelectorAll("nav div").forEach(d=>d.classList.remove("active"));
  const tab = document.getElementById("tab-"+id);
  if(tab) tab.classList.add("active");
}

/* DEFAULT OPEN */
document.addEventListener("DOMContentLoaded", () => {
  openTab("invoice");
});

/* ================= DATE & TIME ================= */

function updateTime(){
  const now = new Date();
  const el = document.getElementById("dateTime");
  if(el) el.innerText = now.toLocaleString();
}
setInterval(updateTime,1000);
updateTime();
</script>

</body>
</html>
