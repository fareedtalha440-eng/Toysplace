<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dani Test Software</title>

<!-- ====== XLSX LIBRARY ====== -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{
  --primary:#0b1c2d;     /* Deep Dark Blue */
  --secondary:#ffffff;  /* White */
  --accent:#1f6feb;
  --border:#d0d7de;
}

/* ===== BODY ===== */
body{
  margin:0;
  font-family:Segoe UI, Arial;
  background:white;
  color:#0b1c2d;
}

/* ===== HEADER ===== */
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:var(--primary);
  color:white;
  padding:14px 22px;
  font-size:22px;
  font-weight:600;
}

#header-left{
  display:flex;
  align-items:center;
  gap:12px;
}

#header-logo{
  height:40px;
  max-height:60px;
  width:auto;
  display:none;
}

#dateTime{
  font-size:14px;
  opacity:0.85;
}

/* ===== NAV ===== */
nav{
  display:flex;
  background:#f6f8fa;
  border-bottom:1px solid var(--border);
}

nav div{
  padding:14px 20px;
  cursor:pointer;
  transition:0.25s;
  border-bottom:3px solid transparent;
  font-weight:500;
}

nav div:hover{
  background:#eef2f7;
}

nav div.active{
  border-bottom:3px solid var(--accent);
  color:var(--accent);
  font-weight:600;
  transform:translateY(-1px);
}

/* ===== SECTION ===== */
section{
  display:none;
  padding:20px;
}

section.active{
  display:block;
  animation:fadeIn 0.25s ease-in;
}

@keyframes fadeIn{
  from{opacity:0; transform:translateY(4px);}
  to{opacity:1; transform:none;}
}

/* ===== CARD ===== */
.card{
  background:#fff;
  border:1px solid #d0d7de;
  padding:22px;
  margin-bottom:25px;
  border-radius:12px;
  box-shadow:0 2px 8px rgba(0,0,0,0.04);
}
/* ===== TABLE ===== */
table{
  width:100%;
  border-collapse:collapse;
  background:white;
}

th{
  background:#f6f8fa;
  font-weight:700;
}

th,td{
  border:1px solid #e1e4e8;
  padding:10px;
  text-align:center;
}
.r-filter{display:flex;gap:10px;margin:15px 0}
.r-table{width:100%;border-collapse:collapse}
.r-table th,.r-table td{border:1px solid #ddd;padding:8px}
.r-table tr:hover{background:#f6f8fb;cursor:pointer}
.profit-pos{color:green;font-weight:600}
.profit-neg{color:red;font-weight:600}

/* ===== INPUT ===== */
input,select{
  padding:7px;
  border-radius:6px;
  border:1px solid var(--border);
  width:100%;
}

button{
  padding:8px 14px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:600;
}

.green{background:#2da44e;color:white;}
.red{background:#cf222e;color:white;}
.blue{background:var(--accent);color:white;}
</style>
</head>
<body>
<header>
  <div id="header-left" style="display:flex;align-items:center;gap:10px">
    <img id="header-logo" style="height:40px;display:none">
    <span id="softwareName"></span>
  </div>
  <div id="dateTime"></div>
</header>
<!-- ================= TOP MENU ================= -->
<nav id="mainMenu">
  <div id="tab-invoice" class="menuItem" onclick="openTab('invoice')">Invoice</div>
  <div id="tab-products" class="menuItem" onclick="openTab('products')">Products</div>
  <div id="tab-vendors" class="menuItem" onclick="openTab('vendors')">Vendors</div>
  <div id="tab-purchase" class="menuItem" onclick="openTab('purchase')">Purchase</div>
  <div id="tab-returns" class="menuItem" onclick="openTab('returns')">Return</div>
  <div id="tab-cash" class="menuItem" onclick="openTab('cash')">Cash In Hand</div>
  <div id="tab-reports" class="menuItem" onclick="openTab('reports')">Reports</div>
  <div id="tab-settings" class="menuItem" onclick="openTab('settings')">Settings</div>
</nav>

<style>
/* ================= MAIN MENU (FINAL FIX) ================= */
#mainMenu{
  display:flex;
  align-items:center;
  gap:14px;
  padding:8px 16px;
  background:#fff;
  border-bottom:2px solid #ccc;
  position:sticky;
  top:0;
  z-index:100;
}

#mainMenu .menuItem{
  padding:6px 14px;
  font-weight:600;
  cursor:pointer;
  border-radius:6px;
  user-select:none;
  white-space:nowrap;
}

#mainMenu .menuItem:hover{
  background:#eef2f7;
}

#mainMenu .menuItem.active{
  background:#eef2f7;
  color:var(--primary,#1e1e1e);
}
/* ================= RETURN UI ================= */
#return{
  padding:20px;
  animation:fadeIn .25s ease;
  min-height:auto;
}

.ret-box{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:10px;
  margin-bottom:20px;
}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(6px)}
  to{opacity:1;transform:none}
}

</style>

<script>
/* ================= TAB SWITCHING (FIXED) ================= */
function openTab(id){

  const session = sessionStorage.getItem("loggedInUser");
  if(!session){
    alert("Please login first");
    return;
  }

  const user = JSON.parse(session);

  // If not developer check permission
 if(user.role !== "developer"){

if(id==="reports"){
if(!(user.permissions||[]).includes("normalReports")) return alert("Access denied");
}

if(id==="settings"){
if(!(user.permissions||[]).includes("settings")) return alert("Access denied");
}

if(!["reports","settings"].includes(id) && !(user.permissions||[]).includes(id)){
return alert("Access denied");
}

}
  // Hide all sections
  document.querySelectorAll("section").forEach(sec=>{
    sec.style.display = "none";
    sec.classList.remove("active");
  });

  // Remove active from all menu items
  document.querySelectorAll("#mainMenu .menuItem").forEach(tab=>{
    tab.classList.remove("active");
  });

  // Show selected section
  const selectedSection = document.getElementById(id);
  if(selectedSection){
    selectedSection.style.display = "block";
    selectedSection.classList.add("active");
  }

  // Activate clicked tab
  const activeTab = document.getElementById("tab-" + id);
  if(activeTab){
    activeTab.classList.add("active");
  }
}
/* ================= OPEN FIRST ALLOWED TAB ================= */
document.addEventListener("DOMContentLoaded", ()=>{
  const acc = sessionStorage.getItem("loggedInUser");
  if(!acc) return;

  const user = JSON.parse(acc);
  const modules = [
"invoice",
"products",
"vendors",
"purchase",
"returns",
"cash",
"normalReports",
"adminReports",
"settings"
];
  for(const t of order){
    if(user.role==="developer" || (user.permissions||[]).includes(t)){
      openTab(t);
      break;
    }
  }
  const s = DB.settings || {};

  const nameEl = document.getElementById("softwareName");
  const logoEl = document.getElementById("header-logo");

  if(nameEl){
    nameEl.textContent = s.softwareName || "";
  }

  if(logoEl && s.logo){
    logoEl.src = s.logo;
    logoEl.style.display = "block";
  }
});
</script>
<script>

  /* ===== EXPENSE CALCULATION ===== */
  (DB.expenses||[]).forEach(e=>{
    if(from && e.date<from) return;
    if(to && e.date>to) return;
    totalExpense += Number(e.amount||0);
  });

  const gross = totalSales - totalCogs;
  const net = gross - totalExpense;
  const percent = totalSales ? (net/totalSales)*100 : 0;

  pfSales.innerText = totalSales.toFixed(2);
  pfCogs.innerText = totalCogs.toFixed(2);
  pfGross.innerText = gross.toFixed(2);
  pfExpense.innerText = totalExpense.toFixed(2);
  pfNet.innerText = net.toFixed(2);
  pfPercent.innerText = percent.toFixed(2)+"%";
}
function showReport(type){
  const box = document.getElementById("reportView");
box.innerHTML="";
  const box=document.getElementById("invoiceProfitReport");
  box.style.display="block";
document.getElementById("deletedDataReport").style.display="none";
document.getElementById("productDetailsReport").style.display="none";
  box.innerHTML=`
    <h2>Invoice Wise Profit</h2>

    <div class="r-filter">
      <input type="date" id="pFrom">
      <input type="date" id="pTo">
      <select id="pUser">
        <option value="">All Users</option>
        ${DB.accounts.map(a=>`<option>${a.username}</option>`).join("")}
      </select>
      <button onclick="applyProfitReport()">Apply</button>
    </div>

    <table class="r-table">
      <thead>
        <tr>
          <th>Invoice</th>
          <th>Date</th>
          <th>User</th>
          <th>Sale</th>
          <th>Cost</th>
          <th>Profit</th>
        </tr>
      </thead>
      <tbody id="profitRows"></tbody>
    </table>
  `;
}


function alertInvoiceProfit(id){
  const inv=DB.invoices.find(x=>x.id===id);
  let msg="Invoice "+id+"\\n\\n";
  inv.items.forEach(it=>{
    const purchase=DB.purchases
      .filter(p=>p.items.some(x=>x.itemNo===it.itemNo))
      .sort((a,b)=>new Date(b.date)-new Date(a.date))[0];
    const cost=(purchase?.items.find(x=>x.itemNo===it.itemNo)?.cost||0)*it.qty;
    const sale=it.qty*it.rate;
    msg+=`${it.itemNo} Profit: ${(sale-cost).toFixed(2)}\\n`;
  });
  alert(msg);
}
</script>

<!-- ================= DATABASE ================= -->
<script>
let DB = {
  products: JSON.parse(localStorage.getItem("products") || "[]"),
  vendors: JSON.parse(localStorage.getItem("vendors") || "[]"),
  purchases: JSON.parse(localStorage.getItem("purchases") || "[]"),
  returns: JSON.parse(localStorage.getItem("returns") || "[]"),
  invoices: JSON.parse(localStorage.getItem("invoices") || "[]"),
  cash: JSON.parse(localStorage.getItem("cash") || "[]"),
  deleted: JSON.parse(localStorage.getItem("deleted") || "[]"),
  settings: JSON.parse(localStorage.getItem("settings") || "{}"),
  accounts: JSON.parse(localStorage.getItem("accounts") || "[]")  // Added accounts
};

// Initialize default developer account if not exists
if(!DB.accounts.find(x=>x.fixed)) {
  DB.accounts.push({id: uid("A"), username:"Dani", password:"7525", role:"developer", fixed:true, permissions:[]});
  saveDB();
}

function saveDB() { 
  for(let k in DB){ 
    localStorage.setItem(k, JSON.stringify(DB[k])); 
  } 
}

function uid(prefix){ 
  return prefix + "_" + Date.now() + Math.floor(Math.random()*1000); 
}
function openDeletedDataReport(){
  document.getElementById("invoiceProfitReport").style.display="none";
document.getElementById("productDetailsReport").style.display="none";
  document.getElementById("invoiceProfitReport").style.display="none";
  const box=document.getElementById("deletedDataReport");
  box.style.display="block";

  box.innerHTML=`
    <h2>Deleted Data Report</h2>
    <table class="r-table">
      <thead>
        <tr>
          <th>Type</th>
          <th>Reference</th>
          <th>User</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody>
        ${DB.deleted.map(d=>`
          <tr>
            <td>${d.type}</td>
            <td>${d.ref}</td>
            <td>${d.user}</td>
            <td>${new Date(d.dateTime).toLocaleString()}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
}
function openProductDetailsReport(){
document.getElementById("invoiceProfitReport").style.display="none";
document.getElementById("deletedDataReport").style.display="none";
document.getElementById("productDetailsReport").style.display="block";


  const box=document.getElementById("productDetailsReport");
  box.innerHTML=`
  <h2>Product Details Report</h2>

  <div style="display:flex;gap:10px;flex-wrap:wrap;margin:15px 0">

    <select id="pdProduct"></select>

    <select id="pdVendor">
      <option value="">All Vendors</option>
    </select>

    <input type="date" id="pdFrom">
    <input type="date" id="pdTo">

    <button onclick="generateProductDetails()">Generate</button>

  </div>

  <table class="r-table">
    <thead>
      <tr>
        <th>S#</th>
        <th>Date</th>
        <th>Ref</th>
        <th>Name</th>
        <th>In</th>
        <th>Out</th>
        <th>Rate</th>
        <th>Amount</th>
        <th>Balance</th>
      </tr>
    </thead>
    <tbody id="pdRows"></tbody>
  </table>
  `;

  loadPDFilters();
}

</script>
<script>
/* ================= RULE ENGINE ================= */
const RULES = {
  qtyIntegerOnly: true,
  noDuplicateInvoiceProduct: true,
  noDuplicatePurchaseProduct: true,
  uniqueItemNo: true,
  uniqueBarcode: true,
  uniqueVendorName: true,
  auditLog: true
};

/* ===== GLOBAL MESSAGE (CENTER SCREEN) ===== */
function ruleMessage(msg){
  let box = document.getElementById("ruleMsgBox");
  if(!box){
    box = document.createElement("div");
    box.id = "ruleMsgBox";
    box.style = `
      position:fixed; top:50%; left:50%;
      transform:translate(-50%,-50%);
      background:#111; color:#fff;
      padding:18px 26px;
      border-radius:10px;
      font-size:16px;
      z-index:99999;
      box-shadow:0 0 20px rgba(0,0,0,.4)
    `;
    document.body.appendChild(box);
  }
  box.innerText = msg;
  box.style.display="block";
  setTimeout(()=>box.style.display="none",2500);
}

/* ===== AUDIT LOG ===== */
function logAction(action, ref=""){
  if(!RULES.auditLog) return;
   const session = sessionStorage.getItem("loggedInUser");
  if(!session){
    window.location.href = "login.html";
    return;
  }

  const user = JSON.parse(session);
  DB.logs = DB.logs || [];
  DB.logs.push({
    user: user.username || "unknown",
    role: user.role || "",
    action,
    ref,
    dateTime: new Date().toISOString()
  });
  saveDB();
}
</script>
  <script>

document.addEventListener("DOMContentLoaded",()=>{

  window.vrVendor = document.getElementById("vrVendor");
  window.vrBody = document.getElementById("vrBody");
  window.vrTotal = document.getElementById("vrTotal");
  window.vrNo = document.getElementById("vrNo");
  window.vrPrev = document.getElementById("vrPrev");

  vrLoadVendors();
  vrGenerateNo();
  vrLoadPrevious();
});
function loadPDFilters(){
  const pSel=document.getElementById("pdProduct");
  const vSel=document.getElementById("pdVendor");

  if(!pSel) return;

  pSel.innerHTML='<option value="">Select Product</option>';
  DB.products.forEach(p=>{
    pSel.innerHTML+=`<option value="${p.id}">${p.itemNo} - ${p.desc}</option>`;
  });

  vSel.innerHTML='<option value="">All Vendors</option>';
  DB.vendors.forEach(v=>{
    vSel.innerHTML+=`<option value="${v.name}">${v.name}</option>`;
  });
}

function generateProductDetails(){
 const pid=document.getElementById("pdProduct").value;
  if(!pid) return alert("Select product");

 const vendor=document.getElementById("pdVendor").value;
 const from=document.getElementById("pdFrom").value;
  const to=document.getElementById("pdTo").value;

  const product=DB.products.find(p=>p.id===pid);
  if(!product) return;

  let rows=[];
  let balance=0;

  DB.purchases.forEach(p=>{
    const item=p.items.find(i=>i.itemNo===product.itemNo);
    if(!item) return;
    if(vendor && p.vendor!==vendor) return;

    const d=new Date(p.date||p.dateTime);
    if(from && d<new Date(from)) return;
    if(to && d>new Date(to+"T23:59:59")) return;

    balance+=item.qty;

    rows.push({
      date:d,
      ref:p.no||"PUR",
      name:p.vendor,
      in:item.qty,
      out:0,
      rate:item.cost,
      amount:item.qty*item.cost,
      bal:balance
    });
  });

  DB.invoices.forEach(inv=>{
    const item=inv.items.find(i=>i.productId===pid);
    if(!item) return;

    const d=new Date(inv.dateTime);
    if(from && d<new Date(from)) return;
    if(to && d>new Date(to+"T23:59:59")) return;

    balance-=item.qty;

    rows.push({
      date:d,
      ref:inv.id,
      name:"Cash Customer",
      in:0,
      out:item.qty,
      rate:item.rate,
      amount:item.qty*item.rate,
      bal:balance
    });
  });

  DB.returns.forEach(r=>{
    const item=r.items.find(i=>i.itemNo===product.itemNo);
    if(!item) return;
    if(vendor && r.vendor!==vendor) return;

    const d=new Date(r.dateTime);
    if(from && d<new Date(from)) return;
    if(to && d>new Date(to+"T23:59:59")) return;

    balance-=item.qty;

    rows.push({
      date:d,
      ref:r.no,
      name:r.vendor,
      in:0,
      out:item.qty,
      rate:item.cost,
      amount:item.qty*item.cost,
      bal:balance
    });
  });

  rows.sort((a,b)=>a.date-b.date);

  const tbody = document.getElementById("pdRows");
tbody.innerHTML="";
  rows.forEach((r,i)=>{
    tbody.innerHTML+=`
    <tr>
    <td>${i+1}</td>
    <td>${r.date.toLocaleDateString()}</td>
    <td>${r.ref}</td>
    <td>${r.name}</td>
    <td>${r.in||""}</td>
    <td>${r.out||""}</td>
    <td>${r.rate}</td>
    <td>${r.amount.toFixed(2)}</td>
    <td>${r.bal}</td>
    </tr>`;
  });

  calculateFastestProducts();
}

function calculateFastestProducts(){
  const sales={};

  DB.invoices.forEach(inv=>{
    inv.items.forEach(i=>{
      sales[i.productId]=(sales[i.productId]||0)+i.qty;
    });
  });

  DB.fastestRanking=Object.entries(sales)
    .sort((a,b)=>b[1]-a[1])
    .map((x,i)=>({productId:x[0],rank:i+1,qty:x[1]}));

  saveDB();
}

</script>
<!-- ================= VENDOR RETURN (ULTRA FINAL) ================= -->
<section id="returns" style="display:none;padding:30px">

<h2 style="font-size:28px;font-weight:900">Vendor Return</h2>

<div style="display:flex;gap:40px;align-items:end;margin-bottom:20px">
  <div>
    <label>Vendor</label><br>
    <select id="vrVendor"></select>
  </div>
  <div style="font-size:24px;font-weight:800">
    Return No: <span id="vrNo"></span>
  </div>
</div>

<table width="100%" border="1" cellpadding="6">
<thead>
<tr>
  <th>Barcode</th>
  <th>Item No</th>
  <th>Description</th>
  <th>Stock</th>
  <th>Qty</th>
  <th>Cost</th>
  <th>Amount</th>
  <th></th>
</tr>
</thead>
<tbody id="vrBody"></tbody>
</table>

<button onclick="vrAddRow()">Add Item</button>

<h3 style="margin-top:15px">
Total Return:
<span id="vrTotal" style="font-size:22px;font-weight:900">0.00</span>
</h3>

<button onclick="vrSave()" style="margin-top:10px">Save Return</button>

<hr>

<h3>Previous Returns</h3>

<table width="100%" border="1" cellpadding="6">
<thead>
<tr>
  <th>#</th>
  <th>No</th>
  <th>Date</th>
  <th>Time</th>
  <th>Vendor</th>
  <th>Amount</th>
  <th>Print</th>
  <th>Edit</th>
  <th>Delete</th>
</tr>
</thead>
<tbody id="vrPrev"></tbody>
</table>

</section>

<script>
/* ================= HARD INIT ================= */
if(!DB.returns) DB.returns=[];
if(!DB.vendorLedger) DB.vendorLedger=[];
let vrEditIndex=null;

/* ================= DOM READY ================= */
document.addEventListener("DOMContentLoaded",()=>{
  vrLoadVendors();
  vrGenerateNo();
  vrLoadPrevious();
});

/* ================= VENDORS ================= */
function vrLoadVendors(){
  vrVendor.innerHTML='<option value="">Select Vendor</option>';
DB.vendors.forEach(v=>{
  vrVendor.innerHTML+=`<option value="${v.id}">${v.name}</option>`;
});
  DB.vendors.forEach(v=>{
    vrVendor.innerHTML+=`<option value="${v.id}">${v.name}</option>`;
  });
}

/* ================= RETURN NO ================= */
function vrGenerateNo(){
  let max=0;
  DB.returns.forEach(r=>{
    const n=parseInt((r.no||"").replace("RT",""));
    if(n>max) max=n;
  });
  vrNo.innerText="RT"+String(max+1).padStart(4,"0");
}

/* ================= ADD ROW ================= */
function vrAddRow(){
  if(!vrVendor.value){ ruleMessage("Select vendor first"); return; }

  const tr=document.createElement("tr");
  tr.innerHTML=`
<td><input onkeydown="vrKeyNav(event,this,'barcode')" oninput="vrSearch(this,'barcode')"><div class="dropdown"></div></td>
<td><input onkeydown="vrKeyNav(event,this,'item')" oninput="vrSearch(this,'item')"><div class="dropdown"></div></td>
<td><input onkeydown="vrKeyNav(event,this,'desc')" oninput="vrSearch(this,'desc')"><div class="dropdown"></div></td>
<td class="stk">0</td>
<td><input type="number" min="1" oninput="vrCalc()"></td>
<td><input type="number" min="0.01" step="0.01" oninput="vrCalc()"></td>
<td class="amt">0.00</td>
<td><button onclick="this.closest('tr').remove();vrCalc()">X</button></td>
`;
  vrBody.appendChild(tr);
}

/* ================= SEARCH + KEYBOARD ================= */
function vrSearch(inp,type){
  const q=inp.value.toLowerCase();
  const box=inp.nextElementSibling;
  box.innerHTML="";
  if(!q) return;

  DB.products.forEach(p=>{
    let ok=false;
    if(type==="barcode" && (p.barcode||"").toLowerCase().includes(q)) ok=true;
    if(type==="item" && (p.itemNo||"").toLowerCase().includes(q)) ok=true;
    if(type==="desc" && (p.desc||"").toLowerCase().includes(q)) ok=true;
    if(!ok) return;

    if([...vrBody.children].some(r=>r!==inp.closest("tr") && r.children[1].children[0].value===p.itemNo)) return;

    const d=document.createElement("div");
    d.className="dd-item";
    d.innerText=`${p.itemNo} | ${p.desc} (Stock ${p.stock})`;
    d.onclick=()=>vrSelectProduct(inp,p);
    box.appendChild(d);
  });
}

function vrKeyNav(e,inp){
  const box=inp.nextElementSibling;
  const items=[...box.children];
  if(!items.length) return;
  let idx=items.findIndex(x=>x.classList.contains("active"));
  if(e.key==="ArrowDown"){ e.preventDefault(); idx=(idx+1)%items.length; }
  if(e.key==="ArrowUp"){ e.preventDefault(); idx=(idx-1+items.length)%items.length; }
  if(e.key==="Enter" && idx>-1){ e.preventDefault(); items[idx].click(); }
  items.forEach(x=>x.classList.remove("active"));
  if(idx>-1) items[idx].classList.add("active");
}

/* ================= SELECT PRODUCT ================= */
function vrSelectProduct(inp,p){

  const r = inp.closest("tr");

  if(!vrVendor.value){
    ruleMessage("Select vendor first");
    return;
  }

  // FIND VENDOR OBJECT
  const vendorObj = DB.vendors.find(v => v.name === vrVendor.value);
  if(!vendorObj){
    ruleMessage("Vendor not found");
    return;
  }

  // GET LAST PURCHASE FOR THIS VENDOR + PRODUCT
  const sortedPurchases = DB.purchases
    .filter(x => x.vendorId === vendorObj.id)
    .sort((a,b)=> new Date(b.dateTime) - new Date(a.dateTime));

  let autoCost = 0;

  for(let purchase of sortedPurchases){

    if(!purchase.items) continue;

    const found = purchase.items.find(i => i.productId === p.id);

    if(found){
      autoCost = Number(found.cost || found.rate || 0);
      break;
    }
  }

  if(autoCost === 0){
    ruleMessage("This product was not purchased from this vendor");
  }

  // FILL ROW
  r.children[0].children[0].value = p.barcode || "";
  r.children[1].children[0].value = p.itemNo;
  r.children[2].children[0].value = p.desc;
  r.querySelector(".stk").innerText = p.stock;
  r.children[5].children[0].value = autoCost;

  inp.nextElementSibling.innerHTML = "";
  vrCalc();
}
/* ================= CALC ================= */
function vrCalc(){
  let total=0;
  [...vrBody.children].forEach(r=>{
    const stk=+r.querySelector(".stk").innerText;
    let q=+r.children[4].children[0].value||0;
    let c=+r.children[5].children[0].value||0;

    if(q>stk){
      ruleMessage("Negative stock not allowed");
      q=stk;
      r.children[4].children[0].value=stk;
    }
    if(c<=0){ r.querySelector(".amt").innerText="0.00"; return; }

    const a=q*c;
    r.querySelector(".amt").innerText=a.toFixed(2);
    total+=a;
  });
  vrTotal.innerText=total.toFixed(2);
}

/* ================= SAVE (OVERWRITE SAFE) ================= */
function vrSave(){
  if(!vrVendor.value) return ruleMessage("Vendor required");

  const items=[];
  [...vrBody.children].forEach(r=>{
    const itemNo=r.children[1].children[0].value;
    const qty=+r.children[4].children[0].value;
    const cost=+r.children[5].children[0].value;
    if(itemNo && qty>0 && cost>0) items.push({itemNo,qty,cost});
  });
  if(!items.length) return ruleMessage("No valid items");

  if(vrEditIndex!==null){
    const old=DB.returns[vrEditIndex];
    old.items.forEach(it=>{
      const p=DB.products.find(x=>x.itemNo===it.itemNo);
      if(p) p.stock+=it.qty;
    });
    DB.vendorLedger=DB.vendorLedger.filter(l=>l.ref!==old.no);
  }

  items.forEach(it=>{
    const p=DB.products.find(x=>x.itemNo===it.itemNo);
    p.stock-=it.qty;
  });

  const amount=items.reduce((s,i)=>s+i.qty*i.cost,0);
  const no=vrEditIndex!==null?DB.returns[vrEditIndex].no:vrNo.innerText;

  const vendorObj = DB.vendors.find(v=>v.id===vrVendor.value);

DB.vendorLedger.push({
  id:uid("VL"),
  vendorId: vendorObj?.id || "",
  vendorName: vendorObj?.name || "",
  type:"Return",
  ref:no,
  debit:0,
  credit:Number(amount),
  date:new Date().toISOString()
});
const obj={
  no,
  vendorId: vendorObj?.id || "",
  vendorName: vendorObj?.name || "",
  items,
  amount,
  dateTime:new Date().toISOString()
};

  saveDB();
  vrEditIndex=null;
  vrBody.innerHTML="";
  vrGenerateNo();
  vrLoadPrevious();
}

/* ================= LOAD / EDIT / DELETE / PRINT ================= */
function vrLoadPrevious(){
  vrPrev.innerHTML="";
  DB.returns.forEach((r,i)=>{
    const d=new Date(r.dateTime);
    vrPrev.innerHTML+=`
<tr>
<td>${i+1}</td>
<td>${r.no}</td>
<td>${d.toLocaleDateString()}</td>
<td>${d.toLocaleTimeString()}</td>
<td>${r.vendor}</td>
<td>${r.amount.toFixed(2)}</td>
<td><button onclick="vrPrint(${i})">Print</button></td>
<td><button onclick="vrEdit(${i})">Edit</button></td>
<td><button onclick="vrDelete(${i})">Delete</button></td>
</tr>`;
  });
}

function vrEdit(i){
  const r=DB.returns[i];
  vrEditIndex=i;
  vrVendor.value=r.vendor;
  vrNo.innerText=r.no;
  vrBody.innerHTML="";
  r.items.forEach(it=>{
    vrAddRow();
    const tr=vrBody.lastChild;
    const p=DB.products.find(x=>x.itemNo===it.itemNo);
    tr.children[1].children[0].value=it.itemNo;
    tr.children[2].children[0].value=p?.desc||"";
    tr.querySelector(".stk").innerText=p?.stock||0;
    tr.children[4].children[0].value=it.qty;
    tr.children[5].children[0].value=it.cost;
  });
  vrCalc();
}

function vrDelete(i){
  if(!confirm("Delete return permanently?")) return;
  const r=DB.returns[i];
  r.items.forEach(it=>{
    const p=DB.products.find(x=>x.itemNo===it.itemNo);
    if(p) p.stock+=it.qty;
  });
  DB.vendorLedger=DB.vendorLedger.filter(l=>l.ref!==r.no);
  DB.returns.splice(i,1);
  saveDB();
  vrLoadPrevious();
}

function vrPrint(i){

  const r = DB.returns[i];
  const d = new Date(r.dateTime);
  const w = window.open("");

  let grand = 0;

  let rowsHTML = r.items.map((it,index)=>{
    const amt = it.qty * it.cost;
    grand += amt;

    return `
<tr>
<td>${index+1}</td>
<td>${it.itemNo}</td>
<td>${it.qty}</td>
<td>${Number(it.cost).toFixed(2)}</td>
<td>${Number(amt).toFixed(2)}</td>
</tr>`;
  }).join("");

  const html = `
<html>
<head>
<title>Vendor Return</title>
<style>
body{font-family:Arial;padding:30px}
.header{display:flex;justify-content:space-between;margin-bottom:20px}
.title{font-size:24px;font-weight:900}
table{width:100%;border-collapse:collapse;margin-top:15px}
th,td{border:1px solid #000;padding:8px;text-align:center}
th{background:#f2f2f2}
.total{margin-top:20px;text-align:right;font-size:18px;font-weight:900}
.footer{margin-top:60px;display:flex;justify-content:space-between}
.sign{border-top:1px solid #000;width:200px;text-align:center;padding-top:5px}
</style>
</head>
<body>

<div class="header">
<div>
<div class="title">VENDOR RETURN INVOICE</div>
<div><b>Return No:</b> ${r.no}</div>
<div><b>Date:</b> ${d.toLocaleString()}</div>
<div><b>Vendor:</b> ${r.vendor}</div>
</div>
</div>

<table>
<thead>
<tr>
<th>#</th>
<th>Item No</th>
<th>Qty</th>
<th>Cost</th>
<th>Amount</th>
</tr>
</thead>
<tbody>
${rowsHTML}
</tbody>
</table>

<div class="total">
Grand Total: ${Number(grand).toFixed(2)}
</div>

<div class="footer">
<div class="sign">Authorized Signature</div>
<div class="sign">Received By</div>
</div>

</body>
</html>
`;

  w.document.write(html);
  w.document.close();
  w.focus();
  w.print();
}
function downloadVendorLedgerCSV(){
  let csv = "Date,Type,Ref,Debit,Credit,Balance\n";
  let bal = 0;

  rows.forEach(r=>{
    bal += (r.debit||0) - (r.credit||0);
    csv += `"${new Date(r.date).toLocaleString()}","${r.type}","${r.ref}",${r.debit||0},${r.credit||0},${bal}\n`;
  });

  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download = "vendor_ledger.csv";
  a.click();
}
</script>
<!-- ================= INVOICE ================= -->
<section id="invoice">
  <div class="card" id="newInvoiceCard">
    <h2>New Invoice</h2>

    <div style="font-size:28px;font-weight:900;letter-spacing:2px;margin-bottom:10px;">
      Invoice No: <span id="liveInvoiceNo"></span>
    </div>

    <!-- ===== ADD PRODUCT ROW ===== -->
    <table style="width:100%; margin-bottom:10px;">
      <thead>
        <tr>
          <th style="width:12%">Barcode</th>
          <th style="width:12%">Item No</th>
          <th style="width:34%">Description</th>
          <th style="width:8%">Qty</th>
          <th style="width:10%">Available</th>
          <th style="width:12%">Rate (PKR)</th>
          <th style="width:12%">Total (PKR)</th>
          <th style="width:10%">Delete</th>
        </tr>
      </thead>
      <tbody id="invoiceRows"></tbody>
    </table>

    <button class="green" onclick="addInvoiceRow()">+ Add Item</button>

    <!-- ===== DISCOUNT & TOTAL ===== -->
    <div style="margin-top:10px;display:flex;gap:15px;flex-wrap:wrap;align-items:center;justify-content:center;border:1px solid #000;padding:10px;">
      <div>
        <label>Main Discount Amount:</label>
        <input type="number" id="mainDiscAmt" value="0" oninput="syncDiscFromAmt();recalcInvoiceFast();">
      </div>
      <div>
        <label>Main Discount %:</label>
        <input type="number" id="mainDiscPct" value="0" oninput="syncDiscFromPct();recalcInvoiceFast();">
      </div>
      <div style="padding:10px;font-weight:bold;text-align:center;border-left:2px solid #000;">
        <label>Total:</label><br>
        <span style="font-size:22px;"><b id="invTotal">0.00</b> PKR</span>
      </div>
    </div>

    <div style="margin-top:10px;">
      <button class="blue" onclick="saveInvoice()">Save Invoice</button>
<button class="red" onclick="cancelInvoice()">Cancel</button>
    </div>
  </div>

  <!-- ===== INVOICE LIST ===== -->
  <div class="card" style="margin-top:20px;">
    <h2>Previous Invoices</h2>

    <div style="margin-bottom:10px;">
      <label>From:</label><input type="date" id="invFrom">
      <label>To:</label><input type="date" id="invTo">
      <button onclick="applyInvoiceFilter()">Apply</button>
      <button onclick="clearInvoiceFilter()">Clear</button>
    </div>

    <table style="width:100%;">
      <thead>
        <tr>
          <th>#</th>
          <th>Invoice No</th>
          <th>Date</th>
          <th>Time</th>
          <th>Total</th>
          <th>Print</th>
          <th>Edit</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody id="invoiceList"></tbody>
    </table>

    <div style="margin-top:10px;display:flex;gap:10px;">
      <button onclick="prevInvPage()">Prev</button>
      <button onclick="nextInvPage()">Next</button>
    </div>
  </div>
</section>

<script>
/* ================= INVOICE LOGIC ================= */

let invoiceDraft = [];
let editingInvoiceId = null;
let invPage = 1;
const invPerPage = 100;
let invFiltered = null;

/* ===== FORMAT ===== */
function formatNumber(x){
  return Number(x).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
}

/* ===== INVOICE NO ===== */
function getNextInvoiceNumber(){
  if(!DB.invoices || !DB.invoices.length) return "INV000001";
  const max = Math.max(...DB.invoices.map(i=>+i.id.replace("INV","")));
  return "INV"+String(max+1).padStart(6,"0");
}
function updateLiveInvoiceNo(){
  const el = document.getElementById("liveInvoiceNo");
  if(el) el.innerText = editingInvoiceId || getNextInvoiceNumber();
}

/* ===== ADD ROW ===== */
function addInvoiceRow(){
  invoiceDraft.push({productId:"",barcode:"",itemNo:"",desc:"",qty:1,rate:0,valid:false});
  renderInvoice();
}

/* ===== RENDER INVOICE ===== */
function renderInvoice(){
  const tbody = document.getElementById("invoiceRows");
  tbody.innerHTML="";

  invoiceDraft.forEach((r,i)=>{
    tbody.innerHTML+=`
<tr>

<td>
  <input value="${r.barcode}" 
       oninput="searchInvProduct(${i},this.value,'barcode')"
       onkeypress="if(event.key==='Enter'){addInvoiceRow()}">
  <div id="invSugB${i}" class="invSug"></div>
</td>

<td>
  <input value="${r.itemNo}" 
         oninput="searchInvProduct(${i},this.value,'itemNo')">
  <div id="invSugI${i}" class="invSug"></div>
</td>

<td>
  <input value="${r.desc}" 
         oninput="searchInvProduct(${i},this.value,'desc')">
  <div id="invSugD${i}" class="invSug"></div>
</td>

<td>
  <input type="number" min="1" step="1"
         value="${r.qty}"
         onchange="setInvQty(${i},this.value)">
</td>

<td>
  ${r.valid 
    ? (DB.products.find(p=>p.id===r.productId)?.stock ?? 0)
    : "-"}
</td>

<td>
  <input type="number"
         value="${r.rate}"
         onchange="setInvRate(${i},this.value)">
</td>

<td>
  ${r.valid 
    ? formatNumber((+r.qty||0) * (+r.rate||0))
    : "0.00"}
</td>

<td>
  <button class="red" onclick="delInvRow(${i})">X</button>
</td>

</tr>`;
  });

  recalcInvoiceFast();
  updateLiveInvoiceNo();
}

/* ===== SEARCH PRODUCT ===== */
function searchInvProduct(i,val,field){

  const q = val.trim().toLowerCase();
  const row = invoiceDraft[i];
  row.valid = false;

  const box = document.getElementById(
    field==="barcode" ? "invSugB"+i :
    field==="itemNo" ? "invSugI"+i :
    "invSugD"+i
  );

  box.innerHTML="";
  if(!q) return;

  // SEARCH ALL PRODUCTS
  let results = DB.products.filter(p=>{

    const barcode = (p.barcode||"").toLowerCase();
    const itemNo  = (p.itemNo||"").toLowerCase();
    const desc    = (p.desc||"").toLowerCase();

    if(field==="barcode") return barcode.includes(q);
    if(field==="itemNo")  return itemNo.includes(q);
    if(field==="desc")    return desc.includes(q);

    return false;
  });

  if(!results.length){
    box.innerHTML="<div style='padding:4px;color:red'>No product found</div>";
    return;
  }

  // ðŸ”¥ AUTO SELECT IF EXACT BARCODE MATCH
  if(field==="barcode"){
    const exact = results.find(p=>
      (p.barcode||"").toLowerCase()===q
    );
    if(exact){
      selectInvoiceProduct(i,exact);
      return;
    }
  }

  results.slice(0,20).forEach(p=>{
    const d=document.createElement("div");
    d.innerText=
      (p.barcode||"")+
      " | "+p.itemNo+
      " | "+p.desc+
      " (Stock: "+p.stock+")";

    d.onclick=()=>{
      selectInvoiceProduct(i,p);
    };

    box.appendChild(d);
  });
}
 
function selectInvoiceProduct(i,p){

  if(invoiceDraft.some((x,idx)=>idx!==i && x.productId===p.id)){
    alert("Product already added");
    return;
  }

  invoiceDraft[i] = {
    productId:p.id,
    barcode:p.barcode||"",
    itemNo:p.itemNo,
    desc:p.desc,
    qty:1,
    rate:p.rate||0,
    valid:true
  };

  renderInvoice();
}
/* ===== QTY / RATE ===== */
function setInvQty(i,v){
  v = Math.floor(+v);
  if(v<=0 || isNaN(v)) v = 1;

  invoiceDraft[i].qty = v;
  renderInvoice();   // âœ… important
}
function setInvRate(i,v){
  v = +v;
  if(v<0 || isNaN(v)) v = 0;

  invoiceDraft[i].rate = v;
  renderInvoice();   // âœ… important
}
function delInvRow(i){
  invoiceDraft.splice(i,1);
  renderInvoice();
}

/* ===== TOTAL ===== */
function recalcInvoiceFast(){
  let sub=0;
  invoiceDraft.forEach(r=>{ if(r.valid) sub+=r.qty*r.rate; });
  applyMainDiscount(sub);
}
function applyMainDiscount(sub){
  let amt=+mainDiscAmt.value||0;
  let pct=+mainDiscPct.value||0;
  if(pct>0) amt=sub*pct/100;
  if(amt>sub) amt=sub;
  invTotal.innerText=formatNumber(Math.max(0,sub-amt));
}
function syncDiscFromAmt(){
  const sub=invoiceDraft.reduce((s,r)=>r.valid?s+r.qty*r.rate:s,0);
  if(sub>0) mainDiscPct.value=((+mainDiscAmt.value/sub)*100).toFixed(2);
}
function syncDiscFromPct(){
  const sub=invoiceDraft.reduce((s,r)=>r.valid?s+r.qty*r.rate:s,0);
  if(sub>0) mainDiscAmt.value=((sub*+mainDiscPct.value)/100).toFixed(2);
}

/* ===== SAVE INVOICE ===== */
function saveInvoice(){
  if(!invoiceDraft.length) return alert("Invoice empty");
  if(invoiceDraft.some(r=>!r.valid)) return alert("Invalid product");
 for(const r of invoiceDraft){
  const p=DB.products.find(x=>x.id===r.productId);
  if(!p) continue;
  if(p.stock < r.qty){
    return alert("Low stock: "+r.desc);
  }
}
  const id=editingInvoiceId||getNextInvoiceNumber();
  const dateTime=new Date().toISOString();
  const total=+invTotal.innerText.replace(/,/g,"");
  const index = DB.invoices.findIndex(i=>i.id===id);
if(index>-1){
  DB.invoices[index]={
    id,dateTime,total,
    items:JSON.parse(JSON.stringify(invoiceDraft)),
    discountAmt:+mainDiscAmt.value,
    discountPct:+mainDiscPct.value
  };
}else{
  DB.invoices.push({
    id,dateTime,total,
    items:JSON.parse(JSON.stringify(invoiceDraft)),
    discountAmt:+mainDiscAmt.value,
    discountPct:+mainDiscPct.value
  });
}
  invoiceDraft.forEach(r=>{
   const prod = DB.products.find(p=>p.id===r.productId);
if(prod){
  if(prod.stock < r.qty) return alert("Stock mismatch detected");
  prod.stock -= r.qty;
}
  });

  DB.cash.push({id:uid("C"),type:"IN",amount:total,ref:id,dateTime});

  saveDB();

  invoiceDraft=[];
  editingInvoiceId=null;
  mainDiscAmt.value=mainDiscPct.value=0;

  renderInvoice();
  renderInvoiceList();
  updateLiveInvoiceNo();
  alert("Invoice saved");
}
function cancelInvoice(){
  if(!confirm("Cancel this invoice?")) return;
  invoiceDraft=[];
  editingInvoiceId=null;
  mainDiscAmt.value=0;
  mainDiscPct.value=0;
  renderInvoice();
  updateLiveInvoiceNo();
}

/* ===== INVOICE LIST ===== */
function renderInvoiceList(){
  const tbody=document.getElementById("invoiceList");
  tbody.innerHTML="";

  const list=invFiltered||DB.invoices||[];
  if(!list.length) return;

  const start=(invPage-1)*invPerPage;
  list.slice().reverse().slice(start,start+invPerPage).forEach((inv,i)=>{
    const d=new Date(inv.dateTime);
    tbody.innerHTML+=`
      <tr>
        <td>${start+i+1}</td>
        <td>${inv.id}</td>
        <td>${d.toLocaleDateString()}</td>
        <td>${d.toLocaleTimeString()}</td>
        <td>${formatNumber(inv.total)}</td>
        <td><button onclick="printInvoice('${inv.id}')">Print</button></td>
        <td><button onclick="editInvoice('${inv.id}')">Edit</button></td>
        <td><button class="red" onclick="deleteInvoice('${inv.id}')">Delete</button></td>
      </tr>`;
  });
}

/* ===== FILTER & PAGE ===== */
function applyInvoiceFilter(){
  const f=invFrom.value,t=invTo.value;
  invFiltered=DB.invoices.filter(i=>{
    const d=new Date(i.dateTime);
    if(f&&d<new Date(f)) return false;
    if(t&&d>new Date(t+"T23:59:59")) return false;
    return true;
  });
  invPage=1;
  renderInvoiceList();
}
function clearInvoiceFilter(){
  invFrom.value="";
  invTo.value="";
  invFiltered=null;
  invPage=1;
  renderInvoiceList();
}
function prevInvPage(){ if(invPage>1){invPage--;renderInvoiceList();} }
function nextInvPage(){ invPage++;renderInvoiceList(); }

/* ===== EDIT INVOICE ===== */
function editInvoice(id){
  const inv = DB.invoices.find(i=>i.id===id);
  if(!inv) return alert("Invoice not found");

  // RESTORE STOCK FIRST
  inv.items.forEach(r=>{
    const p = DB.products.find(x=>x.id===r.productId);
    if(p) p.stock += r.qty;
  });

  editingInvoiceId = id;
  invoiceDraft = JSON.parse(JSON.stringify(inv.items));

  mainDiscAmt.value = inv.discountAmt || 0;
  mainDiscPct.value = inv.discountPct || 0;

  renderInvoice();
  updateLiveInvoiceNo();
  window.scrollTo(0,0);
}
/* ===== DELETE INVOICE ===== */
function deleteInvoice(id){
  if(!confirm("Delete this invoice?")) return;

  const inv = DB.invoices.find(i=>i.id===id);
  if(!inv) return;

  inv.items.forEach(r=>{
    const p = DB.products.find(x=>x.id===r.productId);
    if(p) p.stock += r.qty;
  });
DB.deleted.push({
  type:"INVOICE",
  ref:id,
  user:JSON.parse(sessionStorage.getItem("loggedInUser")).username,
  dateTime:new Date().toISOString(),
  data:inv
});
saveDB();
  DB.cash = DB.cash.filter(c=>c.ref!==id);
  DB.invoices = DB.invoices.filter(i=>i.id!==id);

  saveDB();
  renderInvoiceList();
  renderInvoice();
  updateLiveInvoiceNo();
}
/* ===== PRINT INVOICE ===== */
function printInvoice(id){
  const inv = DB.invoices.find(i=>i.id===id);
  if(!inv) return;

  const s = DB.settings || {};
  const d = new Date(inv.dateTime);

  const w = window.open("");
  w.document.write(`
<html>
<head>
<meta name="viewport" content="width=300">
<style>
@page{
  size: 80mm auto;
  margin: 0;
}

body{
  width:80mm;
  margin:0;
  padding:2mm;
  font-family: 'Segoe UI', Tahoma, sans-serif;
font-size:13px;
font-weight:500;
  -webkit-print-color-adjust:exact;
}

.center{text-align:center}
.right{text-align:right}
.line{
  border-top:1px dotted #000;
  margin:6px 0;
}

.big{
  font-size:18px;
  font-weight:900;
}

table{
  width:100%;
  border-collapse:collapse;
}

td{
  padding:4px 0;
  font-size:14px;
}
table{width:100%}
td{padding:2px 0}
</style>
</head>
<body>

<div class="center">
  ${s.logo ? `<img src="${s.logo}" style="max-width:90px;height:90px;"><br>` : ""}
  <b>${s.softwareName || ""}</b><br>
  ${s.shopLocation || ""}
</div>
<div class="line"></div>

<div class="center big">CASH CUSTOMER</div>

<div class="line"></div>

<table>
<tr style="border-bottom:1px dashed #000;font-weight:bold">
<td>S#</td>
<td>Item</td>
<td>Qty</td>
<td>Rate</td>
<td class="right">Amt</td>
</tr>
${inv.items.map((r,i)=>`
<tr>
<td>${i+1}</td>
<td>${r.itemNo}<br><small>${r.desc||""}</small></td>
<td>${r.qty}</td>
<td>${r.rate}</td>
<td class="right">Rs.${Number(r.qty*r.rate).toLocaleString("en-PK",{minimumFractionDigits:2})}</td>
</tr>`).join("")}
</table>

<div class="line"></div>

<table>
<tr>
<td>Subtotal</td>
<td class="right">
Rs.${inv.items.reduce((s,r)=>s+r.qty*r.rate,0)
.toLocaleString("en-PK",{minimumFractionDigits:2})}
</td>
</tr>

<tr>
<td>Discount (${inv.discountPct||0}%)</td>
<td class="right">
Rs.${Number(inv.discountAmt||0)
.toLocaleString("en-PK",{minimumFractionDigits:2})}
</td>
</tr>

<tr>
<td><b>Total</b></td>
<td class="right">
<b>Rs.${Number(inv.total)
.toLocaleString("en-PK",{minimumFractionDigits:2})}</b>
</td>
</tr>
</table>

<div class="line"></div>

<div class="center">Thank You For Purchasing</div>

<div class="line"></div>
<div class="center">
<div>Software By MT Tech</div>
<div>0327-4947677</div>
</div>

<div class="line"></div>

</body>
</html>

  `);

  w.document.close();
}
/* ===== INITIAL RENDER ===== */
document.addEventListener("DOMContentLoaded",()=>{
  renderInvoice();
  renderInvoiceList();
  updateLiveInvoiceNo();
  renderVendors();
loadVendorOptions();
});

</script>

<style>
.invSug{position:absolute;background:#fff;border:1px solid #ccc;max-height:160px;overflow:auto;z-index:100}
.invSug div:hover{background:#eee;cursor:pointer;}
td{position:relative}
</style>
<!-- ================= CASH IN HAND SECTION ================= -->

<section id="cash">

<div class="card" style="max-width:1000px;margin:auto">

<h2 style="font-size:26px;font-weight:900;margin-bottom:20px">
Cash In Hand
</h2>

<!-- ===== TOTAL BALANCE BOX ===== -->
<div style="
background:#0b1c2d;
color:#fff;
padding:25px;
border-radius:12px;
margin-bottom:25px;
display:flex;
justify-content:space-between;
align-items:center;
">

<div style="font-size:18px;font-weight:600">
Current Balance
</div>

<div style="font-size:32px;font-weight:900">
Rs. <span id="cashBalance">0.00</span>
</div>

</div>

<!-- ===== ADD PAYMENT ROW ===== -->
<div style="
display:grid;
grid-template-columns: 150px 1fr 150px 150px 120px;
gap:15px;
align-items:end;
margin-bottom:20px;
">

<div>
<label>Type</label>
<select id="cashType">
<option value="IN">IN</option>
<option value="OUT">OUT</option>
</select>
</div>

<div>
<label>Reference</label>
<input id="cashRef">
</div>

<div>
<label>Amount (PKR)</label>
<input type="number" id="cashAmount">
</div>

<div>
<label>Date</label>
<input type="date" id="cashDate">
</div>

<div>
<button class="green" onclick="addCashEntry()" style="width:100%">Add</button>
</div>

</div>

<!-- ===== TABLE ===== -->
<table>
<thead>
<tr>
<th>#</th>
<th>Date</th>
<th>Type</th>
<th>Reference</th>
<th>Amount (PKR)</th>
<th>Delete</th>
</tr>
</thead>
<tbody id="cashRows"></tbody>
</table>

</div>
</section>
  <script>
// =======================
// DATA STORAGE
// =======================

let cashPayments = JSON.parse(localStorage.getItem("cashPayments")) || [];
let deletedPayments = JSON.parse(localStorage.getItem("deletedPayments")) || [];
let currentCashPage = 1;
const cashPerPage = 100;

// =======================
// INITIALIZE
// =======================

document.addEventListener("DOMContentLoaded", () => {
  populateVendorDropdowns();
  syncInvoicePayments();
  renderCashTable();
  updateCashBalance();
});

// =======================
// SAVE PAYMENT
// =======================

function saveCashPayment() {

  const id = document.getElementById("editCashId").value;
  const date = document.getElementById("cashDate").value;
  const vendor = document.getElementById("cashVendor").value;
  const type = document.getElementById("cashType").value;
  const amount = parseFloat(document.getElementById("cashAmount").value);
  const reference = document.getElementById("cashReference").value;
  const expense = document.getElementById("cashExpense").checked;

  if (!vendor) {
    alert("Please add/select vendor first.");
    return;
  }

  if (!amount || amount <= 0) {
    alert("Enter valid amount.");
    return;
  }

  if (id) {
    // EDIT MODE
    const old = cashPayments.find(p => p.id === id);
    if (old.source === "invoice") return;

    revertVendorImpact(old);

    Object.assign(old, {
      date,
      vendor,
      type,
      amount,
      reference,
      expense
    });

    applyVendorImpact(old);

  } else {
    // ADD MODE
    const payment = {
      id: "CASH-" + Date.now(),
      date,
      time: new Date().toLocaleTimeString(),
      vendor,
      type,
      amount,
      reference,
      expense,
      createdAt: new Date().toISOString(),
      source: "manual"
    };

    cashPayments.push(payment);
    applyVendorImpact(payment);
  }

  saveCashStorage();
  resetCashForm();
  renderCashTable();
  updateCashBalance();
}
function renderCash(){
  const tbody=document.getElementById("cashRows");
  const bal=document.getElementById("cashBalance");
  tbody.innerHTML="";

  let total=0;

  DB.cash.forEach((c,i)=>{
    if(c.type==="IN") total+=Number(c.amount||0);
    else total-=Number(c.amount||0);

    tbody.innerHTML+=`
    <tr>
      <td>${i+1}</td>
      <td>${new Date(c.dateTime||c.date).toLocaleDateString()}</td>
      <td>${c.type}</td>
      <td>${c.ref||""}</td>
      <td>Rs. ${Number(c.amount).toFixed(2)}</td>
      <td><button class="red" onclick="deleteCash(${i})">X</button></td>
    </tr>`;
  });

  bal.innerText=total.toFixed(2);
}

function addCashEntry(){
  const type=document.getElementById("cashType").value;
  const ref=document.getElementById("cashRef").value;
  const amount=+document.getElementById("cashAmount").value;
  const date=document.getElementById("cashDate").value;

  if(!amount || amount<=0) return alert("Enter amount");

  DB.cash.push({
    id:uid("C"),
    type,
    ref,
    amount,
    dateTime: date? new Date(date).toISOString():new Date().toISOString()
  });

  saveDB();
  renderCash();

  cashRef.value="";
  cashAmount.value="";
}

function deleteCash(i){
  if(!confirm("Delete entry?")) return;
  DB.cash.splice(i,1);
  saveDB();
  renderCash();
}

document.addEventListener("DOMContentLoaded",renderCash);
// =======================
// VENDOR IMPACT
// =======================

function applyVendorImpact(payment) {

  const vendor = vendors.find(v => v.name === payment.vendor);
  if (!vendor) return;

  if (payment.type === "OUT") {
    vendor.balance -= payment.amount;
    pushVendorLedger(vendor, payment, "PAYMENT");
  } else {
    vendor.balance += payment.amount;
    pushVendorLedger(vendor, payment, "RECEIVED");
  }

  saveVendors();
}

function revertVendorImpact(payment) {
  const vendor = vendors.find(v => v.name === payment.vendor);
  if (!vendor) return;

  if (payment.type === "OUT") {
    vendor.balance += payment.amount;
  } else {
    vendor.balance -= payment.amount;
  }

  saveVendors();
}

function pushVendorLedger(vendor, payment, label) {

  vendor.ledger.push({
    date: payment.date,
    type: label,
    amount: payment.amount,
    ref: payment.reference,
    expense: payment.expense
  });

}

// =======================
// RUNNING BALANCE ENGINE
// =======================

function calculateRunningBalances(data) {

  let balance = 0;

  return data.map(p => {
    if (p.type === "IN") balance += p.amount;
    if (p.type === "OUT") balance -= p.amount;

    return { ...p, runningBalance: balance };
  });

}

// =======================
// TABLE RENDER
// =======================

function renderCashTable() {

  let filtered = applyFiltersInternal();

  filtered.sort((a,b)=> new Date(a.date+" "+a.time) - new Date(b.date+" "+b.time));

  const withBalance = calculateRunningBalances(filtered);

  const start = (currentCashPage - 1) * cashPerPage;
  const paginated = withBalance.slice(start, start + cashPerPage);

  const tbody = document.getElementById("cashTableBody");
  tbody.innerHTML = "";

  paginated.forEach(p => {

    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${p.date}</td>
      <td>${p.time}</td>
      <td>${p.expense ? "EXP" : p.type}</td>
      <td>${p.vendor}</td>
      <td>â‚¹ ${p.amount.toFixed(2)}</td>
      <td>${p.reference || ""}</td>
      <td>â‚¹ ${p.runningBalance.toFixed(2)}</td>
      <td>${p.source==="manual" && p.type==="OUT" ? `<button onclick="editCash('${p.id}')">Edit</button>` : "-"}</td>
      <td>${p.source==="manual" && p.type==="OUT" ? `<button onclick="deleteCash('${p.id}')">Delete</button>` : "-"}</td>
      <td>${new Date(p.createdAt).toLocaleDateString()}</td>
    `;

    tbody.appendChild(tr);

  });

  document.getElementById("cashPageInfo").innerText =
    `Page ${currentCashPage}`;
}

// =======================
// EDIT / DELETE
// =======================

function editCash(id) {

  const p = cashPayments.find(x => x.id === id);
  if (!p || p.source === "invoice") return;

  document.getElementById("editCashId").value = p.id;
  document.getElementById("cashDate").value = p.date;
  document.getElementById("cashVendor").value = p.vendor;
  document.getElementById("cashType").value = p.type;
  document.getElementById("cashAmount").value = p.amount;
  document.getElementById("cashReference").value = p.reference;
  document.getElementById("cashExpense").checked = p.expense;

  document.getElementById("cashFormTitle").innerText = "Edit Payment";
}

function deleteCash(id) {

  if (!confirm("Delete this payment?")) return;

  const index = cashPayments.findIndex(p => p.id === id);
  const payment = cashPayments[index];

  if (payment.source === "invoice") return;

  revertVendorImpact(payment);

  deletedPayments.push(payment);
  cashPayments.splice(index,1);

  saveCashStorage();
  renderCashTable();
  updateCashBalance();
}

// =======================
// BALANCE UPDATE
// =======================

function updateCashBalance() {

  const withBalance = calculateRunningBalances(
    [...cashPayments].sort((a,b)=> new Date(a.date+" "+a.time) - new Date(b.date+" "+b.time))
  );

  const total = withBalance.length
    ? withBalance[withBalance.length - 1].runningBalance
    : 0;

  document.getElementById("cashBalanceDisplay").innerText =
    "â‚¹ " + total.toFixed(2);
}

// =======================
// INVOICE AUTO SYNC
// =======================

function syncInvoicePayments() {

  invoices.forEach(inv => {

    const exists = cashPayments.find(p => p.reference === inv.invoiceNumber);

    if (!exists) {

      cashPayments.push({
        id: "INV-" + inv.invoiceNumber,
        date: inv.date,
        time: "00:00:00",
        vendor: inv.customer,
        type: "IN",
        amount: inv.total,
        reference: inv.invoiceNumber,
        expense: false,
        createdAt: new Date().toISOString(),
        source: "invoice"
      });

    }

  });

  saveCashStorage();
}

// =======================
// STORAGE
// =======================

function saveCashStorage() {
  localStorage.setItem("cashPayments", JSON.stringify(cashPayments));
  localStorage.setItem("deletedPayments", JSON.stringify(deletedPayments));
}

// =======================
// PAGINATION
// =======================

function nextCashPage(){
  currentCashPage++;
  renderCashTable();
}

function prevCashPage(){
  if(currentCashPage>1) currentCashPage--;
  renderCashTable();
}

// =======================
// FILTERS + CSV
// =======================

function applyFiltersInternal(){

  const from = document.getElementById("filterFrom").value;
  const to = document.getElementById("filterTo").value;
  const vendor = document.getElementById("filterVendor").value;
  const search = document.getElementById("filterSearch").value.toLowerCase();

  return cashPayments.filter(p => {

    if(from && p.date < from) return false;
    if(to && p.date > to) return false;
    if(vendor && p.vendor !== vendor) return false;
    if(search && !(
      p.vendor.toLowerCase().includes(search) ||
      (p.reference||"").toLowerCase().includes(search) ||
      p.amount.toString().includes(search)
    )) return false;

    return true;
  });
}

function applyCashFilters(){
  currentCashPage=1;
  renderCashTable();
}

function downloadCashCSV(){

  const data = calculateRunningBalances(cashPayments);

  let csv = "Date,Time,Type,Vendor,Amount,Reference,Balance\n";

  data.forEach(p=>{
    csv+=`${p.date},${p.time},${p.type},${p.vendor},${p.amount},${p.reference},${p.runningBalance}\n`;
  });

  const blob = new Blob([csv],{type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "cashbook.csv";
  a.click();
}
    </script>
<!-- ================= PRODUCTS (ADVANCED SYSTEM) ================= -->
<section id="products">

<div class="card">
<h2>Products Management</h2>
<div class="card" id="productForm" 
style="display:none;position:fixed;top:50%;left:50%;
transform:translate(-50%,-50%);
width:520px;z-index:9999;background:#fff;
box-shadow:0 0 30px rgba(0,0,0,.4);
border-radius:12px;padding:20px;">

<h3 id="productFormTitle">New Product</h3>

<div style="display:grid;gap:10px;">
<input id="pBarcode" placeholder="Barcode">
<input id="pItemNo" placeholder="Item No">
<input id="pDesc" placeholder="Description">
<input id="pRate" type="number" placeholder="Rate">
</div>
<div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end">
  <button class="green" onclick="ProductSystem.saveProduct()">Save</button>
  <button class="red" onclick="ProductSystem.closeProductForm()">Cancel</button>
</div>

</div>
<div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px">

<button class="green" onclick="ProductSystem.openCreate()">+ New Product</button>
<button class="blue" onclick="ProductSystem.exportCSV()">Export CSV</button>
<input type="file" accept=".xlsx,.xls" onchange="ProductSystem.importExcel(this)">
<input id="productSearch"
       placeholder="Search Products..."
       style="flex:1;padding:10px"
       oninput="ProductSystem.advancedProductSearch()"></div>

</div>

<div class="card">

<table>
<thead>
<tr>
<th>#</th>
<th>Barcode</th>
<th>Item No</th>
<th>Description</th>
<th>Rate</th>
<th>Stock</th>
<th>Action</th>
</tr>
</thead>

<tbody id="productRows"></tbody>
</table>

<div style="display:flex;gap:10px;margin-top:15px">
<button onclick="ProductSystem.prev()">Prev</button>
<button onclick="ProductSystem.next()">Next</button>
</div>

</div>

</section>

<script>

const ProductSystem = (function(){

let state = {
page:1,
perPage:100,
filtered:[]
};

/* ================= INIT ================= */

function init(){
state.filtered = DB.products.slice();
render();
}

/* ================= RENDER ================= */

function render(){

const tbody = document.getElementById("productRows");
tbody.innerHTML = "";

const start = (state.page-1)*state.perPage;
const end   = start + state.perPage;

state.filtered
.slice(start,end)
.forEach((p,index)=>{

tbody.innerHTML += `
<tr>
<td>${start+index+1}</td>
<td>${p.barcode||""}</td>
<td>${p.itemNo}</td>
<td>${p.desc}</td>
<td>${Number(p.rate).toLocaleString(undefined,{minimumFractionDigits:2})}</td>
<td>${p.stock||0}</td>
<td>
<button class="blue" onclick="ProductSystem.edit('${p.id}')">Edit</button>
<button class="red" onclick="ProductSystem.remove('${p.id}')">Delete</button>
</td>
</tr>
`;

});

}

/* ================= SEARCH ================= */

function advancedProductSearch(){

  const q = document.getElementById("productSearch").value.toLowerCase().trim();

  if(!q){
    state.filtered = DB.products.slice();
    state.page = 1;
    render();
    return;
}

  const results = DB.products.filter(p =>
    (p.itemNo || "").toLowerCase().includes(q) ||
    (p.desc || "").toLowerCase().includes(q) ||
    (p.barcode || "").toLowerCase().includes(q)
  );

  state.filtered = results;
state.page = 1;
render();
}
let editingProductId = null;

/* ================= OPEN FORM ================= */

function openCreate(){
editingProductId = null;
document.getElementById("productForm").style.display="block";
productFormTitle.innerText="New Product";
pBarcode.value="";
pItemNo.value="";
pDesc.value="";
pRate.value="";
}

/* ================= EDIT ================= */

function edit(id){

const p = DB.products.find(x=>x.id===id);
if(!p) return;

editingProductId = id;

document.getElementById("productForm").style.display="block";
productFormTitle.innerText="Edit Product";

pBarcode.value=p.barcode||"";
pItemNo.value=p.itemNo||"";
pDesc.value=p.desc||"";
pRate.value=p.rate||0;
}

/* ================= SAVE ================= */

function saveProduct(){

const barcode=pBarcode.value.trim();
const itemNo=pItemNo.value.trim();
const desc=pDesc.value.trim();
const rate=+pRate.value||0;

if(!itemNo||!desc){
alert("Item No & Description Required");
return;
}

if(editingProductId){

const p=DB.products.find(x=>x.id===editingProductId);
if(!p) return;

p.barcode=barcode;
p.itemNo=itemNo;
p.desc=desc;
p.rate=rate;

}else{

if(DB.products.some(p=>p.itemNo===itemNo)){
alert("Item No already exists");
return;
}

if(barcode && DB.products.some(p=>p.barcode===barcode)){
alert("Barcode already exists");
return;
}

DB.products.push({
id: uid("P"),
barcode,
itemNo,
desc,
rate,
stock:0
});

}

saveDB();
state.filtered = DB.products.slice();
render();
closeProductForm();
}

/* ================= CLOSE ================= */

function closeProductForm(){
document.getElementById("productForm").style.display="none";
editingProductId=null;
}
/* ================= DELETE ================= */

function remove(id){

const p = DB.products.find(x=>x.id===id);
if(!p) return;

if(p.stock!==0){
alert("Stock exists. Cannot delete.");
return;
}

if(confirm("Delete Product?")){
DB.products = DB.products.filter(x=>x.id!==id);
saveDB();
state.filtered = DB.products.slice();
render();
}

}

/* ================= PAGINATION ================= */

function next(){
if(state.page*state.perPage < state.filtered.length){
state.page++;
render();
}
}

function prev(){
if(state.page>1){
state.page--;
render();
}
}

/* ================= IMPORT ================= */

function importExcel(input){

const reader = new FileReader();

reader.onload = e=>{

const wb = XLSX.read(e.target.result,{type:"binary"});
const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

rows.forEach(r=>{

const itemNo = r["Item No"]||"";
const barcode = r["Barcode"]||"";

if(!itemNo) return;
if(DB.products.some(p=>p.itemNo===itemNo)) return;
if(barcode && DB.products.some(p=>p.barcode===barcode)) return;

DB.products.push({
id: uid("P"),
barcode,
itemNo,
desc: r["Description"]||"",
rate: Number(
  r["Rate"] ??
  r["RATE"] ??
  r["rate"] ??
  r["Retail Rate"] ??
  r["Retail rate"] ??
  0
),
stock:0
});

});

saveDB();
state.filtered = DB.products.slice();
render();
alert("Import Completed");

};

reader.readAsBinaryString(input.files[0]);
}

/* ================= EXPORT ================= */

function exportCSV(){

let csv = "Barcode,Item No,Description,Rate,Stock\n";

DB.products.forEach(p=>{
csv += `"${p.barcode}","${p.itemNo}","${p.desc}",${p.rate},${p.stock}\n`;
});

const a = document.createElement("a");
a.href = URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
a.download="products.csv";
a.click();

}

/* ================= PUBLIC ================= */

return {
init,
advancedProductSearch,
openCreate,
edit,
remove,
next,
prev,
importExcel,
exportCSV,
saveProduct,
closeProductForm
};
})();

/* ================= LOAD ================= */

document.addEventListener("DOMContentLoaded",function(){
ProductSystem.init();
});

</script>
<!-- ================= VENDORS ================= -->
<section id="vendors">
  <div class="card">
    <h2>Vendors</h2>

    <input id="vendorSearch"
           placeholder="Search vendor (No, Name)"
           oninput="vendorPage=1;renderVendors()"
           style="margin-bottom:10px;width:100%;">

    <div style="display:flex;gap:10px;margin-bottom:12px;">
      <input id="vendorName" placeholder="Vendor Name" style="flex:1">
      <button onclick="addVendor()">Add Vendor</button>
    </div>

    <table style="width:100%;border-collapse:collapse;">
      <thead>
        <tr>
          <th>#</th>
          <th>Vendor No</th>
          <th>Name</th>
          <th>Balance</th>
          <th>Ledger</th>
          <th>Edit</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody id="vendorRows"></tbody>
    </table>

    <div style="margin-top:10px;display:flex;gap:10px;">
      <button onclick="prevVendorPage()">Prev</button>
      <button onclick="nextVendorPage()">Next</button>
    </div>
  </div>
</section>

<script>

/* ================= SAFE INIT ================= */

DB.vendors = DB.vendors || [];
DB.purchases = DB.purchases || [];
DB.cash = DB.cash || [];
DB.returns = DB.returns || [];
DB.deletedLogs = DB.deletedLogs || [];

let vendorPage = 1;
const vendorsPerPage = 20;

/* ===== MONEY FORMAT ===== */
function money(v){
  const n = Number(v || 0);
  return (n < 0 ? "-" : "") +
    Math.abs(n).toLocaleString("en-PK",{minimumFractionDigits:2});
}

/* ===== NEXT VENDOR NO ===== */
function nextVendorNo(){
  if(!DB.vendors.length) return "VEN1001";
  const nums = DB.vendors
    .map(v=>parseInt(String(v.no||"").replace("VEN","")))
    .filter(n=>!isNaN(n));
  return "VEN"+(Math.max(...nums,1000)+1);
}

/* ===== ADD VENDOR ===== */
function addVendor(){
  const name = vendorName.value.trim();
  if(!name) return alert("Vendor name required");

  if(DB.vendors.some(v=>v.name.toLowerCase()===name.toLowerCase())){
    alert("Vendor already exists");
    return;
  }

  DB.vendors.push({
    id: uid("V"),
    no: nextVendorNo(),
    name,
    createdDate: new Date().toISOString()
  });

  saveDB();
  vendorName.value="";
  vendorPage=1;
  renderVendors();
  loadVendorOptions();
}

/* ===== EDIT ===== */
function editVendor(id){
  const v = DB.vendors.find(x=>x.id===id);
  if(!v) return;

  const name = prompt("Edit vendor name", v.name);
  if(!name) return;

  v.name = name.trim();
  saveDB();
  renderVendors();
  loadVendorOptions();
}

/* ===== DELETE ===== */
function deleteVendor(id){
  const v = DB.vendors.find(x=>x.id===id);
  if(!v) return;

  const bal = vendorBalance(v);
  if(bal !== 0){
    alert("Cannot delete vendor. Balance must be zero.");
    return;
  }

  if(!confirm("Delete this vendor?")) return;

  DB.deletedLogs.push({
    id: uid("DEL"),
    section:"VENDOR",
    account: currentUser?.username || "System",
    ref:v.no,
    detail:v,
    date:new Date().toISOString()
  });

  DB.vendors = DB.vendors.filter(x=>x.id!==id);

  saveDB();
  renderVendors();
  loadVendorOptions();
}

/* ===== BALANCE (PURCHASE - PAYMENT - RETURN) ===== */
function vendorBalance(v){

  const purchase = DB.purchases
    .filter(p=>p.vendorId===v.id)
    .reduce((s,p)=>s+(Number(p.total)||0),0);

  const paid = DB.cash
    .filter(c=>c.type==="OUT" && c.vendorId===v.id)
    .reduce((s,c)=>s+(Number(c.amount)||0),0);

  const returns = DB.returns
    .filter(r=>r.vendorId===v.id)
    .reduce((s,r)=>s+(Number(r.amount)||0),0);

  return purchase - paid - returns;
}

/* ===== RENDER ===== */
function renderVendors(){

  const tbody = document.getElementById("vendorRows");
  tbody.innerHTML="";

  const q = (vendorSearch.value||"").toLowerCase().trim();

  const filtered = DB.vendors
    .filter(v=>{
      if(!q) return true;
      return (
        (v.name||"").toLowerCase().includes(q) ||
        (v.no||"").toLowerCase().includes(q)
      );
    })
    .sort((a,b)=>new Date(b.createdDate)-new Date(a.createdDate));

  const totalPages = Math.ceil(filtered.length / vendorsPerPage);
  if(vendorPage > totalPages) vendorPage = totalPages || 1;

  filtered
    .slice((vendorPage-1)*vendorsPerPage, vendorPage*vendorsPerPage)
    .forEach((v,i)=>{

      const bal = vendorBalance(v);

      tbody.innerHTML+=`
      <tr>
        <td>${(vendorPage-1)*vendorsPerPage+i+1}</td>
        <td>${v.no}</td>
        <td>${v.name}</td>
        <td>â‚¨ ${money(bal)}</td>
        <td><button onclick="openVendorLedger('${v.id}')">Open</button></td>
        <td><button onclick="editVendor('${v.id}')">Edit</button></td>
        <td><button class="red" onclick="deleteVendor('${v.id}')">Delete</button></td>
      </tr>`;
    });
}

/* ===== PAGINATION ===== */
function nextVendorPage(){
  vendorPage++;
  renderVendors();
}

function prevVendorPage(){
  if(vendorPage>1){
    vendorPage--;
    renderVendors();
  }
}

/* ===== LEDGER (PURCHASE + PAYMENT + RETURN) ===== */
function openVendorLedger(vendorId){

  const v = DB.vendors.find(x=>x.id===vendorId);
  if(!v) return;

  const rows = [];

  DB.purchases.filter(p=>p.vendorId===v.id)
    .forEach(p=>{
      rows.push({date:p.dateTime,type:"Purchase",ref:p.id,debit:p.total,credit:0});
    });

DB.cash.filter(c=>c.vendor===v.name)
  .forEach(c=>{
    rows.push({
      date:c.dateTime,
      type: c.expense 
            ? (c.type==="OUT" ? "Payment (EXP)" : "Received (EXP)")
            : (c.type==="OUT" ? "Payment" : "Received"),
      ref:c.ref||c.id,
      debit: c.type==="OUT" ? c.amount : 0,
      credit: c.type==="IN" ? c.amount : 0
    });
  });
  DB.returns.filter(r=>r.vendorId===v.id)
    .forEach(r=>{
      rows.push({date:r.dateTime,type:"Return",ref:r.no,debit:0,credit:r.amount});
    });

  rows.sort((a,b)=>new Date(a.date)-new Date(b.date));

  let bal = 0;
  const printedAt = new Date().toLocaleString();

  const w = window.open("");
  w.document.write(`
<html>
<head>
<title>Vendor Ledger</title>
<style>
body{
  font-family:Arial;
  padding:40px;
}
.header{
  display:flex;
  justify-content:space-between;
  border-bottom:2px solid #000;
  padding-bottom:10px;
  margin-bottom:20px;
}
.company{
  font-size:22px;
  font-weight:900;
}
.sub{
  font-size:14px;
  margin-top:5px;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
}
th{
  background:#000;
  color:#fff;
  padding:8px;
}
td{
  border:1px solid #000;
  padding:8px;
  text-align:center;
}
.total{
  margin-top:25px;
  text-align:right;
  font-size:18px;
  font-weight:900;
}
.footer{
  margin-top:60px;
  display:flex;
  justify-content:space-between;
}
.sign{
  border-top:1px solid #000;
  width:200px;
  text-align:center;
  padding-top:5px;
}
</style>
</head>
<body>

<div class="header">
<div>
<div class="company">YOUR COMPANY NAME</div>
<div class="sub">Vendor Ledger Statement</div>
</div>
<div>
<div><b>Vendor:</b> ${v.name}</div>
<div><b>No:</b> ${v.no}</div>
<div><b>Printed:</b> ${new Date().toLocaleString()}</div>
</div>
</div>

<table>
<tr>
<th>#</th>
<th>Date</th>
<th>Type</th>
<th>Reference</th>
<th>Debit</th>
<th>Credit</th>
<th>Balance</th>
</tr>

${rows.map((r,i)=>{
  bal += r.debit - r.credit;
  return `
<tr>
<td>${i+1}</td>
<td>${new Date(r.date).toLocaleDateString()}</td>
<td>${r.type}</td>
<td>${r.ref}</td>
<td>${money(r.debit)}</td>
<td>${money(r.credit)}</td>
<td>${money(bal)}</td>
</tr>`;
}).join("")}

</table>

<div class="total">
Current Balance: â‚¨ ${money(bal)}
</div>

<div class="footer">
<div class="sign">Prepared By</div>
<div class="sign">Authorized Signature</div>
</div>

</body>
</html>
`);
w.print();
}

/* ===== CASH DROPDOWN ===== */
function loadVendorOptions(){
  const add = document.getElementById("payVendor");
  const filter = document.getElementById("cashVendorFilter");
  if(!add || !filter) return;

  add.innerHTML='<option value="">Select Vendor</option>';
  filter.innerHTML='<option value="">All Vendors</option>';

  DB.vendors.forEach(v=>{
    add.innerHTML+=`<option value="${v.id}">${v.name}</option>`;
    filter.innerHTML+=`<option value="${v.id}">${v.name}</option>`;
  });
}

/* ===== INIT ===== */
renderVendors();
loadVendorOptions();

</script>
<!-- ================= PURCHASE ================= -->

<style>
#purchase{
  width:100%;
  max-width:100%;
  margin:0;
  padding:20px;
  box-sizing:border-box;
}
  #purchase h3{color:var(--primary);margin:20px 0}
.p-block{border:1px solid var(--border);padding:20px;margin-bottom:30px;border-radius:12px}
.p-block{
  width:100%;
  box-sizing:border-box;
}

.p-table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
  table-layout:auto;
}

.p-table th,
.p-table td{
  padding:10px;
  border:1px solid var(--border);
  word-break:break-word;
}

@media (max-width:1024px){
  #purchase{
    padding:15px;
  }
}

@media (max-width:768px){
  .p-table{
    font-size:12px;
  }
}
  .p-table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}

.p-table th{
  background:#f8fafc;
  color:var(--primary);
  font-weight:600;
}

.p-table td,.p-table th{
  padding:10px;
  border:1px solid var(--border);
}
.suggest-box{position:absolute;background:#fff;border:1px solid var(--border);z-index:999;width:100%}
.suggest-box div{padding:8px;cursor:pointer}
.suggest-box .active,.suggest-box div:hover{background:#e8edf6}
.filter-row select{margin-right:10px}
</style>

<section id="purchase">

<div style="display:flex;justify-content:space-between;align-items:center">
  <h3>Purchase</h3>
  <div style="font-size:22px;font-weight:900">
    Purchase No: <span id="purchaseNo"></span>
  </div>
</div>

<!-- ===== VENDOR ===== -->
<div class="p-block">
<label>Vendor</label>
<select id="purchaseVendor" style="width:100%"></select>
</div>

<!-- ===== EXCEL ===== -->
<div class="p-block">
<label>Upload Excel</label>
<input type="file" accept=".xls,.xlsx" onchange="uploadPurchaseExcel(this)">
</div>

<!-- ===== ENTRY TABLE ===== -->
<div class="p-block">
<table class="p-table">
<thead>
<tr>
<th>Barcode</th>
<th>Item No</th>
<th>Description</th>
<th>Stock</th>
<th>Qty</th>
<th>Cost</th>
<th>Total</th>
<th></th>
</tr>
</thead>
<tbody id="purchaseRows"></tbody>
</table>

<button onclick="addPurchaseRow()">Add New Product</button>

<h3>Total: â‚¨ <span id="purchaseTotal">0.00</span></h3>
<div style="display:flex;gap:10px;margin-top:15px">
  <button onclick="savePurchase()">Save Purchase</button>
  <button onclick="cancelPurchase()" style="background:#dc2626;color:#fff">Cancel</button>
</div>
</div>

<!-- ================= PREVIOUS PURCHASE ================= -->

<div class="p-block">
<h3>Previous Purchases</h3>

<div class="filter-row" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">

<select id="filterVendor">
  <option value="">All Vendors</option>
</select>

<input type="date" id="filterFrom">
<input type="date" id="filterTo">

<input type="text" id="filterSearch" placeholder="Search Vendor / Purchase No">

<button onclick="applyPurchaseFilter()">Apply</button>
<button onclick="clearPurchaseFilter()">Clear</button>

</div>
</div>

<table class="p-table">
<thead>
<tr>
<th>No</th>
<th>Date & Time</th>
<th>Vendor</th>
<th>Amount</th>
<th>Print</th>
<th>Edit</th>
<th>Delete</th>
</tr>
</thead>
<tbody id="purchaseHistory"></tbody>
</table>

<div style="margin-top:15px">
<button onclick="prevPurchasePage()">â—€</button>
<span id="purchasePageInfo"></span>
<button onclick="nextPurchasePage()">â–¶</button>
</div>
</div>

</section>

<script>
let purchaseDraft=[];
let purchasePage=1;
const PER_PAGE=20;

function generatePurchaseNo(){
  let max = 0;
  (DB.purchases||[]).forEach(p=>{
    const n = parseInt((p.no||"").replace("PUR-",""));
    if(n>max) max=n;
  });
  purchaseNo.innerText = "PUR-" + String(max+1).padStart(5,"0");
}
function cancelPurchase(){
  if(!confirm("Cancel this purchase draft?")) return;

  purchaseDraft = [];
  addPurchaseRow();
  renderPurchaseRows();
}
/* ===== LOAD VENDORS ===== */
function loadPurchaseVendors(){
  purchaseVendor.innerHTML='<option value="">Select Vendor</option>';
  filterVendor.innerHTML='<option value="">All Vendors</option>';
  DB.vendors.forEach(v=>{
    purchaseVendor.innerHTML+=`<option value="${v.id}">${v.name}</option>`;
    filterVendor.innerHTML+=`<option value="${v.id}">${v.name}</option>`;
  });
}

/* ===== ADD ROW ===== */
function addPurchaseRow(){
  purchaseDraft.push({productId:null,barcode:"",itemNo:"",desc:"",qty:1,cost:0});
  renderPurchaseRows();
}

/* ===== RENDER ROW ===== */
function renderPurchaseRows(){
  purchaseRows.innerHTML="";
  let grand=0;

  purchaseDraft.forEach((r,i)=>{
    const p=DB.products.find(x=>x.id===r.productId);
    const stock=p?p.stock:0;
    const total=r.qty*r.cost;
    grand+=total;

    purchaseRows.innerHTML+=`
<tr>
<td><input value="${r.barcode}" oninput="searchProduct(this,${i})"></td>
<td><input value="${r.itemNo}" oninput="searchProduct(this,${i})"></td>
<td><input value="${r.desc}" oninput="searchProduct(this,${i})"></td>
<td>${stock}</td>
<td><input type="number" value="${r.qty}" onchange="setQty(${i},this.value)"></td>
<td><input type="number" value="${r.cost}" onchange="setCost(${i},this.value)" onkeydown="costTab(event,${i})"></td>
<td>${total.toLocaleString(undefined,{minimumFractionDigits:2})}</td>
<td><button onclick="removeRow(${i})">X</button></td>
</tr>`;
  });

  purchaseTotal.innerText=grand.toLocaleString(undefined,{minimumFractionDigits:2});
}

/* ===== SEARCH ===== */
function searchProduct(inp,i){
  if(!purchaseVendor.value){
  ruleMessage("You must select vendor first");
  return;
}
  document.querySelectorAll(".suggest-box").forEach(x=>x.remove());
  const val=inp.value.trim();
  if(val.length < 1) return;
  purchaseDraft[i].productId=null;   // IMPORTANT: reset

  if(!val)return;

  const list = (DB.products || []).filter(p =>
  (p.barcode || "").toLowerCase().includes(val.toLowerCase()) ||
  (p.itemNo || "").toLowerCase().includes(val.toLowerCase()) ||
  (p.desc || "").toLowerCase().includes(val.toLowerCase())
).slice(0,5);
  
  const box=document.createElement("div");
  box.className="suggest-box";
  box.className = "suggest-box";
box.style.position = "absolute";
box.style.left = inp.offsetLeft + "px";
box.style.top = (inp.offsetTop + inp.offsetHeight) + "px";
box.style.width = inp.offsetWidth + "px";

inp.closest("td").appendChild(box);
  
  if(!list.length){
    const d=document.createElement("div");
    d.innerText="âŒ No match found";
    d.style.color="red";
    box.appendChild(d);
    return;
  }

  list.forEach(p=>{
    const d=document.createElement("div");
    d.innerText=`${p.barcode} | ${p.itemNo} | ${p.desc}`;
    d.onclick=()=>selectProduct(i,p);
    box.appendChild(d);
  });
}

function selectProduct(i,p){
  if(purchaseDraft.some((x,idx)=>idx!==i && x.productId===p.id)){
    ruleMessage("This product already exists in purchase");
    return;
  }

  Object.assign(purchaseDraft[i],{
    productId:p.id,
    barcode:p.barcode,
    itemNo:p.itemNo,
    desc:p.desc
  });

  renderPurchaseRows();
}


document.addEventListener("click", (e) => {
  if(!e.target.closest(".suggest-box") && !e.target.closest("#purchaseRows")){
    document.querySelectorAll(".suggest-box").forEach(x=>x.remove());
  }
});

/* ===== UTILS ===== */
function setQty(i,v){
  if(v.includes(".")){
    ruleMessage("Decimal quantity not allowed");
    return;
  }
  purchaseDraft[i].qty = parseInt(v) || 1;
  renderPurchaseRows();
}
function setCost(i,v){purchaseDraft[i].cost=+v||0;renderPurchaseRows()}
function removeRow(i){purchaseDraft.splice(i,1);renderPurchaseRows()}
function costTab(e,i){if(e.key==="Tab"){e.preventDefault();if(i===purchaseDraft.length-1)addPurchaseRow()}}

/* ===== SAVE ===== */
function savePurchase(){
  if(!purchaseVendor || !purchaseVendor.value){
    alert("Select vendor");
    return;
  }

  if(!purchaseDraft.length){
    alert("No products added");
    return;
  }

  let total = 0;

  for(const r of purchaseDraft){
    if(!r.productId){
      alert("Invalid product detected. Select from list only.");
      return;
    }

    if(String(r.qty).includes(".")){
      ruleMessage("Decimal quantity not allowed");
      return;
    }

    const p = DB.products.find(x=>x.id===r.productId);
    if(!p) return alert("Product missing");

    p.stock += r.qty;
    total += r.qty * r.cost;
  }
const now = new Date();

DB.purchases.push({
  id: uid("PUR"),
  no: purchaseNo.innerText,
  vendorId: purchaseVendor.value,
  vendorName: DB.vendors.find(v=>v.id===purchaseVendor.value)?.name || "",
  date: now.toISOString().slice(0,10),
  time: now.toLocaleTimeString(),
  dateTime: now.toISOString(),
  user: (JSON.parse(sessionStorage.getItem("loggedInUser"))?.username || "Admin"),
  items: JSON.parse(JSON.stringify(purchaseDraft)),
  total
});

  saveDB();
  generatePurchaseNo();
  purchaseDraft = [];
  addPurchaseRow();
  renderPurchaseHistory();
}

/* ===== HISTORY ===== */
function renderPurchaseHistory(){

  purchaseHistory.innerHTML="";

  let list = [...(DB.purchases||[])];

  if(filterVendor.value)
    list = list.filter(p=>p.vendorId===filterVendor.value);

  if(filterFrom.value)
    list = list.filter(p=>p.date>=filterFrom.value);

  if(filterTo.value)
    list = list.filter(p=>p.date<=filterTo.value);

  if(filterSearch.value){
    const q = filterSearch.value.toLowerCase();
    list = list.filter(p=>
      (p.vendorName||"").toLowerCase().includes(q) ||
      (p.no||"").toLowerCase().includes(q)
    );
  }

  list = list.sort((a,b)=>new Date(b.dateTime)-new Date(a.dateTime));

  const pages=Math.max(1,Math.ceil(list.length/PER_PAGE));
  if(purchasePage>pages)purchasePage=pages||1;

  list.slice((purchasePage-1)*PER_PAGE,purchasePage*PER_PAGE)
.forEach(p=>{

  const no = p.no || "N/A";
  const vendor = p.vendorName || 
    (DB.vendors.find(v=>v.id===p.vendorId)?.name || "N/A");

  const dateTime = p.dateTime 
    ? new Date(p.dateTime).toLocaleString()
    : (p.date ? new Date(p.date).toLocaleDateString() : "N/A");

  const total = Number(p.total || 0).toLocaleString(undefined,{minimumFractionDigits:2});

  purchaseHistory.innerHTML+=`
  <tr>
    <td>${no}</td>
    <td>${dateTime}</td>
    <td>${vendor}</td>
    <td>${total}</td>
    <td><button onclick="printPurchase('${p.id}')">Print</button></td>
    <td><button onclick="editPurchase('${p.id}')">Edit</button></td>
    <td><button onclick="deletePurchase('${p.id}')">Delete</button></td>
  </tr>`;
});


  purchasePageInfo.innerText=`Page ${purchasePage} / ${pages||1}`;
}
function applyPurchaseFilter(){
  purchasePage = 1;
  renderPurchaseHistory();
}

function clearPurchaseFilter(){
  filterVendor.value = "";
  filterFrom.value = "";
  filterTo.value = "";
  filterSearch.value = "";
  purchasePage = 1;
  renderPurchaseHistory();
}
function editPurchase(id){
  const p=DB.purchases.find(x=>x.id===id);
  if(!p)return;

  if(!confirm("Editing will not reverse old stock automatically. Continue?")) return;

  purchaseVendor.value=p.vendorId;
  purchaseDraft=JSON.parse(JSON.stringify(p.items));
  renderPurchaseRows();
}
function printPurchase(id){

  const p = DB.purchases.find(x=>x.id===id);
  if(!p) return;

  const w = window.open("");
  let grand = 0;

  const rows = p.items.map((it,i)=>{
    const amt = it.qty * it.cost;
    grand += amt;
    const prod = DB.products.find(x=>x.itemNo===it.itemNo);
return `
<tr>
<td>${index+1}</td>
<td>${it.itemNo}</td>
<td>${prod?.desc || ""}</td>
<td>${it.qty}</td>
<td>${Number(it.cost).toFixed(2)}</td>
<td>${Number(amt).toFixed(2)}</td>
</tr>`;
  }).join("");

  const html = `
<html>
<head>
<title>Purchase Invoice</title>
<style>
body{font-family:Arial;padding:30px}
.header{display:flex;justify-content:space-between;margin-bottom:20px}
.title{font-size:24px;font-weight:900}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #000;padding:8px;text-align:center}
th{background:#f2f2f2}
.total{margin-top:20px;text-align:right;font-size:18px;font-weight:900}
.footer{margin-top:60px;display:flex;justify-content:space-between}
.sign{border-top:1px solid #000;width:200px;text-align:center;padding-top:5px}
</style>
</head>
<body>

<div class="header">
<div>
<div class="title">PURCHASE INVOICE</div>
<div><b>No:</b> ${p.no}</div>
<div><b>Date:</b> ${new Date(p.dateTime).toLocaleString()}</div>
<div><b>Vendor:</b> ${p.vendorName}</div>
</div>
</div>

<table>
<thead>
<tr>
<th>#</th>
<th>Item No</th>
<th>Description</th>
<th>Qty</th>
<th>Cost</th>
<th>Amount</th>
</tr>
</thead>
<tbody>
${rows}
</tbody>
</table>

<div class="total">
Grand Total: ${Number(grand).toFixed(2)}
</div>

<div class="footer">
<div class="sign">Authorized Signature</div>
<div class="sign">Received By</div>
</div>

</body>
</html>
`;

  w.document.write(html);
  w.document.close();
  w.focus();
  w.print();
}

function deletePurchase(id){
  const p = DB.purchases.find(x=>x.id===id);
  if(!p) return;

  if(!confirm("Delete this purchase? Stock will be reversed.")) return;

  // reverse stock
  p.items.forEach(it=>{
    const prod = DB.products.find(x=>x.id===it.productId);
    if(prod){
      prod.stock -= it.qty;
    }
  });

  DB.purchases = DB.purchases.filter(x=>x.id!==id);

  saveDB();
  renderPurchaseHistory();
}

/* ===== EXCEL ===== */
function uploadPurchaseExcel(input){
  const r=new FileReader();
  r.onload=e=>{
    const wb=XLSX.read(e.target.result,{type:"binary"});
    XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]).forEach(row=>{
      const p=DB.products.find(x=>x.barcode==row.Barcode||x.itemNo==row["Item No"]||x.desc==row.Description);
      if(!p)return;
      purchaseDraft.push({productId:p.id,barcode:p.barcode,itemNo:p.itemNo,desc:p.desc,qty:+row.Qty||0,cost:+row.Cost||0});
    });
    renderPurchaseRows();
  };
  r.readAsBinaryString(input.files[0]);
}

/* ===== INIT ===== */
loadPurchaseVendors();
generatePurchaseNo();
addPurchaseRow();
renderPurchaseHistory();
</script>
<script>
DB.logs = DB.logs || [];

function openReport(type){
  document.querySelectorAll(".report-page").forEach(d=>d.style.display="none");
  document.getElementById(type+"Report").style.display="block";
}

/* ===== GET COST FROM LAST PURCHASE ===== */
function getPurchaseCost(productId, invDate){
  let lastCost = 0;

  (DB.purchases||[])
    .filter(p=>new Date(p.date)<=new Date(invDate))
    .sort((a,b)=>new Date(a.date)-new Date(b.date))
    .forEach(p=>{
      p.items.forEach(it=>{
        if(it.productId===productId){
          lastCost = Number(it.cost)||0;
        }
      });
    });

  return lastCost;
}



/* ===== LOAD USERS ===== */
 document.addEventListener("DOMContentLoaded",()=>{

  [...new Set((DB.logs||[]).map(l=>l.user))].forEach(u=>{
    profitUser.innerHTML+=`<option>${u}</option>`;
    delUser.innerHTML+=`<option>${u}</option>`;
  });

  loadProfitFilters();   // âœ… ADD THIS LINE HERE

});
</script>
<!-- ================= LOGIN ================= -->
<section id="loginScreen" style="display:flex; align-items:center; justify-content:center; height:100vh; background:#f5f5f5; flex-direction:column;">
  <h1>Login</h1>
  <input type="text" id="loginUsername" placeholder="Username" style="margin:5px; padding:8px; width:200px;">
  <input type="password" id="loginPassword" placeholder="Password" style="margin:5px; padding:8px; width:200px;">
  <button onclick="submitLogin()" style="padding:8px 15px; margin-top:10px;">Login</button>
  <div id="loginError" style="color:red; margin-top:10px;"></div>
</section>

<!-- ================= SETTINGS ================= -->
<section id="settings" style="display:none; padding:20px;">
  <h2>Settings</h2>

  <!-- Software Name -->
  <div class="p-block">
    <h3>Software Name</h3>
    <input type="text" id="setSoftwareName" placeholder="Software Name" style="width:100%; margin-bottom:10px;">
    <button onclick="saveSoftwareName()">Save Name</button>
  </div>

  <!-- Upload Logo -->
  <div class="p-block">
    <h3>Upload Logo</h3>
    <input type="file" onchange="uploadLogo(this)">
  </div>

  <!-- Shop Location -->
  <div class="p-block">
    <h3>Shop Location</h3>
    <input type="text" id="shopLocation" placeholder="Enter shop location" style="width:100%; margin-bottom:10px;">
    <button onclick="saveShopLocation()">Save Location</button>
  </div>

  <!-- Font & Color -->
  <div class="p-block">
    <h3>Change Font & Color</h3>
    <label>Font:</label>
    <select id="softwareFont" style="margin-bottom:10px;">
      <option value="Arial">Arial</option>
      <option value="Verdana">Verdana</option>
      <option value="Tahoma">Tahoma</option>
      <option value="Times New Roman">Times New Roman</option>
      <option value="Georgia">Georgia</option>
      <option value="Courier New">Courier New</option>
      <option value="Helvetica">Helvetica</option>
      <option value="Roboto">Roboto</option>
      <option value="Lato">Lato</option>
      <option value="Open Sans">Open Sans</option>
    </select>
    <br>
    <label>Color:</label>
    <input type="color" id="softwareColor" value="#1e1e1e">
    <button onclick="saveFontAndColor()">Apply</button>
  </div>

  <!-- Account Management -->
  <div class="p-block">
    <h3>Manage Accounts / Roles</h3>
    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px;">
      <input type="text" id="newUsername" placeholder="Username">
      <input type="password" id="newPassword" placeholder="Password">
      <select id="newRole">
        <option value="admin">Admin</option>
        <option value="staff">Staff</option>
        <option value="developer">Developer</option>
      </select>
      <select id="newPermissions" multiple style="height:100px;">
        <option value="invoice">Invoice</option>
        <option value="cash">Cash In Hand</option>
        <option value="vendors">Vendors</option>
        <option value="products">Products</option>
        <option value="settings">Settings</option>
        <option value="reports">Reports</option>
      </select>
      <button onclick="createAccount()">Create Account</button>
    </div>

    <table style="width:100%; margin-top:10px;">
      <thead>
        <tr>
          <th>Username</th>
          <th>Role</th>
          <th>Permissions</th>
          <th>Edit</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody id="accountsTable"></tbody>
    </table>
  </div>

  <!-- Backup / Restore / Reset -->
  <div class="p-block">
    <h3>Backup / Restore / Reset</h3>
    <button onclick="downloadBackup()">Download Backup</button>
    <input type="file" onchange="restoreBackup(this)">
    <button onclick="resetSystem()">Reset System</button>
  </div>
</section>

<script>
/* ===== INIT DEFAULT DEVELOPER ACCOUNT ===== */
if(!DB.accounts){
  DB.accounts=[{id: uid("A"), username:"Dani", password:"7525", role:"developer", fixed:true, permissions:[]}];
  saveDB();
}

/* ===== LOGIN SYSTEM ===== */
function submitLogin(){

  const u = loginUsername.value.trim();
  const p = loginPassword.value.trim();

  const user = (DB.accounts || []).find(x=>x.username===u && x.password===p);

  if(!user){
    loginError.innerText = "Invalid Username or Password";
    return;
  }

  sessionStorage.setItem("loggedInUser", JSON.stringify(user));

  document.getElementById("loginScreen").style.display = "none";

  renderSectionsByPermission();
  openTab("invoice");
}

/* ===== PERSIST LOGIN ===== */
document.addEventListener("DOMContentLoaded", ()=>{
  const acc = sessionStorage.getItem("loggedInUser");

  if(!acc){
    document.querySelectorAll("section").forEach(s=>{
      if(s.id!=="loginScreen") s.style.display="none";
    });
    return;
  }

  document.getElementById("loginScreen").style.display="none";
  renderSectionsByPermission();
  openTab("invoice");
});

/* ===== RENDER SECTIONS BASED ON PERMISSIONS ===== */
function renderSectionsByPermission(){
  const user=JSON.parse(sessionStorage.getItem("loggedInUser"));
  document.querySelectorAll("section").forEach(s=>{
    if(s.id==="loginScreen") return;
    if(!hasAccessSection(user,s.id)) s.style.display="none";
    else s.style.display="block";
  });
}

function hasAccessSection(user,sectionId){
  if(user.role==="developer") return true;
  switch(sectionId){
    case "invoice": return user.permissions.includes("invoice");
    case "cash": return user.permissions.includes("cash");
    case "vendors": return user.permissions.includes("vendors");
    case "products": return user.permissions.includes("products");
    case "settings": return user.permissions.includes("settings");
    case "reports": return user.permissions.includes("reports");
    default: return true;
  }
}

/* ===== CHECK PERMISSIONS ===== */
function hasAccess(feature){
  const user=JSON.parse(sessionStorage.getItem("loggedInUser"));
  if(!user) return false;
  if(user.role==="developer") return true;
  return user.permissions && user.permissions.includes(feature);
}

/* ===== CREATE ACCOUNT ===== */
function createAccount(){
  const username=document.getElementById("newUsername").value.trim();
  const password=document.getElementById("newPassword").value.trim();
  const role=document.getElementById("newRole").value;
  const perms=Array.from(document.getElementById("newPermissions").selectedOptions).map(x=>x.value);

  if(!username || !password || !role) return alert("Please fill all fields");
  if(DB.accounts.find(x=>x.username===username)) return alert("Username exists");

  DB.accounts.push({id: uid("A"), username, password, role, permissions:perms});
  saveDB();
  renderAccounts();

  document.getElementById("newUsername").value="";
  document.getElementById("newPassword").value="";
  document.getElementById("newRole").value="admin";
  document.getElementById("newPermissions").selectedIndex=-1;
}

/* ===== RENDER ACCOUNTS TABLE ===== */
function renderAccounts(){
  const tbody=document.getElementById("accountsTable");
  tbody.innerHTML="";
  DB.accounts.forEach(a=>{
    tbody.innerHTML+=`
      <tr>
        <td>${a.username}</td>
        <td>${a.role}</td>
        <td>${(a.permissions||[]).join(", ")}</td>
        <td><button onclick="editAccount('${a.id}')">Edit</button></td>
        <td>${a.fixed?"":`<button onclick="deleteAccount('${a.id}')">Delete</button>`}</td>
      </tr>
    `;
  });
}

/* ===== EDIT ACCOUNT ===== */
function editAccount(id){
  const acc=DB.accounts.find(x=>x.id===id);
  if(!acc) return alert("Account not found");
  if(acc.fixed) return alert("Cannot edit developer account");

  const username=prompt("Username:", acc.username);
  const password=prompt("Password:", acc.password);
  const role=prompt("Role:", acc.role);
  const perms=prompt("Permissions (comma separated):", (acc.permissions||[]).join(","));

  if(username) acc.username=username;
  if(password) acc.password=password;
  if(role) acc.role=role;
  acc.permissions=perms?perms.split(",").map(x=>x.trim()):[];
  saveDB();
  renderAccounts();
}

/* ===== DELETE ACCOUNT ===== */
function deleteAccount(id){
  const acc=DB.accounts.find(x=>x.id===id);
  if(!acc || acc.fixed) return alert("Cannot delete this account");
  if(!confirm("Delete this account?")) return;
  DB.accounts=DB.accounts.filter(x=>x.id!==id);
  saveDB();
  renderAccounts();
}

/* ===== FONT & COLOR ===== */
function saveFontAndColor(){
  if(!DB.settings) DB.settings={};
  const font=document.getElementById("softwareFont").value;
  const color=document.getElementById("softwareColor").value;
  DB.settings.font=font;
  DB.settings.color=color;
  saveDB();
  document.body.style.fontFamily=font;
  document.documentElement.style.setProperty('--primary', color);
  alert("Font & color applied");
}
document.addEventListener("DOMContentLoaded", ()=>{
  if(DB.settings){
    if(DB.settings.font) document.body.style.fontFamily=DB.settings.font;
    if(DB.settings.color) document.documentElement.style.setProperty('--primary', DB.settings.color);
  }
});

/* ===== SHOP LOCATION ===== */
function saveShopLocation(){
  if(!DB.settings) DB.settings={};
  const loc=document.getElementById("shopLocation").value.trim();
  DB.settings.shopLocation=loc;
  saveDB();
  alert("Shop location saved");
}

/* ===== SOFTWARE NAME ===== */
function saveSoftwareName(){
  if(!DB.settings) DB.settings={};
  const name=document.getElementById("setSoftwareName").value.trim();
  DB.settings.softwareName=name||"Dani Test Software";
  saveDB();
  alert("Software name updated");
}
/* ===== LOGO ===== */
function uploadLogo(input){
  if(!input.files[0]) return;

  if(!DB.settings) DB.settings={};

  const reader = new FileReader();
  reader.onload = ()=>{
    DB.settings.logo = reader.result;
    saveDB();
    alert("Logo saved");
    location.reload();
  };
  reader.readAsDataURL(input.files[0]);
}

/* ===== BACKUP / RESTORE / RESET ===== */
function downloadBackup(){
  const blob=new Blob([JSON.stringify(DB,null,2)], {type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="dani_backup_"+Date.now()+".json";
  a.click();
}

function restoreBackup(input){
  const file=input.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      DB=JSON.parse(e.target.result);
      saveDB();
      location.reload();
    }catch{
      alert("Invalid backup file");
    }
  };
  reader.readAsText(file);
}

function resetSystem(){
  if(!confirm("Backup will be downloaded automatically. Continue reset?")) return;
  downloadBackup();
  DB={
    products:[],
    vendors:[],
    purchases:[],
    invoices:[],
    cash:[],
    deleted:[],
    accounts:DB.accounts,
    settings:{softwareName:"Dani Test Software", logo:""}
  };
  saveDB();
  location.reload();
}
let editingCashId = null;

function saveCashPayment(){

  const date = document.getElementById("payDate").value || new Date().toISOString().split("T")[0];
  const vendorId = document.getElementById("payVendor").value;
  const type = document.getElementById("payType").value;
  const ref = document.getElementById("payRef").value || "";
  const amount = +document.getElementById("payAmount").value;
  const isExpense = document.getElementById("isExpense")?.checked || false;

  if(!vendorId) return alert("Select vendor");
  if(!amount || amount<=0) return alert("Enter valid amount");

  const vendorObj = DB.vendors.find(v=>v.id===vendorId);

  const obj = {
    id: editingCashId || uid("C"),
    date,
    vendorId,
    vendorName: vendorObj?.name || "",
    type,
    ref,
    amount,
    isExpense,
    dateTime:new Date().toISOString()
  };

  if(editingCashId){
    const index = DB.cash.findIndex(x=>x.id===editingCashId);
    DB.cash[index]=obj;
  }else{
    DB.cash.push(obj);
    DB.vendorLedger.push({
  id: uid("VL"),
  vendorId: obj.vendorId,
  vendorName: obj.vendorName,
  type: "Payment",
  amount: obj.amount,
  expense: obj.isExpense || false,
  date: obj.date
});
  }

  // ADD TO VENDOR LEDGER
  DB.vendorLedger = DB.vendorLedger || [];

  DB.vendorLedger.push({
    id:uid("VL"),
    vendorId,
    vendorName: vendorObj?.name || "",
    type:"Payment",
    ref:ref || obj.id,
    debit: type==="OUT" ? amount : 0,
    credit: type==="IN" ? amount : 0,
    expense:isExpense,
    date:new Date().toISOString()
  });

  saveDB();
  editingCashId=null;

  document.getElementById("payRef").value="";
  document.getElementById("payAmount").value="";

  renderCash();
}
/* ===== INITIAL RENDER ===== */
renderAccounts();

/* ===== DATE & TIME ===== */
function updateTime(){
  const now=new Date();
  const el=document.getElementById("dateTime");
  if(el) el.innerText=now.toLocaleString();
}
setInterval(updateTime,1000);
updateTime();
/* ===== APPLY HEADER SETTINGS ===== */
document.addEventListener("DOMContentLoaded", ()=>{
  if(!DB.settings) return;

  const nameEl = document.getElementById("softwareName");
  const logoEl = document.getElementById("header-logo");

  if(nameEl){
    nameEl.textContent = DB.settings.softwareName || "";
  }

  if(logoEl && DB.settings.logo){
    logoEl.src = DB.settings.logo;
    logoEl.style.display = "block";
  }
});
</script>
<!-- ================= MENU LOGIC ================= -->
<script>
/* ===== OPEN TAB FUNCTION WITH UNDERLINE ANIMATION ===== */
function openTab(id){
  // Hide all sections
  document.querySelectorAll("section").forEach(s => s.style.display = "none");

  // Show the selected section
  const sec = document.getElementById(id);
  if(sec) sec.style.display = "block";

  // Update menu active state
  document.querySelectorAll("#mainMenu .menuItem").forEach(d => d.classList.remove("active"));
  const tab = document.getElementById("tab-" + id);
  if(tab) tab.classList.add("active");

  // Animate underline
  const underline = document.getElementById("menuUnderline");
  if(tab && underline){
    const rect = tab.getBoundingClientRect();
    const parentRect = tab.parentElement.getBoundingClientRect();
    underline.style.width = rect.width + "px";
    underline.style.left = (rect.left - parentRect.left) + "px";
  }
}

/* ===== ADJUST UNDERLINE ON WINDOW RESIZE ===== */
window.addEventListener("resize", () => {
  const active = document.querySelector("#mainMenu .menuItem.active");
  const underline = document.getElementById("menuUnderline");
  if(active && underline){
    const rect = active.getBoundingClientRect();
    const parentRect = active.parentElement.getBoundingClientRect();
    underline.style.width = rect.width + "px";
    underline.style.left = (rect.left - parentRect.left) + "px";
  }
});

/* ===== OPEN DEFAULT TAB ON PAGE LOAD ===== */
document.addEventListener("DOMContentLoaded", () => {
  const activeTab = document.querySelector("#mainMenu .menuItem.active");
  if(!activeTab) document.getElementById("tab-invoice").click();
});
/* ================= MENU UNDERLINE HARD LOCK ================= */

/* Lock menu height so nothing can push it */
#mainMenu{
  height:52px !important;
  align-items:center !important;
  overflow:hidden !important;
}
</script>
<script>
DB.logs = DB.logs || [];

function openReport(type){
  document.querySelectorAll(".report-page").forEach(d=>d.style.display="none");
  document.getElementById(type+"Report").style.display="block";
}

/* ===== GET COST FROM LAST PURCHASE ===== */
function getPurchaseCost(productId, invDate){
  let lastCost = 0;

  (DB.purchases||[])
    .filter(p=>new Date(p.date)<=new Date(invDate))
    .sort((a,b)=>new Date(a.date)-new Date(b.date))
    .forEach(p=>{
      p.items.forEach(it=>{
        if(it.productId===productId){
          lastCost = Number(it.cost)||0;
        }
      });
    });

  return lastCost;
}



/* ===== LOAD USERS ===== */
document.addEventListener("DOMContentLoaded",()=>{
  [...new Set((DB.logs||[]).map(l=>l.user))].forEach(u=>{
    profitUser.innerHTML+=`<option>${u}</option>`;
    delUser.innerHTML+=`<option>${u}</option>`;
  });
});
</script>
<!-- ================= REPORTS ================= -->

<section id="reports">


  <!-- ===== NORMAL REPORTS ===== -->
  <div class="card">
    <h2>Reports</h2>

    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-top:20px;">

      <div class="card" style="cursor:pointer" onclick="openProductDetailsReport()">
        <h3>ðŸ“¦ Product Details</h3>
        <p>Stock movement, vendor filter & ranking</p>
      </div>

    </div>
  </div>


  <!-- ===== ADMIN REPORTS ===== -->
  <div class="card" id="adminReportSection" style="margin-top:30px;">
    <h2>Admin Reports</h2>
<button onclick="openReport('profit')">Profit Report</button>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-top:20px;">

      <div class="card" style="cursor:pointer" onclick="openInvoiceProfitReport()">
        <h3>ðŸ“Š Invoice Wise Profit</h3>
        <p>Profit by invoice, date & user</p>
      </div>

      <div class="card" style="cursor:pointer" onclick="openDeletedDataReport()">
        <h3>ðŸ—‘ Deleted Data Log</h3>
        <p>Who deleted, when & what</p>
      </div>

    </div>
  </div>
<div id="profitReport" class="report-page" style="display:none">

<h2>Advanced Profit Report</h2>

<div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px">

<input type="date" id="profitFrom">
<input type="date" id="profitTo">

<select id="profitProduct">
<option value="">All Products</option>
</select>

<select id="profitVendor">
<option value="">All Vendors</option>
</select>

<select id="profitAccount">
<option value="">All Accounts</option>
</select>

<button onclick="generateAdvancedProfit()">Generate</button>

</div>

<h3>Summary</h3>

<table class="p-table">
<tr><th>Total Sales</th><td id="pfSales">0.00</td></tr>
<tr><th>COGS</th><td id="pfCogs">0.00</td></tr>
<tr><th>Gross Profit</th><td id="pfGross">0.00</td></tr>
<tr><th>Expenses</th><td id="pfExpense">0.00</td></tr>
<tr><th>Net Profit</th><td id="pfNet">0.00</td></tr>
<tr><th>Profit %</th><td id="pfPercent">0%</td></tr>
</table>

<h3>Detail</h3>
<table class="p-table">
<thead>
<tr>
<th>Date</th>
<th>Invoice</th>
<th>Product</th>
<th>Qty</th>
<th>Sale</th>
<th>Cost</th>
<th>Profit</th>
</tr>
</thead>
<tbody id="profitDetailRows"></tbody>
</table>

</div>
  <!-- ===== REPORT OUTPUT BLOCKS ===== -->
  <div id="productDetailsReport" class="card" style="display:none;margin-top:20px;"></div>
  <div id="invoiceProfitReport" class="card" style="display:none;margin-top:20px;"></div>
  <div id="deletedDataReport" class="card" style="display:none;margin-top:20px;"></div>

</section>
<script>
function openReport(name){

  document.querySelectorAll(".report-page").forEach(d=>{
    d.style.display="none";
  });

  const el = document.getElementById(name+"Report");
  if(el) el.style.display="block";
}
/* ================= MASTER FIFO PROFIT ENGINE ================= */


  /* ===== EXPENSE CALCULATION ===== */

  let totalExpense = 0;

  (DB.cash || []).forEach(c => {
    if(!c.isExpense) return;
    const d = c.date.split("T")[0];
    if(from && d < from) return;
    if(to && d > to) return;
    totalExpense += Number(c.amount || 0);
  });

  /* ===== EXPENSE DISTRIBUTION BY SALES RATIO ===== */

  let netProfit = grossProfit - totalExpense;

  const profitPercent = totalSales > 0
    ? (netProfit / totalSales) * 100
    : 0;

  /* ===== UPDATE SUMMARY ===== */

  document.getElementById("pfSales").innerText   = totalSales.toFixed(2);
  document.getElementById("pfCogs").innerText    = totalCOGS.toFixed(2);
  document.getElementById("pfGross").innerText   = grossProfit.toFixed(2);
  document.getElementById("pfExpense").innerText = totalExpense.toFixed(2);
  document.getElementById("pfNet").innerText     = netProfit.toFixed(2);
  document.getElementById("pfPercent").innerText = profitPercent.toFixed(2) + "%";

  /* ===== DETAIL TABLE ===== */

  const tbody = document.getElementById("profitDetailRows");
  tbody.innerHTML = "";

  detailRows.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.date}</td>
      <td>${r.invoice}</td>
      <td>${r.product}</td>
      <td>${r.qty}</td>
      <td>${r.sale.toFixed(2)}</td>
      <td>${r.cost.toFixed(2)}</td>
      <td>${r.gross.toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  });

}

/* ================= MASTER ACCURATE FIFO PROFIT ENGINE ================= */

function generateAdvancedProfit(){

  const from = document.getElementById("profitFrom").value;
  const to   = document.getElementById("profitTo").value;
  const productFilter = document.getElementById("profitProduct").value;
  const vendorFilter  = document.getElementById("profitVendor").value;
  const accountFilter = document.getElementById("profitAccount").value;

  /* ===== FILTER INVOICES ===== */

  let invoices = (DB.invoices || []).filter(inv => {
    if(from && inv.date < from) return false;
    if(to && inv.date > to) return false;
    if(accountFilter && inv.user !== accountFilter) return false;
    return true;
  });

  /* ===== BUILD FIFO STOCK MAP ===== */

  const fifoMap = buildFifoStock();

  let totalSales = 0;
  let totalCOGS  = 0;
  let detailRows = [];

  invoices.sort((a,b)=> new Date(a.date) - new Date(b.date));

  invoices.forEach(inv => {

    inv.items.forEach(item => {

      const product = DB.products.find(p => p.id === item.productId);
      if(!product) return;

      if(productFilter && product.id !== productFilter) return;
      if(vendorFilter && product.vendorId !== vendorFilter) return;

      const saleAmount = item.qty * item.rate;
      const costAmount = consumeFIFO(fifoMap, product.id, item.qty);

      totalSales += saleAmount;
      totalCOGS  += costAmount;

      detailRows.push({
        date: inv.date,
        invoice: inv.no,
        product: product.desc,
        qty: item.qty,
        sale: saleAmount,
        cost: costAmount,
        gross: saleAmount - costAmount
      });

    });

  });

  const grossProfit = totalSales - totalCOGS;

  /* ===== EXPENSE CALCULATION ===== */

  let totalExpense = 0;

  (DB.cash || []).forEach(c => {
    if(!c.isExpense) return;
    const d = c.date.split("T")[0];
    if(from && d < from) return;
    if(to && d > to) return;
    totalExpense += Number(c.amount || 0);
  });

  /* ===== EXPENSE DISTRIBUTION BY SALES RATIO ===== */

  detailRows.forEach(r=>{
    const ratio = totalSales > 0 ? r.sale / totalSales : 0;
    const expenseShare = totalExpense * ratio;
    r.net = r.gross - expenseShare;
  });

  const netProfit = grossProfit - totalExpense;
  const profitPercent = totalSales > 0
    ? (netProfit / totalSales) * 100
    : 0;

  /* ===== UPDATE SUMMARY ===== */

  document.getElementById("pfSales").innerText   = totalSales.toFixed(2);
  document.getElementById("pfCogs").innerText    = totalCOGS.toFixed(2);
  document.getElementById("pfGross").innerText   = grossProfit.toFixed(2);
  document.getElementById("pfExpense").innerText = totalExpense.toFixed(2);
  document.getElementById("pfNet").innerText     = netProfit.toFixed(2);
  document.getElementById("pfPercent").innerText = profitPercent.toFixed(2) + "%";

  /* ===== DETAIL TABLE ===== */

  const tbody = document.getElementById("profitDetailRows");
  tbody.innerHTML = "";

  detailRows.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.date}</td>
      <td>${r.invoice}</td>
      <td>${r.product}</td>
      <td>${r.qty}</td>
      <td>${r.sale.toFixed(2)}</td>
      <td>${r.cost.toFixed(2)}</td>
      <td>${r.net.toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  });

}

/* ================= BUILD FIFO STOCK ================= */

function buildFifoStock(){

  const map = {};

  const purchases = (DB.purchases || [])
    .sort((a,b)=> new Date(a.dateTime) - new Date(b.dateTime));

  purchases.forEach(p=>{
    p.items.forEach(it=>{

      if(!map[it.productId]) map[it.productId] = [];

      map[it.productId].push({
        qty: Number(it.qty),
        cost: Number(it.cost)
      });

    });
  });

  return map;
}

/* ================= CONSUME FIFO ================= */

function consumeFIFO(map, productId, qty){

  let remaining = qty;
  let totalCost = 0;

  const layers = map[productId] || [];

  for(let layer of layers){

    if(remaining <= 0) break;
    if(layer.qty <= 0) continue;

    const used = Math.min(layer.qty, remaining);

    totalCost += used * layer.cost;

    layer.qty -= used;
    remaining -= used;
  }

  return totalCost;
}
</script>
