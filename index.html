<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title id="softwareName">Dani Test Software</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
:root{--primary:#0b2a4a;--secondary:#143a63;--border:#d0d7e2;}
*{box-sizing:border-box;}
body{margin:0;font-family:Segoe UI,Arial;background:#fff;color:#111;}
header{background:var(--primary);color:#fff;padding:16px 24px;font-size:22px;font-weight:600;}
nav{display:flex;background:var(--secondary);}
nav div{padding:14px 20px;color:#fff;cursor:pointer;border-right:1px solid rgba(255,255,255,.15);}
nav div.active{background:#fff;color:var(--primary);font-weight:600;}
section{display:none;padding:24px;}
section.active{display:block;}
.card{background:#fff;border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px;}
table{width:100%;border-collapse:collapse;}
th,td{border:1px solid var(--border);padding:8px;text-align:center;}
th{background:#f3f6fb;}
button{padding:8px 14px;cursor:pointer;border-radius:6px;border:1px solid var(--primary);background:var(--primary);color:#fff;}
.secondary{background:#fff;color:var(--primary);}
input,select{padding:7px;width:100%;border:1px solid var(--border);border-radius:4px;}
</style>
</head>

<body>
<header id="headerTitle">Dani Test Software</header>

<nav>
<div id="tab-invoice" onclick="openTab('invoice')">Invoice</div>
<div id="tab-cash" onclick="openTab('cash')">Cash In Hand</div>
<div id="tab-purchase" onclick="openTab('purchase')">Purchase</div>
<div id="tab-products" onclick="openTab('products')">Products</div>
<div id="tab-vendors" onclick="openTab('vendors')">Vendor</div>
<div id="tab-reports" onclick="openTab('reports')">Reports</div>
<div id="tab-settings" onclick="openTab('settings')">Settings</div>
</nav>

<script>
const DB={
products:JSON.parse(localStorage.getItem("products")||"[]"),
vendors:JSON.parse(localStorage.getItem("vendors")||"[]"),
purchases:JSON.parse(localStorage.getItem("purchases")||"[]"),
invoices:JSON.parse(localStorage.getItem("invoices")||"[]"),
cash:JSON.parse(localStorage.getItem("cash")||"[]"),
settings:JSON.parse(localStorage.getItem("settings")||"{}")
};
function saveDB(){for(let k in DB)localStorage.setItem(k,JSON.stringify(DB[k]));}
function uid(p){return p+"_"+Date.now()+Math.floor(Math.random()*1000);}
</script>

<!-- ================= PRODUCTS ================= -->
<section id="products">
<div class="card">
<h2>Products</h2>

<div style="display:flex;gap:8px;margin-bottom:10px;">
<input id="pBarcode" placeholder="Barcode">
<input id="pItemNo" placeholder="Item No">
<input id="pDesc" placeholder="Description">
<input id="pRate" placeholder="Retail Rate" type="number">
<button onclick="addManualProduct()">Add Product</button>
</div>

<input type="file" accept=".xlsx,.xls" onchange="uploadProductExcel(this)">
<button onclick="exportProductsCSV()">Download Products</button>

<table>
<thead>
<tr><th>S No</th><th>Barcode</th><th>Item No</th><th>Description</th><th>Rate</th><th>Stock</th><th>Actions</th></tr>
</thead>
<tbody id="productRows"></tbody>
</table>
</div>
</section>

<!-- PRODUCTS SCRIPT (UNCHANGED) -->
<script>
/* SAME AS YOUR CODE – NOT MODIFIED */
</script>

<!-- ================= VENDORS ================= -->
<section id="vendors">
<div class="card">
<h2>Vendors</h2>
<button onclick="addVendor()">Add Vendor</button>
<table>
<thead><tr><th>S No</th><th>Name</th><th>Actions</th></tr></thead>
<tbody id="vendorRows"></tbody>
</table>
</div>
</section>

<script>
/* SAME AS YOUR CODE – NOT MODIFIED */
</script>

<!-- ================= PURCHASE ================= -->
<section id="purchase">
<div class="card">
<h2>Purchase</h2>

<select id="purchaseVendor"></select>

<div style="display:flex;gap:8px;margin-bottom:8px;">
<select id="purchaseProduct"></select>
<input id="purchaseQty" type="number" placeholder="Qty">
<input id="purchaseCost" type="number" placeholder="Cost">
<button onclick="addPurchaseItem()">Add</button>
</div>

<input type="file" accept=".xlsx,.xls" onchange="uploadPurchaseExcel(this)">

<table>
<thead><tr><th>Item</th><th>Qty</th><th>Cost</th><th>Total</th></tr></thead>
<tbody id="purchaseRows"></tbody>
</table>

<button onclick="savePurchase()">Save Purchase</button>

<h3>Previous Purchases</h3>
<table>
<thead>
<tr><th>ID</th><th>Date</th><th>Total</th><th>Actions</th></tr>
</thead>
<tbody id="oldPurchases"></tbody>
</table>
</div>
</section>

<script>
let purchaseDraft=[];

function loadPurchaseDropdowns(){
purchaseVendor.innerHTML=DB.vendors.map(v=>`<option value="${v.id}">${v.name}</option>`).join("");
purchaseProduct.innerHTML=DB.products.map(p=>`<option value="${p.id}">${p.itemNo}</option>`).join("");
}

function addPurchaseItem(){
purchaseDraft.push({
productId:purchaseProduct.value,
qty:+purchaseQty.value,
cost:+purchaseCost.value
});
renderPurchase();
}

function renderPurchase(){
purchaseRows.innerHTML="";
let total=0;
purchaseDraft.forEach(r=>{
let p=DB.products.find(x=>x.id===r.productId);
let t=r.qty*r.cost;
total+=t;
purchaseRows.innerHTML+=`<tr><td>${p.itemNo}</td><td>${r.qty}</td><td>${r.cost}</td><td>${t}</td></tr>`;
});

oldPurchases.innerHTML="";
DB.purchases.forEach(p=>{
oldPurchases.innerHTML+=`
<tr>
<td>${p.id}</td>
<td>${p.date}</td>
<td>${p.total}</td>
<td>
<button onclick="editPurchase('${p.id}')">Edit</button>
<button onclick="deletePurchase('${p.id}')">Delete</button>
</td>
</tr>`;
});
}

function savePurchase(){
let pur={id:uid("PUR"),vendorId:purchaseVendor.value,date:new Date().toLocaleDateString(),items:purchaseDraft};
pur.total=pur.items.reduce((s,i)=>s+i.qty*i.cost,0);
pur.items.forEach(i=>{
let p=DB.products.find(x=>x.id===i.productId);
p.stock+=i.qty;
});
DB.purchases.push(pur);
purchaseDraft=[];
saveDB(); renderPurchase(); alert("Purchase saved");
}

function deletePurchase(id){
if(confirm("Delete purchase?")){
let p=DB.purchases.find(x=>x.id===id);
p.items.forEach(i=>{
let pr=DB.products.find(x=>x.id===i.productId);
pr.stock-=i.qty;
});
DB.purchases=DB.purchases.filter(x=>x.id!==id);
saveDB(); renderPurchase();
}
}

/* ✅ NEW – PURCHASE EDIT */
function editPurchase(id){
let p=DB.purchases.find(x=>x.id===id);
if(!p)return;

purchaseDraft=[];

/* rollback stock */
p.items.forEach(i=>{
let pr=DB.products.find(x=>x.id===i.productId);
if(pr)pr.stock-=i.qty;
});

/* restore items */
p.items.forEach(i=>{
purchaseDraft.push({
productId:i.productId,
qty:i.qty,
cost:i.cost
});
});

/* restore vendor */
purchaseVendor.value=p.vendorId;

/* remove old purchase */
DB.purchases=DB.purchases.filter(x=>x.id!==id);

saveDB();
renderPurchase();
alert("Purchase loaded for editing");
}

function uploadPurchaseExcel(input){
const reader=new FileReader();
reader.onload=e=>{
const wb=XLSX.read(e.target.result,{type:"binary"});
const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
rows.forEach(r=>{
let p=DB.products.find(x=>x.itemNo==r["Item No"]);
if(!p)return;
purchaseDraft.push({productId:p.id,qty:+r.Qty,cost:+r.Cost});
});
renderPurchase();
};
reader.readAsBinaryString(input.files[0]);
}
<script>
function openTab(id){
document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
document.querySelectorAll("nav div").forEach(d=>d.classList.remove("active"));
document.getElementById(id).classList.add("active");
document.getElementById("tab-"+id).classList.add("active");
if(id==="products")renderProducts();
if(id==="vendors")renderVendors();
if(id==="purchase"){loadPurchaseDropdowns();renderPurchase();}
}
openTab("products");
</script>

<!-- ================= INVOICE ================= -->
<section id="invoice">
<div class="card">
<h2>Invoice</h2>

<div style="display:flex;gap:8px;margin-bottom:10px;">
<input id="invBarcode" placeholder="Barcode" oninput="invoiceSearch()">
<input id="invItem" placeholder="Item No" oninput="invoiceSearch()">
<input id="invDesc" placeholder="Description" oninput="invoiceSearch()">
</div>

<table>
<thead>
<tr><th>Item</th><th>Qty</th><th>Rate</th><th>Discount</th><th>Total</th><th></th></tr>
</thead>
<tbody id="invoiceRows"></tbody>
</table>

<h3>Total: <span id="invoiceTotal">0</span></h3>
<button onclick="saveInvoice()">Save Invoice</button>

<h3>Previous Invoices</h3>
<table>
<thead><tr><th>ID</th><th>Date</th><th>Total</th><th>Actions</th></tr></thead>
<tbody id="oldInvoices"></tbody>
</table>
</div>
</section>

<script>
let invoiceDraft=[];

/* SAME SEARCH CODE */

function editInvoice(id){
let i=DB.invoices.find(x=>x.id===id);

/* ✅ FIX – restore stock first */
i.items.forEach(it=>{
let p=DB.products.find(x=>x.id===it.productId);
if(p)p.stock+=it.qty;
});

invoiceDraft=JSON.parse(JSON.stringify(i.items));
calcInvoice();
}
</script>

<!-- CASH / REPORTS / SETTINGS – UNCHANGED -->

<script>
renderInvoices();
renderCash();
</script>

</body>
  </html>
