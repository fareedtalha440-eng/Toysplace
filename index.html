<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dani Test Software</title>

<!-- ====== XLSX LIBRARY ====== -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
:root{
  --primary:#0b1c2d;     /* Deep Dark Blue */
  --secondary:#ffffff;  /* White */
  --accent:#1f6feb;
  --border:#d0d7de;
}

/* ===== BODY ===== */
body{
  margin:0;
  font-family:Segoe UI, Arial;
  background:white;
  color:#0b1c2d;
}

/* ===== HEADER ===== */
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:var(--primary);
  color:white;
  padding:14px 22px;
  font-size:22px;
  font-weight:600;
}

#header-left{
  display:flex;
  align-items:center;
  gap:12px;
}

#header-logo{
  height:36px;
  width:auto;
  display:none;
}

#dateTime{
  font-size:14px;
  opacity:0.85;
}

/* ===== NAV ===== */
nav{
  display:flex;
  background:#f6f8fa;
  border-bottom:1px solid var(--border);
}

nav div{
  padding:14px 20px;
  cursor:pointer;
  transition:0.25s;
  border-bottom:3px solid transparent;
  font-weight:500;
}

nav div:hover{
  background:#eef2f7;
}

nav div.active{
  border-bottom:3px solid var(--accent);
  color:var(--accent);
  font-weight:600;
  transform:translateY(-1px);
}

/* ===== SECTION ===== */
section{
  display:none;
  padding:20px;
}

section.active{
  display:block;
  animation:fadeIn 0.25s ease-in;
}

@keyframes fadeIn{
  from{opacity:0; transform:translateY(4px);}
  to{opacity:1; transform:none;}
}

/* ===== CARD ===== */
.card{
  background:white;
  border:1px solid var(--border);
  padding:18px;
  margin-bottom:20px;
  border-radius:10px;
}

/* ===== TABLE ===== */
table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  border:1px solid var(--border);
  padding:8px;
  text-align:center;
}

th{
  background:#f6f8fa;
  font-weight:600;
}

/* ===== INPUT ===== */
input,select{
  padding:7px;
  border-radius:6px;
  border:1px solid var(--border);
  width:100%;
}

button{
  padding:8px 14px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:600;
}

.green{background:#2da44e;color:white;}
.red{background:#cf222e;color:white;}
.blue{background:var(--accent);color:white;}
</style>
</head>
<body>

<header>
  <div id="header-left">
    <img id="header-logo">
    <span id="softwareName">Dani Test Software</span>
  </div>
  <div id="dateTime"></div>
</header>

<nav id="menu">
  <div onclick="openTab('invoice')" id="tab-invoice">Invoice</div>
  <div onclick="openTab('cash')" id="tab-cash">Cash In Hand</div>
  <div onclick="openTab('purchase')" id="tab-purchase">Purchase</div>
  <div onclick="openTab('products')" id="tab-products">Products</div>
  <div onclick="openTab('vendors')" id="tab-vendors">Vendor</div>
  <div onclick="openTab('reports')" id="tab-reports">Reports</div>
  <div onclick="openTab('settings')" id="tab-settings">Settings</div>
</nav>

<!-- ================= DATABASE ================= -->
<script>
const DB = {
  products: JSON.parse(localStorage.getItem("products")||"[]"),
  vendors: JSON.parse(localStorage.getItem("vendors")||"[]"),
  purchases: JSON.parse(localStorage.getItem("purchases")||"[]"),
  invoices: JSON.parse(localStorage.getItem("invoices")||"[]"),
  cash: JSON.parse(localStorage.getItem("cash")||"[]"),
  deleted: JSON.parse(localStorage.getItem("deleted")||"[]")
};

function saveDB() { 
  for(let k in DB){ 
    localStorage.setItem(k, JSON.stringify(DB[k])); 
  } 
}

function uid(prefix){ 
  return prefix + "_" + Date.now() + Math.floor(Math.random()*1000); 
}
</script>

<!-- ================= INVOICE ================= -->
<section id="invoice">
  <div class="card" id="newInvoiceCard">
    <h2>New Invoice</h2>

    <!-- SEARCH -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px;">
      <input id="inv_s_barcode" placeholder="Search Barcode" oninput="searchInvoiceInput('barcode', this.value)">
      <input id="inv_s_item" placeholder="Search Item No" oninput="searchInvoiceInput('itemNo', this.value)">
      <input id="inv_s_desc" placeholder="Search Description" oninput="searchInvoiceInput('desc', this.value)">
    </div>

    <button onclick="addInvoiceRow()">New Item</button>

    <table>
      <thead>
        <tr>
          <th>Barcode</th>
          <th>Item No</th>
          <th>Description</th>
          <th>Qty</th>
          <th>Rate</th>
          <th>Disc Amt</th>
          <th>Disc %</th>
          <th>Total</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="invoiceRows"></tbody>
    </table>

    <h3>Total: ₨ <span id="invTotal">0</span></h3>
    <label>Main Discount Amount: <input id="mainDiscAmt" type="number" value="0" onchange="syncMainDiscAmt()"></label>
    <label>Main Discount %: <input id="mainDiscPct" type="number" value="0" onchange="syncMainDiscPct()"></label>
    <button onclick="saveInvoice()">Save Invoice</button>
  </div>

  <div class="card">
    <h2>Invoice List</h2>
    <label>Date Filter: <input type="date" id="invDateFilter" onchange="applyInvoiceFilter()"></label>
    <table>
      <thead><tr><th>#</th><th>Date</th><th>Total</th><th>Edit</th><th>Delete</th></tr></thead>
      <tbody id="invoiceList"></tbody>
    </table>
    <button onclick="prevInvPage()">Prev</button>
    <button onclick="nextInvPage()">Next</button>
  </div>
</section>

<script>
// ===== INVOICE =====
let invoiceDraft=[];
let invPage=1, invPerPage=100;
let invFiltered=DB.invoices;
let editingInvoiceId=null;

function addInvoiceRow(){
  invoiceDraft.push({productId:"", qty:1, rate:0, discAmt:0, discPct:0});
  renderInvoice();
}

function renderInvoice(){
  const tbody=document.getElementById("invoiceRows");
  tbody.innerHTML="";
  let subtotal=0;

  invoiceDraft.forEach((r,i)=>{
    const p=DB.products.find(x=>x.id===r.productId)||{};
    const gross=r.qty*r.rate;
    const disc=r.discAmt || (gross*r.discPct/100);
    const total=gross-disc;
    subtotal+=total;

    tbody.innerHTML+=`
    <tr>
      <td><input placeholder="Barcode" value="${p.barcode||''}" oninput="searchInv(${i}, this.value, 'barcode')"></td>
      <td><input placeholder="Item No" value="${p.itemNo||''}" oninput="searchInv(${i}, this.value, 'itemNo')"></td>
      <td><input placeholder="Description" value="${p.desc||''}" oninput="searchInv(${i}, this.value, 'desc')"></td>

      <td><input type="number" value="${r.qty}" min="1" onchange="setInvQty(${i},this.value)"></td>
      <td><input type="number" value="${r.rate}" onchange="setInvRate(${i},this.value)"></td>
      <td><input type="number" value="${r.discAmt}" onchange="setInvDiscAmt(${i},this.value)"></td>
      <td><input type="number" value="${r.discPct}" onchange="setInvDiscPct(${i},this.value)"></td>

      <td>${total.toFixed(2)}</td>
      <td><button class="red" onclick="delInvRow(${i})">X</button></td>
    </tr>`;
  });

  applyMainDiscount(subtotal);
}

// ===== SEARCH PRODUCT =====
function searchInv(i,val,field){
  const p=DB.products.find(x=>
    x.stock>0 && (
      (field==="barcode" && x.barcode?.toLowerCase().includes(val.toLowerCase())) ||
      (field==="itemNo" && x.itemNo?.toLowerCase().includes(val.toLowerCase())) ||
      (field==="desc" && x.desc?.toLowerCase().includes(val.toLowerCase()))
    )
  );
  if(p){
    invoiceDraft[i].productId=p.id;
    invoiceDraft[i].rate=p.rate;
    renderInvoice();
  }
}

// ===== INPUT SEARCH HANDLER =====
function searchInvoiceInput(type, val){
  const searchVal=val.toLowerCase();
  const filtered=DB.products.filter(p=>
    (type==="barcode"? p.barcode : type==="itemNo"? p.itemNo : p.desc).toLowerCase().includes(searchVal)
  );
  invFiltered=filtered;
}

// ===== SETTERS =====
function setInvQty(i,v){invoiceDraft[i].qty=+v;renderInvoice();}
function setInvRate(i,v){invoiceDraft[i].rate=+v;renderInvoice();}
function setInvDiscAmt(i,v){invoiceDraft[i].discAmt=+v; const gross=invoiceDraft[i].qty*invoiceDraft[i].rate; invoiceDraft[i].discPct=gross?((v/gross)*100):0; renderInvoice();}
function setInvDiscPct(i,v){invoiceDraft[i].discPct=+v; const gross=invoiceDraft[i].qty*invoiceDraft[i].rate; invoiceDraft[i].discAmt=(gross*invoiceDraft[i].discPct/100); renderInvoice();}
function delInvRow(i){invoiceDraft.splice(i,1); renderInvoice();}

// ===== MAIN DISCOUNT =====
function syncMainDiscAmt(){
  const amt=+document.getElementById("mainDiscAmt").value;
  const sub=getSubTotal();
  document.getElementById("mainDiscPct").value = sub ? ((amt/sub)*100).toFixed(2) : 0;
  applyMainDiscount(sub);
}

function syncMainDiscPct(){
  const pct=+document.getElementById("mainDiscPct").value;
  const sub=getSubTotal();
  document.getElementById("mainDiscAmt").value = (sub*pct/100).toFixed(2);
  applyMainDiscount(sub);
}

function getSubTotal(){return invoiceDraft.reduce((s,r)=>{const g=r.qty*r.rate; return s+(g-(r.discAmt||g*r.discPct/100));},0);}
function applyMainDiscount(sub){const disc=+document.getElementById("mainDiscAmt").value||0; document.getElementById("invTotal").innerText=(sub-disc).toFixed(2);}

// ===== SAVE INVOICE =====
function saveInvoice(){
  if(!invoiceDraft.length) return alert("Empty invoice");

  if(editingInvoiceId){
    const old=DB.invoices.find(i=>i.id===editingInvoiceId);
    old.items.forEach(r=>{
      const p=DB.products.find(x=>x.id===r.productId);
      if(p) p.stock+=r.qty;
    });
    DB.cash=DB.cash.filter(c=>c.ref!==editingInvoiceId);
  }

  invoiceDraft.forEach(r=>{
    const p=DB.products.find(x=>x.id===r.productId);
    if(p) p.stock-=r.qty;
  });

  const total=+document.getElementById("invTotal").innerText;
  const invId=editingInvoiceId||uid("INV");

  DB.invoices=DB.invoices.filter(i=>i.id!==invId);
  DB.invoices.push({id:invId,date:new Date().toISOString().slice(0,10),items:JSON.parse(JSON.stringify(invoiceDraft)),total});

  DB.cash.push({id:uid("CASH"),type:"IN",amount:total,ref:invId,date:new Date().toISOString().slice(0,10)});
  saveDB();
  invoiceDraft=[]; editingInvoiceId=null;
  document.getElementById("mainDiscAmt").value=document.getElementById("mainDiscPct").value=0;
  renderInvoice();
  renderInvoiceList();
  alert("Invoice saved");
}

// ===== INVOICE LIST =====
function renderInvoiceList(){
  const tbody=document.getElementById("invoiceList");
  tbody.innerHTML="";
  const start=(invPage-1)*invPerPage;
  invFiltered.slice(start,start+invPerPage).forEach((i,idx)=>{
    tbody.innerHTML+=`
      <tr>
        <td>${start+idx+1}</td>
        <td>${i.date}</td>
        <td>${i.total.toFixed(2)}</td>
        <td><button onclick="editInvoice('${i.id}')">Edit</button></td>
        <td><button class="red" onclick="deleteInvoice('${i.id}')">Delete</button></td>
      </tr>`;
  });
}

function editInvoice(id){
  const inv=DB.invoices.find(i=>i.id===id);
  editingInvoiceId=id;
  invoiceDraft=JSON.parse(JSON.stringify(inv.items));
  document.getElementById("newInvoiceCard").scrollIntoView();
  renderInvoice();
}

function deleteInvoice(id){
  if(!confirm("Delete invoice?")) return;
  const inv=DB.invoices.find(i=>i.id===id);
  inv.items.forEach(r=>{
    const p=DB.products.find(x=>x.id===r.productId);
    if(p) p.stock+=r.qty;
  });
  DB.cash=DB.cash.filter(c=>c.ref!==id);
  DB.deleted.push({type:"INVOICE",data:inv});
  DB.invoices=DB.invoices.filter(i=>i.id!==id);
  saveDB();
  renderInvoiceList();
}

// ===== FILTER =====
function applyInvoiceFilter(){
  const d=document.getElementById("invDateFilter").value;
  invFiltered=d?DB.invoices.filter(i=>i.date===d):DB.invoices;
  document.getElementById("newInvoiceCard").style.display=d?"none":"block";
  invPage=1;
  renderInvoiceList();
}

function nextInvPage(){invPage++;renderInvoiceList();}
function prevInvPage(){if(invPage>1){invPage--;renderInvoiceList();}}
renderInvoiceList();
</script>

<!-- ================= CASH ================= -->
<section id="cash">
  <div class="card">
    <h2>Cash In Hand</h2>
    <h3>Balance: <span id="cashBal">0</span></h3>
    <label>From</label><input type="date" id="cashFrom">
    <label>To</label><input type="date" id="cashTo">
    <button onclick="renderCash()">Filter</button>
    <table>
      <thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Ref</th><th>Balance</th></tr></thead>
      <tbody id="cashRows"></tbody>
    </table>
  </div>
</section>

<script>
function cashBalance(){ return DB.cash.reduce((s,t)=>t.type==="IN"?s+t.amount:s-t.amount,0);}
function renderCash(){
  const tbody=document.getElementById("cashRows"); tbody.innerHTML="";
  const from=document.getElementById("cashFrom").value;
  const to=document.getElementById("cashTo").value;
  let bal=0;
  DB.cash.forEach(c=>{
    if((from && c.date<from) || (to && c.date>to)) return;
    bal=c.type==="IN"? bal+c.amount: bal-c.amount;
    tbody.innerHTML+=`<tr><td>${c.date}</td><td>${c.type}</td><td>${c.amount.toFixed(2)}</td><td>${c.ref}</td><td>${bal.toFixed(2)}</td></tr>`;
  });
  document.getElementById("cashBal").innerText=bal.toFixed(2);
}
</script>

<!-- ================= PRODUCTS ================= -->
<section id="products">
  <div class="card">
    <h2>Products</h2>
    <input type="file" accept=".xlsx,.xls" onchange="uploadProductExcel(this)">
    <button onclick="exportProductsCSV()">Download CSV</button>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px;">
      <input placeholder="Search Barcode" oninput="searchProducts()" id="s_barcode">
      <input placeholder="Search Item No" oninput="searchProducts()" id="s_item">
      <input placeholder="Search Description" oninput="searchProducts()" id="s_desc">
    </div>
  </div>
  <div class="card">
    <table>
      <thead><tr><th>#</th><th>Barcode</th><th>Item No</th><th>Description</th><th>Rate</th><th>Stock</th></tr></thead>
      <tbody id="productRows"></tbody>
    </table>
    <button onclick="prevPage()">Prev</button>
    <button onclick="nextPage()">Next</button>
  </div>
</section>

<script>
let prodPage=1, prodPerPage=100;
let prodFiltered=DB.products;

function renderProducts(){
  const tbody=document.getElementById("productRows"); tbody.innerHTML="";
  const start=(prodPage-1)*prodPerPage;
  prodFiltered.slice(start,start+prodPerPage).forEach((p,idx)=>{
    tbody.innerHTML+=`<tr>
      <td>${start+idx+1}</td>
      <td>${p.barcode}</td>
      <td>${p.itemNo}</td>
      <td>${p.desc}</td>
      <td>${p.rate}</td>
      <td>${p.stock}</td>
    </tr>`;
  });
}

function searchProducts(){
  const b=document.getElementById("s_barcode").value.toLowerCase();
  const i=document.getElementById("s_item").value.toLowerCase();
  const d=document.getElementById("s_desc").value.toLowerCase();
  prodFiltered=DB.products.filter(p=>
    p.barcode.toLowerCase().includes(b) &&
    p.itemNo.toLowerCase().includes(i) &&
    p.desc.toLowerCase().includes(d)
  );
  prodPage=1;
  renderProducts();
}

function nextPage(){prodPage++;renderProducts();}
function prevPage(){if(prodPage>1){prodPage--;renderProducts();}}
renderProducts();

// ===== UPLOAD XLSX =====
function uploadProductExcel(input){
  const file=input.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    const data=new Uint8Array(e.target.result);
    const wb=XLSX.read(data,{type:"array"});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const arr=XLSX.utils.sheet_to_json(ws);
    arr.forEach(r=>{
      DB.products.push({id:uid("P"),barcode:r.Barcode,itemNo:r.ItemNo,desc:r.Description,rate:+r.Rate||0,stock:+r.Stock||0});
    });
    saveDB();
    renderProducts();
  };
  reader.readAsArrayBuffer(file);
}

// ===== EXPORT =====
function exportProductsCSV(){
  let csv="Barcode,Item No,Description,Rate,Stock\n";
  DB.products.forEach(p=>csv+=`${p.barcode},${p.itemNo},${p.desc},${p.rate},${p.stock}\n`);
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="products.csv"; a.click();
}
</script>

<!-- ================= VENDORS ================= -->
<section id="vendors">
  <div class="card">
    <h2>Vendors</h2>
    <input placeholder="Vendor Name" id="vendorName">
    <button onclick="addVendor()">Add Vendor</button>
  </div>
  <div class="card">
    <table>
      <thead><tr><th>#</th><th>Name</th></tr></thead>
      <tbody id="vendorRows"></tbody>
    </table>
  </div>
</section>

<script>
function renderVendors(){
  const tbody=document.getElementById("vendorRows"); 
  tbody.innerHTML="";
  DB.vendors.forEach((v,idx)=>{
    // calculate balance for this vendor
    const vendorBalance = DB.purchases
      .filter(p => p.vendorId === v.id)
      .reduce((s, p) => s + p.total, 0) 
      - (DB.cash.filter(c => c.vendorId === v.id && c.type === "OUT")
               .reduce((s,c)=>s+c.amount,0));
    
    tbody.innerHTML+=`
      <tr>
        <td>${idx+1}</td>
        <td>
          <span onclick="showVendorLedger('${v.id}')" style="cursor:pointer; text-decoration:underline;">${v.name}</span>
          <br>
          <small>Balance: ₨ ${vendorBalance.toFixed(2)}</small>
        </td>
        <td>
          <button onclick="editVendor('${v.id}')">Edit</button>
          <button onclick="deleteVendor('${v.id}')">Delete</button>
        </td>
      </tr>
    `;
  });
}
function editVendor(vendorId){
  const vendor = DB.vendors.find(v => v.id === vendorId);
  const newName = prompt("Edit vendor name:", vendor.name);
  if(newName && newName.trim() !== ""){
    vendor.name = newName.trim();
    saveDB();
    renderVendors();
  }
}
function deleteVendor(vendorId){
  const vendor = DB.vendors.find(v => v.id === vendorId);

  // calculate balance for this vendor
  const balance = DB.purchases
    .filter(p => p.vendorId === vendorId)
    .reduce((s, p) => s + p.total, 0) 
    - (DB.cash.filter(c => c.vendorId === vendorId && c.type === "OUT")
             .reduce((s,c)=>s+c.amount,0));

  if(balance !== 0){
    return alert("Cannot delete vendor! Balance is not zero.");
  }

  if(confirm("Are you sure you want to delete this vendor?")){
    DB.vendors = DB.vendors.filter(v => v.id !== vendorId);
    saveDB();
    renderVendors();
  }
}
function showVendorLedger(vendorId){
  const vendor = DB.vendors.find(v=>v.id===vendorId);
  const ledgerWindow = window.open("", "_blank", "width=600,height=600");
  ledgerWindow.document.write(`<h2>Ledger for ${vendor.name}</h2>`);

  let balance = 0;
  ledgerWindow.document.write(`<table border="1" style="width:100%;border-collapse:collapse;">
    <tr><th>Date</th><th>Type</th><th>Amount</th><th>Balance</th></tr>`);

  // Get all related purchases
  const entries = [];
  DB.purchases.filter(p=>p.vendorId===vendorId).forEach(p=>{
    entries.push({date:p.date, type:"Purchase", amount:p.total});
  });
  DB.cash.filter(c=>c.vendorId===vendorId && c.type==="OUT").forEach(c=>{
    entries.push({date:c.date, type:"Payment", amount:c.amount});
  });

  // Sort by date
  entries.sort((a,b)=> new Date(a.date) - new Date(b.date));

  entries.forEach(e=>{
    balance += e.type==="Purchase"? e.amount : -e.amount;
    ledgerWindow.document.write(`<tr>
      <td>${e.date}</td>
      <td>${e.type}</td>
      <td>${e.amount.toFixed(2)}</td>
      <td>${balance.toFixed(2)}</td>
    </tr>`);
  });

  ledgerWindow.document.write(`</table>
    <h3>Total Balance: ₨ ${balance.toFixed(2)}</h3>`);
}
DB.cash.push({
  id: uid("CASH"),
  type: "OUT",
  amount: paymentAmount,
  vendorId: vendorId,
  ref: paymentRef,
  date: new Date().toISOString().slice(0,10)
});

function addVendor(){
  const name=document.getElementById("vendorName").value.trim();
  if(!name) return alert("Enter vendor name");
  DB.vendors.push({id:uid("V"),name});
  saveDB();
  document.getElementById("vendorName").value="";
  renderVendors();
}
renderVendors();
</script>

<!-- ================= PURCHASE ================= -->
<section id="purchase">
  <div class="card">
    <h2>New Purchase</h2>
    <select id="purchaseVendor">
      <option value="">Select Vendor</option>
    </select>
    <button onclick="addPurchaseRow()">Add Item</button>
    <table>
      <thead><tr><th>Product</th><th>Qty</th><th>Rate</th><th>Total</th><th></th></tr></thead>
      <tbody id="purchaseRows"></tbody>
    </table>
    <h3>Total: ₨ <span id="purchaseTotal">0</span></h3>
    <button onclick="savePurchase()">Save Purchase</button>
  </div>
</section>

<script>
let purchaseDraft=[];
function populatePurchaseVendors(){
  const sel=document.getElementById("purchaseVendor");
  sel.innerHTML=`<option value="">Select Vendor</option>`;
  DB.vendors.forEach(v=>sel.innerHTML+=`<option value="${v.id}">${v.name}</option>`);
}
populatePurchaseVendors();

function addPurchaseRow(){
  purchaseDraft.push({productId:"",qty:1,rate:0});
  renderPurchase();
}

function renderPurchase(){
  const tbody=document.getElementById("purchaseRows"); tbody.innerHTML="";
  let total=0;
  purchaseDraft.forEach((r,i)=>{
    const p=DB.products.find(x=>x.id===r.productId)||{};
    const rowTotal=r.qty*r.rate; total+=rowTotal;
    tbody.innerHTML+=`<tr>
      <td>
        <select onchange="setPurchaseProduct(${i}, this.value)">
          <option value="">Select Product</option>
          ${DB.products.map(x=>`<option value="${x.id}" ${x.id===r.productId?'selected':''}>${x.itemNo} - ${x.desc}</option>`).join("")}
        </select>
      </td>
      <td><input type="number" value="${r.qty}" min="1" onchange="setPurchaseQty(${i},this.value)"></td>
      <td><input type="number" value="${r.rate}" onchange="setPurchaseRate(${i},this.value)"></td>
      <td>${rowTotal.toFixed(2)}</td>
      <td><button class="red" onclick="delPurchaseRow(${i})">X</button></td>
    </tr>`;
  });
  document.getElementById("purchaseTotal").innerText=total.toFixed(2);
}

function setPurchaseProduct(i,v){purchaseDraft[i].productId=v; renderPurchase();}
function setPurchaseQty(i,v){purchaseDraft[i].qty=+v; renderPurchase();}
function setPurchaseRate(i,v){purchaseDraft[i].rate=+v; renderPurchase();}
function delPurchaseRow(i){purchaseDraft.splice(i,1); renderPurchase();}

function savePurchase(){
  const vendorId=document.getElementById("purchaseVendor").value;
  if(!vendorId) return alert("Select vendor");
  purchaseDraft.forEach(r=>{
    const p=DB.products.find(x=>x.id===r.productId);
    if(p) p.stock+=r.qty;
  });
  const total=+document.getElementById("purchaseTotal").innerText;
  DB.purchases.push({id:uid("PUR"),vendorId,date:new Date().toISOString().slice(0,10),items:JSON.parse(JSON.stringify(purchaseDraft)),total});
  saveDB();
  purchaseDraft=[];
  renderPurchase();
  alert("Purchase saved");
}
</script>

<!-- ================= REPORTS ================= -->
<section id="reports">
  <div class="card">
    <h2>Reports</h2>
    <button onclick="generateReport()">Generate</button>
    <pre id="reportOutput"></pre>
  </div>
</section>

<script>
function generateReport(){ document.getElementById("reportOutput").innerText=JSON.stringify(DB,null,2);}
</script>

<!-- ================= SETTINGS ================= -->
<section id="settings">
  <div class="card">
    <h2>Settings</h2>
    <p>Placeholder for settings</p>
  </div>
</section>

<script>
// ===== MENU =====
function openTab(id){
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  document.querySelectorAll("nav div").forEach(d=>d.classList.remove("active"));
  document.getElementById("tab-"+id).classList.add("active");
}
openTab("invoice");

// ===== DATE & TIME =====
function updateTime(){
  const now=new Date();
  document.getElementById("dateTime").innerText=now.toLocaleString();
}
setInterval(updateTime,1000);
updateTime();
</script>

</body>
</html>
